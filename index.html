<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรับเข้า-ส่งออกสินค้า FG (Google Sheets)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d6efd; /* สีน้ำเงินหลัก */
            --secondary-color: #6c757d; /* สีเทา */
            --success-color: #198754; /* สีเขียว */
            --danger-color: #dc3545; /* สีแดง */
            --warning-color: #ffc107; /* สีเหลือง */
            --bg-color: #f0f2f5; /* สีพื้นหลังเทาอ่อน (แก้ไขแล้ว) */
            --text-color: #212529;
            --border-radius: 12px;
            --header-bg: #e7f1ff; /* สีพื้นหลังหัวข้อฟ้าอ่อน */
        }
        body { 
            background-color: var(--bg-color); 
            color: var(--text-color); 
        }
        body.lang-th { font-family: 'Mitr', sans-serif; }
        body.lang-en { font-family: 'Inter', sans-serif; }

        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .card { border-radius: var(--border-radius); border: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); overflow: hidden; }
        .card-header-custom { background: linear-gradient(135deg, var(--primary-color), #0dcaf0); color: white; border-bottom: none; }
        .card-header { background-color: var(--header-bg); border-bottom: 1px solid #dee2e6; }
        .btn { border-radius: var(--border-radius); padding: 10px 20px; font-weight: 500; transition: transform 0.2s ease, box-shadow 0.2s ease; border: none; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: #0b5ed7; }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: #157347; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #bb2d3b; }
        .btn-warning { background-color: var(--warning-color); color: #000;}
        .btn-warning:hover { background-color: #ffcd39; }
        .btn-outline-danger { color: var(--danger-color); border-color: var(--danger-color); }
        .btn-outline-danger:hover { background-color: var(--danger-color); color: white; }
        .btn-info { background-color: #0dcaf0; }
        .btn-info:hover { background-color: #31d2f2; }
        .form-control, .form-select, .form-check-input { border-radius: var(--border-radius); border: 1px solid #ddd; }
        .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .form-check-input:checked { background-color: var(--primary-color); border-color: var(--primary-color); }
        .nav-pills .nav-link { border-radius: var(--border-radius); color: var(--text-color); }
        .nav-pills .nav-link.active, .nav-pills .show>.nav-link { background-color: var(--primary-color); color: white; }
        .table-hover tbody tr { cursor: pointer; }
        .table-hover tbody tr:hover { background-color: #eef5ff; transform: scale(1.01); transition: all 0.2s ease-in-out; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        thead { background-color: var(--header-bg); }
        #main-dashboard { display: none; }
        .admin-nav { display: none; }
        .history-import { border-left: 5px solid var(--success-color); }
        .history-export { border-left: 5px solid #0dcaf0; }
        .history-adjustment { border-left: 5px solid var(--warning-color); }
        .suggestions-container { z-index: 1050; }
        .suggestions-container a:hover { background-color: var(--primary-color); color: white; }
        .filter-card { overflow: visible; }
        .refresh-note {
            position: fixed;
            bottom: 15px;
            right: 15px;
            padding: 8px 12px;
            background-color: #e7f1ff;
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1100;
            display: flex;
            align-items: center;
            font-size: 0.8rem;
        }
        .small-text { font-size: 0.85rem; color: #6c757d; }
        .announcement-card {
            border-left: 5px solid var(--primary-color);
            background-color: #e7f1ff;
        }
        .announcement-card .card-header {
            background-color: #d0e7ff;
            color: var(--primary-color);
            font-weight: bold;
        }
        .announcement-card .card-body {
            font-size: 0.95rem;
        }
        .announcement-card .card-footer {
            font-size: 0.8rem;
            color: var(--secondary-color);
            background-color: #e7f1ff;
            border-top: 1px solid #c0d8f7;
        }
        #export-lots-container {
            max-height: 250px;
            overflow-y: auto;
        }
    </style>
</head>
<body>

    <!-- Login Page -->
    <div id="login-page" class="container">
        <div class="login-container">
            <div class="col-md-6 col-lg-4">
                <div class="card shadow-lg text-center">
                    <div class="card-header card-header-custom p-3">
                        <h3><i class="bi bi-box-seam-fill me-2"></i><span data-lang-key="login_header">ระบบสต็อกสินค้า</span></h3>
                        <h4 class="fw-normal">ATECH FG</h4>
                    </div>
                    <div class="card-body p-4">
                        <form id="login-form">
                            <div class="mb-3">
                                <label for="username" class="form-label" data-lang-key="username_label">ชื่อผู้ใช้</label>
                                <input type="text" class="form-control" id="username" required autocomplete="off">
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label" data-lang-key="password_label">รหัสผ่าน</label>
                                <input type="password" class="form-control" id="password" required autocomplete="off">
                            </div>
                            <div id="error-message" class="text-danger mb-3 d-none" data-lang-key="login_error">ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง</div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary"><span data-lang-key="login_button">เข้าสู่ระบบ</span> <i class="bi bi-arrow-right-circle-fill"></i></button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="main-dashboard" class="container-fluid p-4">
        <header class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
            <h1 class="h4"><i class="bi bi-box2-heart-fill me-2" style="color: var(--primary-color);"></i>STOCK IN-OUT FG</h1>
            <div class="d-flex align-items-center">
                <!-- Language Switcher -->
                <div class="dropdown me-3">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="language-switcher" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-translate me-1"></i> <span id="language-switcher-label">ภาษา</span>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="language-switcher">
                        <li><a class="dropdown-item" href="#" onclick="setLanguage('th')">ไทย</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setLanguage('en')">English</a></li>
                    </ul>
                </div>
                <span id="user-role" class="badge rounded-pill me-2 fs-6 align-middle"></span>
                <button id="logout-btn" class="btn btn-outline-danger btn-sm"><i class="bi bi-box-arrow-right me-1"></i><span data-lang-key="logout_button">ออกจากระบบ</span></button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <ul class="nav nav-pills nav-fill mb-4" id="pills-tab" role="tablist">
            <li class="nav-item m-1" role="presentation">
                <button class="nav-link active" id="pills-stock-tab" data-bs-toggle="pill" data-bs-target="#pills-stock" type="button" role="tab"><i class="bi bi-house-heart-fill me-2"></i><span data-lang-key="nav_stock">สต็อกคงเหลือ</span></button>
            </li>
            <li class="nav-item m-1" role="presentation">
                <button class="nav-link" id="pills-import-tab" data-bs-toggle="pill" data-bs-target="#pills-import" type="button" role="tab"><i class="bi bi-arrow-down-square-fill me-2"></i><span data-lang-key="nav_import">รับเข้าสินค้า</span></button>
            </li>
            <li class="nav-item m-1" role="presentation">
                <button class="nav-link" id="pills-export-tab" data-bs-toggle="pill" data-bs-target="#pills-export" type="button" role="tab"><i class="bi bi-arrow-up-square-fill me-2"></i><span data-lang-key="nav_export">ส่งออกสินค้า</span></button>
            </li>
            <li class="nav-item m-1" role="presentation">
                <button class="nav-link" id="pills-history-tab" data-bs-toggle="pill" data-bs-target="#pills-history" type="button" role="tab"><i class="bi bi-clock-history me-2"></i><span data-lang-key="nav_history">ประวัติ</span></button>
            </li>
            <li class="nav-item m-1 admin-nav" role="presentation">
                <button class="nav-link" id="pills-products-tab" data-bs-toggle="pill" data-bs-target="#pills-products" type="button" role="tab"><i class="bi bi-box-seam me-2"></i><span data-lang-key="nav_products">จัดการสินค้า</span></button>
            </li>
            <li class="nav-item m-1 admin-nav" role="presentation">
                <button class="nav-link" id="pills-users-tab" data-bs-toggle="pill" data-bs-target="#pills-users" type="button" role="tab"><i class="bi bi-people-fill me-2"></i><span data-lang-key="nav_users">จัดการผู้ใช้</span></button>
            </li>
            <li class="nav-item m-1 admin-nav" role="presentation">
                <button class="nav-link" id="pills-announcements-tab" data-bs-toggle="pill" data-bs-target="#pills-announcements" type="button" role="tab"><i class="bi bi-megaphone-fill me-2"></i><span data-lang-key="nav_announcements">จัดการประกาศ</span></button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="pills-tabContent">
            <!-- Stock Tab -->
            <div class="tab-pane fade show active" id="pills-stock" role="tabpanel">
                <div id="announcements-display-area" class="mb-4"></div>
                <div class="row">
                    <div class="col-lg-3">
                        <div class="card admin-nav mb-4">
                            <div class="card-header fw-bold"><i class="bi bi-cloud-arrow-down-fill me-2"></i><span data-lang-key="backup_title">สำรองข้อมูล</span></div>
                            <div class="card-body">
                                <p class="text-center mb-2" data-lang-key="backup_desc">ดาวน์โหลดข้อมูลต่างๆ เป็นไฟล์ CSV</p>
                                <div class="d-grid gap-2">
                                    <button id="backup-stock-btn" class="btn btn-info btn-sm"><i class="bi bi-archive-fill me-2"></i><span data-lang-key="backup_stock">ข้อมูลสต็อก</span></button>
                                    <button id="backup-products-btn" class="btn btn-info btn-sm"><i class="bi bi-box-seam-fill me-2"></i><span data-lang-key="backup_products">ข้อมูลสินค้า</span></button>
                                    <button id="backup-users-btn" class="btn btn-info btn-sm"><i class="bi bi-person-lines-fill me-2"></i><span data-lang-key="backup_users">ข้อมูลผู้ใช้</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-9" id="stock-content-column">
                        <div class="card mb-4">
                            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-table me-2"></i><span data-lang-key="stock_summary_title">สรุปยอดสต็อกสินค้าคงเหลือ</span></span>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="show-old-stock-filter">
                                    <label class="form-check-label" for="show-old-stock-filter" data-lang-key="stock_show_old_filter">แสดงเฉพาะสต็อกที่ผลิตเกิน 3 เดือน</label>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="input-group mb-3">
                                    <input type="text" id="stock-search-input" class="form-control" data-lang-key-placeholder="stock_search_placeholder" placeholder="ค้นหารหัสสินค้า, ชื่อสินค้า หรือลูกค้า...">
                                    <button class="btn btn-secondary" type="button" id="refresh-stock-summary-btn" title="Refresh Data"><i class="bi bi-arrow-clockwise"></i></button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead id="stock-summary-table-header"></thead>
                                        <tbody id="stock-summary-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other tabs remain structurally the same, but their content will be translated by JS -->
            <div class="tab-pane fade" id="pills-import" role="tabpanel">
                <div class="card">
                    <div class="card-header fw-bold"><i class="bi bi-box-arrow-in-down me-2"></i><span data-lang-key="import_form_title">ฟอร์มรับเข้าสินค้า</span></div>
                    <div class="card-body">
                        <form id="import-form" class="row g-3"></form>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-export" role="tabpanel">
                <div class="card">
                    <div class="card-header fw-bold"><i class="bi bi-box-arrow-up me-2"></i><span data-lang-key="export_form_title">ฟอร์มส่งออกสินค้า</span></div>
                    <div class="card-body">
                        <form id="export-form" class="row g-3"></form>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-history" role="tabpanel">
                <div class="card mb-3 filter-card">
                    <div class="card-body" style="background-color: #fdf2f5;">
                        <form id="history-filter-form" class="row g-3 align-items-end"></form>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-list-ol me-2"></i>
                            <span data-lang-key="history_table_title">ประวัติการทำรายการ</span>
                            <span id="history-total-quantity" class="badge bg-primary ms-2"></span>
                        </div>
                        <button id="backup-history-btn" class="btn btn-info btn-sm admin-nav"><i class="bi bi-download me-1"></i><span data-lang-key="backup_history">ดาวน์โหลดประวัติ (CSV)</span></button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead id="history-table-header"></thead>
                                <tbody id="history-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-products" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header fw-bold"><i class="bi bi-pencil-square me-2"></i><span data-lang-key="product_form_title">ฟอร์มข้อมูลสินค้า</span></div>
                            <div class="card-body">
                                <form id="product-form" class="row g-3"></form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header fw-bold"><i class="bi bi-card-list me-2"></i><span data-lang-key="product_table_title">รายการสินค้าทั้งหมด</span></div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead id="product-management-table-header"></thead>
                                        <tbody id="product-management-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-users" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header fw-bold"><i class="bi bi-person-plus-fill me-2"></i><span data-lang-key="user_form_title">ฟอร์มข้อมูลผู้ใช้</span></div>
                            <div class="card-body">
                                <form id="user-form" class="row g-3"></form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header fw-bold"><i class="bi bi-list-ul me-2"></i><span data-lang-key="user_table_title">รายการผู้ใช้ทั้งหมด</span></div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead id="user-management-table-header"></thead>
                                        <tbody id="user-management-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-announcements" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header fw-bold"><i class="bi bi-megaphone me-2"></i><span data-lang-key="announcement_form_title">สร้าง/แก้ไขประกาศ</span></div>
                            <div class="card-body">
                                <form id="announcement-form" class="row g-3"></form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header fw-bold"><i class="bi bi-card-list me-2"></i><span data-lang-key="announcement_table_title">รายการประกาศทั้งหมด</span></div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead id="announcement-management-table-header"></thead>
                                        <tbody id="announcement-management-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="lotDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: var(--border-radius);">
                <div class="modal-header" style="background-color: #ffe8f0;">
                    <h5 class="modal-title" id="lotDetailModalLabel"><i class="bi bi-card-list me-2"></i><span data-lang-key="lot_modal_title">รายละเอียดล็อตของ</span>: <span id="modal-product-name" class="fw-bold"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table align-middle">
                        <thead id="lot-detail-table-header"></thead>
                        <tbody id="lot-detail-table"></tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background-color: #bbb;" data-lang-key="close_button">ปิด</button>
                </div>
            </div>
        </div>
    </div>
   
    <div class="modal fade" id="editHistoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: var(--border-radius);">
                <div class="modal-header" style="background-color: #fff0f3;">
                    <h5 class="modal-title" id="edit-history-modal-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-history-form"></form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editStockModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: var(--border-radius);">
                <div class="modal-header" style="background-color: #fff0f3;">
                    <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i><span data-lang-key="edit_stock_modal_title">แก้ไขยอดรวมในสต็อก</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-stock-form"></form>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Note -->
    <div class="refresh-note">
        <i class="bi bi-arrow-clockwise fs-5 me-2"></i>
        <div>
            <strong data-lang-key="refresh_title">รีเฟรช (F5)</strong><br>
            <span data-lang-key="refresh_desc">เพื่อข้อมูลล่าสุด</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
    // --- TRANSLATION OBJECT ---
    const translations = {
        th: {
            // General
            username_label: "ชื่อผู้ใช้",
            password_label: "รหัสผ่าน",
            product_id: "รหัสสินค้า",
            product_name: "ชื่อสินค้า",
            customer: "ลูกค้า",
            erp_code: "รหัส ERP",
            quantity: "จำนวน",
            production_date: "วันที่ผลิต",
            remarks: "หมายเหตุ",
            actions: "ดำเนินการ",
            save_button: "บันทึก",
            clear_form_button: "ล้างฟอร์ม",
            close_button: "ปิด",
            search_placeholder: "ค้นหา...",
            ok_button: "ตกลง",
            cancel_button: "ยกเลิก",
            // Login
            login_header: "ระบบสต็อกสินค้า",
            login_button: "เข้าสู่ระบบ",
            login_error: "ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง",
            // Header & Nav
            logout_button: "ออกจากระบบ",
            nav_stock: "สต็อกคงเหลือ",
            nav_import: "รับเข้าสินค้า",
            nav_export: "ส่งออกสินค้า",
            nav_history: "ประวัติ",
            nav_products: "จัดการสินค้า",
            nav_users: "จัดการผู้ใช้",
            nav_announcements: "จัดการประกาศ",
            // Stock Tab
            backup_title: "สำรองข้อมูล",
            backup_desc: "ดาวน์โหลดข้อมูลต่างๆ เป็นไฟล์ CSV",
            backup_stock: "ข้อมูลสต็อก",
            backup_products: "ข้อมูลสินค้า",
            backup_users: "ข้อมูลผู้ใช้",
            stock_summary_title: "สรุปยอดสต็อกสินค้าคงเหลือ",
            stock_show_old_filter: "แสดงเฉพาะสต็อกที่ผลิตเกิน 3 เดือน",
            stock_search_placeholder: "ค้นหารหัสสินค้า, ชื่อสินค้า หรือลูกค้า...",
            stock_table_product: "รหัส/ชื่อสินค้า",
            stock_table_balance: "ยอดคงเหลือทั้งหมด",
            // Import Tab
            import_form_title: "ฟอร์มรับเข้าสินค้า",
            import_add_lot_button: "เพิ่มล็อตวันที่ผลิต",
            import_total_quantity: "ยอดรวมที่จะรับเข้า",
            import_fullbox: "จำนวนเต็มกล่อง",
            import_quantity: "จำนวนที่รับเข้า",
            import_warning: "เช็ควันที่รับเข้าจากชิ้นงานให้ดีก่อนรับเข้า",
            import_save_button: "บันทึกการรับเข้า",
            // Export Tab
            export_form_title: "ฟอร์มส่งออกสินค้า",
            export_total_quantity: "ยอดรวมที่จะส่งออก",
            export_lot_select: "ล็อตวันที่ผลิต",
            export_quantity: "จำนวนที่ส่งออก",
            export_invoice: "เลขที่ Invoice",
            export_warning: "การส่งออกสินค้าควรคำนึงถึงหลัก FIFO (เข้าก่อน-ออกก่อน)",
            export_save_button: "บันทึกการส่งออก",
            // History Tab
            history_filter_from: "จากวันที่",
            history_filter_to: "ถึงวันที่",
            history_filter_type: "ประเภท",
            history_filter_product: "สินค้า",
            history_filter_invoice: "เลขที่ Invoice",
            history_filter_search: "ค้นหา",
            history_filter_clear: "ล้าง",
            history_filter_type_all: "ทั้งหมด",
            history_filter_type_import: "รับเข้า",
            history_filter_type_export: "ส่งออก",
            history_filter_type_adjustment: "ปรับปรุงยอด",
            history_table_title: "ประวัติการทำรายการ",
            backup_history: "ดาวน์โหลดประวัติ (CSV)",
            history_table_type: "ประเภท",
            history_table_invoice_remarks: "Invoice / หมายเหตุ",
            history_table_timestamp: "วันที่ทำรายการ",
            history_table_user: "ผู้ทำรายการ",
            // Product Management
            product_form_title: "ฟอร์มข้อมูลสินค้า",
            product_fullbox_rack: "จำนวนเต็มกล่อง/แร็ค",
            product_unit_price: "ราคาต่อหน่วย",
            product_save_button: "บันทึกข้อมูลสินค้า",
            product_table_title: "รายการสินค้าทั้งหมด",
            product_table_price: "ราคา/หน่วย",
            // User Management
            user_form_title: "ฟอร์มข้อมูลผู้ใช้",
            user_role: "สิทธิ์",
            user_save_button: "บันทึกข้อมูลผู้ใช้",
            user_table_title: "รายการผู้ใช้ทั้งหมด",
            // Announcement Management
            announcement_form_title: "สร้าง/แก้ไขประกาศ",
            announcement_title: "หัวข้อประกาศ",
            announcement_message: "ข้อความประกาศ",
            announcement_show: "แสดงประกาศนี้",
            announcement_save_button: "บันทึกประกาศ",
            announcement_table_title: "รายการประกาศทั้งหมด",
            announcement_table_header_title: "หัวข้อ",
            announcement_table_status: "สถานะ",
            announcement_table_posted_by: "ผู้ประกาศ",
            announcement_table_posted_date: "วันที่ประกาศ",
            // Modals
            lot_modal_title: "รายละเอียดล็อตของ",
            lot_modal_balance: "จำนวนคงเหลือ",
            edit_stock_modal_title: "แก้ไขยอดรวมในสต็อก",
            edit_stock_new_total: "ยอดรวมใหม่",
            edit_stock_note: "การบันทึกจะล้างล็อตเก่าทั้งหมด และสร้างล็อตใหม่ขึ้นมาแทน",
            edit_stock_save_button: "บันทึกยอดใหม่",
            // Refresh Note
            refresh_title: "รีเฟรช (F5)",
            refresh_desc: "เพื่อข้อมูลล่าสุด",
            // SweetAlerts
            loading: "กำลังโหลดข้อมูล...",
            saving: "กำลังบันทึกข้อมูล...",
            please_wait: "กรุณารอสักครู่ค่ะ",
            data_updated: "ข้อมูลอัปเดตแล้ว!",
            load_error_title: "โหลดข้อมูลไม่สำเร็จ!",
            load_error_text: "ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้ ({error}) กรุณาลองรีเฟรชหน้าเว็บใหม่อีกครั้ง",
            save_error_title: "บันทึกข้อมูลไม่สำเร็จ!",
            save_error_text: "เกิดข้อผิดพลาดในการส่งข้อมูลไปบันทึก: {error}",
            session_expired_title: "หมดเวลาใช้งาน",
            session_expired_text: "ไม่มีการใช้งานระบบเกิน 30 นาที กรุณาลงชื่อเข้าใช้ใหม่",
            confirm_delete_title: "แน่ใจว่าจะลบ?",
            confirm_delete_lot_text: "ล็อตทั้งหมดของสินค้า {productId} ที่ผลิตวันที่ {productionDate} จะถูกลบอย่างถาวร!",
            delete_lot_success: "ลบล็อตสินค้าตามวันที่เรียบร้อยแล้วค่ะ",
            delete_lot_error: "ไม่พบล็อตที่ต้องการลบ",
            confirm_delete_product_text: "สินค้า {productId} จะถูกลบออกจากระบบอย่างถาวร",
            delete_product_error: "ยังมีสินค้านี้อยู่ในสต็อกค่ะ",
            delete_product_success: "ลบสินค้าเรียบร้อยแล้ว",
            confirm_delete_user_text: "ผู้ใช้ {username} จะถูกลบออกจากระบบ",
            delete_user_admin_error: "ไม่สามารถลบผู้ใช้ admin หลักได้ค่ะ",
            delete_user_success: "ลบผู้ใช้เรียบร้อยแล้ว",
            confirm_delete_history_title: "ยืนยันการลบประวัติ?",
            delete_history_export_text: "การดำเนินการนี้จะคืนสินค้ากลับเข้าสต็อก และไม่สามารถย้อนกลับได้",
            delete_history_import_text: "การดำเนินการนี้จะหักสินค้าออกจากสต็อก และไม่สามารถย้อนกลับได้",
            delete_history_import_error_no_lot: "ไม่พบสต็อกล็อตเดิมของรายการนี้ ไม่สามารถลบได้",
            delete_history_import_error_not_enough: "สต็อกในล็อตนี้ถูกใช้ไปแล้ว (คงเหลือ {stockQty}) ไม่สามารถหักจำนวน {historyQty} ได้",
            delete_history_success: "ลบประวัติและปรับสต็อกเรียบร้อย",
            confirm_logout_title: "ต้องการออกจากระบบ?",
            // Dynamic texts
            user_role_display: "สิทธิ์: {role}",
            history_total_quantity_display: "ยอดรวม: {total}",
            no_history_found_message: "กรุณาใส่ข้อมูลเพื่อค้นหาประวัติการทำรายการค่ะ",
            no_history_for_filter_message: "ไม่พบข้อมูลตามเงื่อนไขที่กำหนดค่ะ",
            history_type_import: "รับเข้า",
            history_type_export: "ส่งออก",
            history_type_adjustment: "ปรับปรุงยอด",
            announcement_status_active: "ใช้งานอยู่",
            announcement_status_inactive: "ไม่ใช้งาน",
            announcement_posted_by_on: "ประกาศโดย: {user} เมื่อ: {date}",
            announcement_badge: "ประกาศ",
            export_lot_placeholder_select: "-- เลือกล็อตตามวันที่ผลิต --",
            export_lot_placeholder_no_product: "-- กรุณาเลือกสินค้าก่อน --",
            export_lot_placeholder_no_stock: "-- สินค้าหมดสต็อกแล้วจ้า --",
            export_lot_option: "วันที่ผลิต: {date} (เหลือทั้งหมด: {qty})",
            export_quantity_placeholder: "สูงสุด: {qty}",
            product_not_found: "(ไม่มีข้อมูลสินค้า {id})",
            stock_summary_no_results: "ไม่พบสินค้าที่ตรงกับการค้นหาค่ะ",
            stock_summary_no_old_stock: "ไม่พบสต็อกที่เก่ากว่า 3 เดือนค่ะ",
            stock_summary_no_stock: "ยังไม่มีข้อมูลสต็อกเลยจ้า",
            lot_modal_no_data: "ไม่พบข้อมูลล็อตสำหรับสินค้านี้",
            product_management_no_data: "ยังไม่มีข้อมูลสินค้าค่ะ",
            user_management_no_data: "ยังไม่มีข้อมูลผู้ใช้ค่ะ",
            announcement_management_no_data: "ยังไม่มีประกาศค่ะ",
            form_incomplete: "ข้อมูลไม่ครบถ้วน",
            product_name_required: "กรุณาระบุชื่อสินค้า",
            export_data_incomplete: "กรุณาเลือกสินค้า, วันที่ผลิต, และระบุจำนวนที่ต้องการส่งออก",
            export_no_stock_for_date: "ไม่พบสต็อกสำหรับวันที่ผลิตที่เลือก",
            export_not_enough: "มีสินค้าในสต็อกสำหรับวันที่นี้เพียง {qty} ชิ้น",
            product_id_exists: "มีรหัสสินค้านี้ในระบบแล้วค่ะ",
            username_exists: "มีชื่อผู้ใช้นี้ในระบบแล้วค่ะ",
            user_not_found_for_edit: "ไม่พบผู้ใช้ที่ต้องการแก้ไข",
            history_not_found_for_edit: "ไม่พบประวัติที่ต้องการแก้ไข",
            history_edit_no_lot: "ไม่พบสต็อกล็อตเดิมของประวัติรายการนี้",
            history_edit_not_enough: "ไม่สามารถแก้ไขจำนวนได้ สต็อกคงเหลือในล็อตนี้ (รวมที่คืน) มีเพียง {qty} ชิ้น",
            history_edit_import_not_enough: "ไม่สามารถลดจำนวนรับเข้าให้ต่ำกว่า {qty} ได้ เนื่องจากมีสินค้าถูกใช้ไปแล้ว {qty} ชิ้น",
            product_not_found_error: "ไม่พบสินค้า",
            success_title: "เรียบร้อย!",
            import_success: "รับสินค้า {name} เข้ามาแล้วจ้า",
            export_success: "ส่งออกสินค้า {name} เรียบร้อยแล้วค่ะ",
            product_update_success: "อัปเดตข้อมูลสินค้าเรียบร้อย",
            product_add_success: "เพิ่มสินค้าใหม่เรียบร้อย",
            user_add_success: "เพิ่มผู้ใช้ใหม่เรียบร้อย",
            user_update_success: "อัปเดตข้อมูลผู้ใช้เรียบร้อย",
            history_edit_success: "แก้ไขประวัติเรียบร้อย",
            stock_update_success: "ปรับปรุงยอดสต็อกเรียบร้อย",
            announcement_update_success: "อัปเดตประกาศเรียบร้อยแล้ว",
            announcement_add_success: "เพิ่มประกาศใหม่เรียบร้อยแล้ว",
            announcement_status_update_success: "อัปเดตสถานะประกาศเรียบร้อยแล้ว",
            backup_no_data: "ไม่สามารถสำรองข้อมูลที่ว่างเปล่าได้ค่ะ",
            backup_downloading: "กำลังดาวน์โหลดไฟล์ {filename}",
        },
        en: {
            // General
            username_label: "Username",
            password_label: "Password",
            product_id: "Product ID",
            product_name: "Product Name",
            customer: "Customer",
            erp_code: "ERP Code",
            quantity: "Quantity",
            production_date: "Production Date",
            remarks: "Remarks",
            actions: "Actions",
            save_button: "Save",
            clear_form_button: "Clear Form",
            close_button: "Close",
            search_placeholder: "Search...",
            ok_button: "OK",
            cancel_button: "Cancel",
            // Login
            login_header: "Stock System",
            login_button: "Login",
            login_error: "Incorrect username or password.",
            // Header & Nav
            logout_button: "Logout",
            nav_stock: "Stock Balance",
            nav_import: "Import Goods",
            nav_export: "Export Goods",
            nav_history: "History",
            nav_products: "Manage Products",
            nav_users: "Manage Users",
            nav_announcements: "Manage Announcements",
            // Stock Tab
            backup_title: "Backup Data",
            backup_desc: "Download various data as CSV files.",
            backup_stock: "Stock Data",
            backup_products: "Product Data",
            backup_users: "User Data",
            stock_summary_title: "Stock Balance Summary",
            stock_show_old_filter: "Show only stock older than 3 months",
            stock_search_placeholder: "Search Product ID, Name, or Customer...",
            stock_table_product: "Product ID/Name",
            stock_table_balance: "Total Balance",
            // Import Tab
            import_form_title: "Import Goods Form",
            import_add_lot_button: "Add Production Lot",
            import_total_quantity: "Total Import Quantity",
            import_fullbox: "Full Box Qty",
            import_quantity: "Import Quantity",
            import_warning: "Please double-check the production date on the product before importing.",
            import_save_button: "Save Import",
            // Export Tab
            export_form_title: "Export Goods Form",
            export_total_quantity: "Total Export Quantity",
            export_lot_select: "Production Date Lot",
            export_quantity: "Export Quantity",
            export_invoice: "Invoice No.",
            export_warning: "Exports should follow the FIFO (First-In, First-Out) principle.",
            export_save_button: "Save Export",
            // History Tab
            history_filter_from: "From Date",
            history_filter_to: "To Date",
            history_filter_type: "Type",
            history_filter_product: "Product",
            history_filter_invoice: "Invoice No.",
            history_filter_search: "Search",
            history_filter_clear: "Clear",
            history_filter_type_all: "All",
            history_filter_type_import: "Import",
            history_filter_type_export: "Export",
            history_filter_type_adjustment: "Adjustment",
            history_table_title: "Transaction History",
            backup_history: "Download History (CSV)",
            history_table_type: "Type",
            history_table_invoice_remarks: "Invoice / Remarks",
            history_table_timestamp: "Timestamp",
            history_table_user: "User",
            // Product Management
            product_form_title: "Product Information Form",
            product_fullbox_rack: "Full Box/Rack Qty",
            product_unit_price: "Unit Price",
            product_save_button: "Save Product Data",
            product_table_title: "All Products List",
            product_table_price: "Price/Unit",
            // User Management
            user_form_title: "User Information Form",
            user_role: "Role",
            user_save_button: "Save User Data",
            user_table_title: "All Users List",
            // Announcement Management
            announcement_form_title: "Create/Edit Announcement",
            announcement_title: "Title",
            announcement_message: "Message",
            announcement_show: "Show this announcement",
            announcement_save_button: "Save Announcement",
            announcement_table_title: "All Announcements List",
            announcement_table_header_title: "Title",
            announcement_table_status: "Status",
            announcement_table_posted_by: "Posted By",
            announcement_table_posted_date: "Posted Date",
            // Modals
            lot_modal_title: "Lot Details for",
            lot_modal_balance: "Remaining Quantity",
            edit_stock_modal_title: "Edit Total Stock",
            edit_stock_new_total: "New Total Quantity",
            edit_stock_note: "Saving will clear all old lots and create a new one.",
            edit_stock_save_button: "Save New Total",
            // Refresh Note
            refresh_title: "Refresh (F5)",
            refresh_desc: "for the latest data",
            // SweetAlerts
            loading: "Loading data...",
            saving: "Saving data...",
            please_wait: "Please wait",
            data_updated: "Data updated!",
            load_error_title: "Failed to Load Data!",
            load_error_text: "Could not connect to the database ({error}). Please try refreshing the page.",
            save_error_title: "Failed to Save Data!",
            save_error_text: "An error occurred while saving data: {error}",
            session_expired_title: "Session Expired",
            session_expired_text: "You have been inactive for over 30 minutes. Please log in again.",
            confirm_delete_title: "Are you sure?",
            confirm_delete_lot_text: "All lots for product {productId} produced on {productionDate} will be permanently deleted!",
            delete_lot_success: "Lots deleted successfully.",
            delete_lot_error: "Could not find the lots to delete.",
            confirm_delete_product_text: "Product {productId} will be permanently deleted from the system.",
            delete_product_error: "Cannot delete! This product is still in stock.",
            delete_product_success: "Product deleted successfully.",
            confirm_delete_user_text: "User {username} will be removed from the system.",
            delete_user_admin_error: "Cannot delete the main admin user.",
            delete_user_success: "User deleted successfully.",
            confirm_delete_history_title: "Confirm History Deletion?",
            delete_history_export_text: "This action will return the items to stock and cannot be undone.",
            delete_history_import_text: "This action will deduct the items from stock and cannot be undone.",
            delete_history_import_error_no_lot: "Original stock lot not found for this transaction. Cannot delete.",
            delete_history_import_error_not_enough: "Stock from this lot has already been used (Remaining: {stockQty}). Cannot deduct {historyQty}.",
            delete_history_success: "History deleted and stock adjusted successfully.",
            confirm_logout_title: "Do you want to log out?",
            // Dynamic texts
            user_role_display: "Role: {role}",
            history_total_quantity_display: "Total: {total}",
            no_history_found_message: "Please provide filter criteria to search for transaction history.",
            no_history_for_filter_message: "No data found for the specified criteria.",
            history_type_import: "Import",
            history_type_export: "Export",
            history_type_adjustment: "Adjustment",
            announcement_status_active: "Active",
            announcement_status_inactive: "Inactive",
            announcement_posted_by_on: "Posted by: {user} on: {date}",
            announcement_badge: "Announcement",
            export_lot_placeholder_select: "-- Select Production Lot --",
            export_lot_placeholder_no_product: "-- Please select a product first --",
            export_lot_placeholder_no_stock: "-- This product is out of stock --",
            export_lot_option: "Prod. Date: {date} (Available: {qty})",
            export_quantity_placeholder: "Max: {qty}",
            product_not_found: "(Product info not found for {id})",
            stock_summary_no_results: "No products match your search.",
            stock_summary_no_old_stock: "No stock older than 3 months found.",
            stock_summary_no_stock: "No stock data available yet.",
            lot_modal_no_data: "No lot data found for this product.",
            product_management_no_data: "No product data yet.",
            user_management_no_data: "No user data yet.",
            announcement_management_no_data: "No announcements yet.",
            form_incomplete: "Incomplete Information",
            product_name_required: "Please specify the product name.",
            export_data_incomplete: "Please select a product, production date, and specify the export quantity.",
            export_no_stock_for_date: "No stock found for the selected production date.",
            export_not_enough: "Only {qty} units are available in stock for this date.",
            product_id_exists: "This Product ID already exists in the system.",
            username_exists: "This username already exists in the system.",
            user_not_found_for_edit: "Could not find the user to edit.",
            history_not_found_for_edit: "Could not find the history record to edit.",
            history_edit_no_lot: "Original stock lot for this history record not found.",
            history_edit_not_enough: "Cannot edit quantity. Stock available in this lot (including returned items) is only {qty}.",
            history_edit_import_not_enough: "Cannot reduce import quantity below {qty}, as {qty} units have already been used.",
            product_not_found_error: "Product not found",
            success_title: "Success!",
            import_success: "Imported {name} successfully.",
            export_success: "Exported {name} successfully.",
            product_update_success: "Product information updated successfully.",
            product_add_success: "New product added successfully.",
            user_add_success: "New user added successfully.",
            user_update_success: "User information updated successfully.",
            history_edit_success: "History record edited successfully.",
            stock_update_success: "Stock total updated successfully.",
            announcement_update_success: "Announcement updated successfully.",
            announcement_add_success: "New announcement added successfully.",
            announcement_status_update_success: "Announcement status updated successfully.",
            backup_no_data: "Cannot back up empty data.",
            backup_downloading: "Downloading {filename}",
        }
    };

    let currentLanguage = sessionStorage.getItem('currentLanguage') || 'th';

    document.addEventListener('DOMContentLoaded', () => {
        
        // --- GLOBAL FUNCTION FOR LANGUAGE SWITCHING ---
        window.setLanguage = (lang) => {
            currentLanguage = lang;
            sessionStorage.setItem('currentLanguage', lang);
            document.body.className = `lang-${lang}`;

            // Update all static text
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[lang][key]) {
                    el.innerHTML = translations[lang][key];
                }
            });
            
            // Update placeholders
            document.querySelectorAll('[data-lang-key-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-key-placeholder');
                if (translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });

            // Update language switcher label
            document.getElementById('language-switcher-label').innerText = lang === 'th' ? 'ไทย' : 'English';

            // Re-render all dynamic content
            renderAllForms();
            if (currentUser) {
                const userRoleSpan = document.getElementById('user-role');
                const roleText = translations[currentLanguage].user_role_display.replace('{role}', currentUser.role);
                userRoleSpan.innerHTML = `<i class="bi bi-person-check-fill me-1"></i> ${currentUser.username} (${roleText})`;

                populateAll();
            }
        };

        // --- GOOGLE APPS SCRIPT CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbye2XB1x13RiFdahJogpod0h0Oi8b6maahWfkudvwqhX70Q2NJaXoHPqx2EfgaVu9_RDg/exec';

        // --- DATABASE SIMULATION & PERSISTENCE ---
        let db = { users: [], products: [], stock: [], history: [], announcements: [] };
        let dataSyncInterval = null;
        let inactivityTimer = null;
        let editingAnnouncementId = null; 

        // --- INACTIVITY & SYNC FUNCTIONS ---
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(logoutDueToInactivity, 30 * 60 * 1000); // 30 minutes
        }

        function logoutDueToInactivity() {
            stopDataSync();
            Swal.fire({
                title: translations[currentLanguage].session_expired_title,
                text: translations[currentLanguage].session_expired_text,
                icon: 'warning',
                confirmButtonText: translations[currentLanguage].ok_button,
                allowOutsideClick: false,
            }).then(() => {
                showLoginPage();
            });
        }
        
        function setupActivityListeners() {
            const events = ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'];
            events.forEach(event => window.addEventListener(event, resetInactivityTimer, true));
        }

        function clearActivityListeners() {
            const events = ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'];
            events.forEach(event => window.removeEventListener(event, resetInactivityTimer, true));
        }

        function startDataSync() {
            if (dataSyncInterval) clearInterval(dataSyncInterval);
            // Fetch data every 30 seconds for background updates
            dataSyncInterval = setInterval(() => loadDataFromSheet(false), 30000);
        }

        function stopDataSync() {
            if (dataSyncInterval) {
                clearInterval(dataSyncInterval);
                dataSyncInterval = null;
            }
        }

        async function loadDataFromSheet(isInitialLoad = false) {
            if (isInitialLoad) {
                Swal.fire({
                    title: translations[currentLanguage].loading,
                    text: translations[currentLanguage].please_wait,
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading() }
                });
            }

            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) {
                    if (isInitialLoad) throw new Error(`Network response was not ok. Status: ${response.status}`);
                    else { console.error('Background refresh failed.'); return; }
                }
                const newData = await response.json();
                
                // Ensure all data arrays exist
                newData.stock = newData.stock || [];
                newData.products = newData.products || [];
                newData.users = newData.users || [];
                newData.history = newData.history || [];
                newData.announcements = newData.announcements || [];

                // Standardize date formats upon loading
                newData.stock.forEach(item => { item.productionDate = formatDate(item.productionDate); });
                
                // Only update and re-render if data has actually changed
                if (JSON.stringify(db) !== JSON.stringify(newData)) {
                    db = newData;
                    console.log('Data updated from Google Sheet at:', new Date().toLocaleTimeString());
                    if (currentUser) populateAll();
                    
                    if (!isInitialLoad) {
                        const Toast = Swal.mixin({
                            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
                        });
                        Toast.fire({ icon: 'success', title: translations[currentLanguage].data_updated });
                    }
                }
                
                if (isInitialLoad) Swal.close();
            } catch (error) {
                console.error('Error loading data from Google Sheet:', error);
                if (isInitialLoad) showError(translations[currentLanguage].load_error_title, translations[currentLanguage].load_error_text.replace('{error}', error.message));
            }
        }

        async function saveDataToSheet() {
            try {
                const payload = { action: 'saveDb', payload: db };
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("Error Body from Server:", errorBody);
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                console.log('Save successful');
                return true;

            } catch (error) {
                console.error('Error saving data to Google Sheet:', error);
                throw error;
            }
        }
        
        // --- DOM ELEMENTS ---
        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('main-dashboard');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const logoutBtn = document.getElementById('logout-btn');
        const userRoleSpan = document.getElementById('user-role');
        const stockSummaryTable = document.getElementById('stock-summary-table');
        const lotDetailModal = new bootstrap.Modal(document.getElementById('lotDetailModal'));
        const lotDetailTable = document.getElementById('lot-detail-table');
        const modalProductName = document.getElementById('modal-product-name');
        const showOldStockFilter = document.getElementById('show-old-stock-filter');
        const editHistoryModal = new bootstrap.Modal(document.getElementById('editHistoryModal'));
        const editStockModal = new bootstrap.Modal(document.getElementById('editStockModal'));
        const stockSearchInput = document.getElementById('stock-search-input');
        const importFormEl = document.getElementById('import-form');
        const exportFormEl = document.getElementById('export-form');
        const productFormEl = document.getElementById('product-form');
        const userFormEl = document.getElementById('user-form');
        const historyFilterForm = document.getElementById('history-filter-form');
        const editHistoryForm = document.getElementById('edit-history-form');
        const editStockForm = document.getElementById('edit-stock-form');
        const userManagementTable = document.getElementById('user-management-table');
        const productManagementTable = document.getElementById('product-management-table');
        const historyTable = document.getElementById('history-table');
        const announcementFormEl = document.getElementById('announcement-form');
        const announcementManagementTable = document.getElementById('announcement-management-table');
        const announcementsDisplayArea = document.getElementById('announcements-display-area');

        // --- STATE MANAGEMENT ---
        let currentUser = null;
        let editingProductId = null;
        let originalUsernameForEdit = null;

        // --- GLOBAL APP OBJECT ---
        window.app = {
            deleteLotsByDate: (productId, productionDate) => {
                if (currentUser.role !== 'admin') return;
                const confirmText = translations[currentLanguage].confirm_delete_lot_text
                    .replace('{productId}', productId)
                    .replace('{productionDate}', productionDate);

                confirmAction(translations[currentLanguage].confirm_delete_title, confirmText, async () => {
                    const dbBackup = JSON.parse(JSON.stringify(db));
                    
                    const originalStockCount = db.stock.length;
                    db.stock = db.stock.filter(lot => !(
                        String(lot.productId).trim() === String(productId).trim() && 
                        formatDate(lot.productionDate) === productionDate
                    ));

                    if (db.stock.length === originalStockCount) {
                        showError('Error!', translations[currentLanguage].delete_lot_error);
                        return;
                    }

                    lotDetailModal.hide();
                    populateStockSummary();
                    
                    showSuccess(translations[currentLanguage].delete_lot_success);

                    try {
                        await saveDataToSheet();
                    } catch (error) {
                        db = dbBackup;
                        populateStockSummary();
                        showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
                    }
                });
            },
            editProduct: (productId) => {
                if (currentUser.role !== 'admin') return;
                editingProductId = productId;
                const product = db.products.find(p => String(p.id).trim() === String(productId).trim());
                if (product) {
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('product-id').readOnly = true; // Lock Product ID on edit
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-customer').value = product.customer || '';
                    document.getElementById('product-fullBoxQuantity').value = product.fullBoxQuantity;
                    document.getElementById('product-erpCode').value = product.erpCode;
                    document.getElementById('product-unitPrice').value = product.unitPrice;
                }
            },
            deleteProduct: (productId) => {
                if (currentUser.role !== 'admin') return;
                const isProductInStock = db.stock.some(s => String(s.productId).trim() === String(productId).trim() && s.quantity > 0);
                if (isProductInStock) {
                    showError('Cannot Delete!', translations[currentLanguage].delete_product_error);
                    return;
                }
                const confirmText = translations[currentLanguage].confirm_delete_product_text.replace('{productId}', productId);
                confirmAction(translations[currentLanguage].confirm_delete_title, confirmText, async () => {
                    const dbBackup = JSON.parse(JSON.stringify(db));
                    db.products = db.products.filter(p => String(p.id).trim() !== String(productId).trim());
                    populateAll();
                    showSuccess(translations[currentLanguage].delete_product_success);

                    try {
                        await saveDataToSheet();
                    } catch (error) {
                        db = dbBackup;
                        populateAll();
                        showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
                    }
                });
            },
            editUser: (username) => {
                if (currentUser.role !== 'admin') return;
                originalUsernameForEdit = username;
                const user = db.users.find(u => u.username === username);
                if (user) {
                    document.getElementById('user-username').value = user.username;
                    document.getElementById('user-password').value = user.password;
                    document.getElementById('user-role-select').value = user.role;
                }
            },
            deleteUser: (username) => {
                if (currentUser.role !== 'admin') return;
                if (username === 'admin') {
                    showError('Cannot Delete!', translations[currentLanguage].delete_user_admin_error);
                    return;
                }
                const confirmText = translations[currentLanguage].confirm_delete_user_text.replace('{username}', username);
                confirmAction(translations[currentLanguage].confirm_delete_title, confirmText, async () => {
                    const dbBackup = JSON.parse(JSON.stringify(db));
                    db.users = db.users.filter(u => u.username !== username);
                    populateAll();
                    showSuccess(translations[currentLanguage].delete_user_success);
                    
                    try {
                        await saveDataToSheet();
                    } catch (error) {
                        db = dbBackup;
                        populateAll();
                        showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
                    }
                });
            },
            editHistory: (historyId) => {
                if (currentUser.role !== 'admin') return;
                const historyItem = db.history.find(h => h.date === historyId);
                const stockLot = db.stock.find(s => s.lotId === historyItem.lotId);

                if (historyItem && stockLot) {
                    renderEditHistoryForm(historyItem, stockLot);
                    editHistoryModal.show();
                }
            },
            deleteHistory: (historyId) => {
                if (currentUser.role !== 'admin') return;
                
                const historyIndex = db.history.findIndex(h => h.date === historyId);
                if (historyIndex === -1) return;
                const historyItem = db.history[historyIndex];

                const message = historyItem.type === 'export' 
                    ? translations[currentLanguage].delete_history_export_text
                    : translations[currentLanguage].delete_history_import_text;

                confirmAction(translations[currentLanguage].confirm_delete_history_title, message, async () => {
                    const dbBackup = JSON.parse(JSON.stringify(db));
                    
                    const stockLot = db.stock.find(s => s.lotId === historyItem.lotId);

                    if (historyItem.type === 'export') {
                        if (stockLot) {
                            stockLot.quantity += historyItem.quantity;
                        } else {
                            db.stock.push({ lotId: historyItem.lotId, productId: historyItem.productId, quantity: historyItem.quantity, productionDate: 'N/A (Reverted)' });
                        }
                    } else { // import
                        if (!stockLot) { showError('Error!', translations[currentLanguage].delete_history_import_error_no_lot); return; }
                        if (stockLot.quantity < historyItem.quantity) { 
                            const errorText = translations[currentLanguage].delete_history_import_error_not_enough
                                .replace('{stockQty}', stockLot.quantity)
                                .replace('{historyQty}', historyItem.quantity);
                            showError('Cannot Delete!', errorText); 
                            return; 
                        }
                        stockLot.quantity -= historyItem.quantity;
                    }

                    db.history.splice(historyIndex, 1);
                    populateAll();
                    showSuccess(translations[currentLanguage].delete_history_success);

                    try {
                        await saveDataToSheet();
                    } catch (error) {
                        db = dbBackup;
                        populateAll();
                        showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
                    }
                });
            },
            editStockTotal: (productId) => {
                if (currentUser.role !== 'admin') return;
                const product = db.products.find(p => String(p.id).trim() === String(productId).trim());
                if (product) {
                    const totalQuantity = db.stock
                        .filter(s => String(s.productId).trim() === String(productId).trim())
                        .reduce((sum, item) => sum + item.quantity, 0);
                    
                    renderEditStockForm(product, totalQuantity);
                    editStockModal.show();
                }
            },
            showLotDetails: (productId) => {
                modalProductName.textContent = productId;
                populateLotDetailsTable(productId);
                lotDetailModal.show();
            },
            editAnnouncement: (announcementId) => {
                if (currentUser.role !== 'admin') return;
                editingAnnouncementId = announcementId;
                const announcement = db.announcements.find(a => String(a.id) === String(announcementId));
                if (announcement) {
                    renderAnnouncementForm(announcement);
                }
            },
            deleteAnnouncement: (announcementId) => {
                if (currentUser.role !== 'admin') return;
                confirmAction(translations[currentLanguage].confirm_delete_title, 'This announcement will be permanently deleted.', async () => {
                    const dbBackup = JSON.parse(JSON.stringify(db));
                    db.announcements = db.announcements.filter(a => String(a.id) !== String(announcementId));
                    populateAll();
                    showSuccess(translations[currentLanguage].announcement_update_success);
                    
                    try {
                        await saveDataToSheet();
                    } catch (error) {
                        db = dbBackup;
                        populateAll();
                        showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
                    }
                });
            },
            toggleAnnouncementStatus: async (announcementId) => {
                if (currentUser.role !== 'admin') return;
                const announcement = db.announcements.find(a => String(a.id) === String(announcementId));
                if (announcement) {
                    const dbBackup = JSON.parse(JSON.stringify(db));
                    announcement.isActive = !announcement.isActive;
                    populateAll();
                    showSuccess(translations[currentLanguage].announcement_status_update_success);

                    try {
                        await saveDataToSheet();
                    } catch (error) {
                        db = dbBackup;
                        populateAll();
                        showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
                    }
                }
            }
        };

        async function init() {
            setLanguage(currentLanguage); // Set initial language
            await loadDataFromSheet(true); // Initial load with spinner
            checkLoginState();
            addEventListeners();
        }

        function checkLoginState() {
            const user = JSON.parse(sessionStorage.getItem('currentUser'));
            if (user) {
                const userInDb = db.users.find(u => u.username === user.username && u.password === user.password);
                if (userInDb) {
                    currentUser = userInDb;
                    showDashboard();
                } else {
                    showLoginPage();
                }
            } else {
                showLoginPage();
            }
        }

        function addHistory(type, product, quantity, user, lotId = null, invoiceNumber = null, remarks = '') { 
            const historyEntry = { 
                date: new Date().toISOString(), 
                type: type, 
                productId: product.id, 
                productName: product.name, 
                customer: product.customer || '',
                erpCode: product.erpCode || '',
                quantity: quantity, 
                user: user, 
                lotId: lotId, 
                invoiceNumber: invoiceNumber, 
                remarks: remarks 
            };
            db.history.unshift(historyEntry); 
            return historyEntry;
        }

        async function handleImport(e) {
            e.preventDefault();
            
            const productId = document.getElementById('import-product-id').value;
            const productName = document.getElementById('import-product-name').value;
            if (!productName) {
                showError(translations[currentLanguage].form_incomplete, translations[currentLanguage].product_name_required);
                return;
            }
            
            const dbBackup = JSON.parse(JSON.stringify(db));
            const newStockEntries = [];
            const newHistoryEntries = [];

            const lotRows = document.querySelectorAll('#import-lots-container .import-lot-row');
            
            for(const row of lotRows) {
                const quantity = parseInt(row.querySelector('.import-quantity').value);
                const productionDate = row.querySelector('.import-prod-date').value;

                if (quantity > 0 && productionDate) {
                    const newStock = {
                        lotId: (db.stock.length > 0 ? Math.max(...db.stock.map(s => s.lotId)) : 0) + newStockEntries.length + 1,
                        productId: productId,
                        quantity: quantity,
                        productionDate: productionDate
                    };
                    db.stock.push(newStock);
                    newStockEntries.push(newStock);

                    const productForHistory = {
                        id: productId,
                        name: productName,
                        customer: document.getElementById('import-customer').value,
                        erpCode: document.getElementById('import-erp-code').value
                    };
                    const remarks = document.getElementById('import-remarks').value;
                    const newHistory = addHistory('import', productForHistory, newStock.quantity, currentUser.username, newStock.lotId, null, remarks);
                    newHistoryEntries.push(newHistory);
                }
            }

            if (newStockEntries.length === 0) {
                showError(translations[currentLanguage].form_incomplete, "Please add at least one valid lot.");
                return;
            }

            populateAll();
            showSuccess(translations[currentLanguage].import_success.replace('{name}', productName));
            renderImportForm();

            try {
                await saveDataToSheet();
            } catch (error) {
                console.error("Import save failed. Rolling back.");
                db = dbBackup;
                populateAll();
                showError(
                    translations[currentLanguage].save_error_title, 
                    translations[currentLanguage].save_error_text.replace('{error}', error.message)
                );
            }
        }

        async function handleExport(e) {
            e.preventDefault();

            const productId = document.getElementById('export-product-id').value;
            const invoiceNumber = document.getElementById('export-invoice-number').value;
            const remarks = document.getElementById('export-remarks').value;
            
            const lotRows = document.querySelectorAll('#export-lots-container .export-lot-row:has(input[type="checkbox"]:checked)');

            if (!productId || lotRows.length === 0) {
                showError(translations[currentLanguage].form_incomplete, translations[currentLanguage].export_data_incomplete);
                return;
            }

            const dbBackup = JSON.parse(JSON.stringify(db));
            let product = db.products.find(p => String(p.id).trim() === String(productId).trim()) || { id: productId, name: 'N/A' };
            
            for(const row of lotRows) {
                const productionDate = row.dataset.date;
                const quantityToExport = parseInt(row.querySelector('.export-quantity').value);

                if (isNaN(quantityToExport) || quantityToExport <= 0) continue;

                let remainingToExport = quantityToExport;
                const lotsForDate = db.stock
                    .filter(s => String(s.productId).trim() === String(productId).trim() && formatDate(s.productionDate) === productionDate && s.quantity > 0)
                    .sort((a, b) => a.lotId - b.lotId);

                for (const stockLot of lotsForDate) {
                    if (remainingToExport <= 0) break;
                    const quantityFromThisLot = Math.min(remainingToExport, stockLot.quantity);
                    stockLot.quantity -= quantityFromThisLot;
                    addHistory('export', product, quantityFromThisLot, currentUser.username, stockLot.lotId, invoiceNumber, remarks);
                    remainingToExport -= quantityFromThisLot;
                }
            }

            populateAll();
            showSuccess(translations[currentLanguage].export_success.replace('{name}', product.name));
            renderExportForm();

            try {
                await saveDataToSheet();
            } catch (error) {
                console.error("Export save failed. Rolling back.");
                db = dbBackup;
                populateAll();
                showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
            }
        }

        async function handleProductFormSubmit(e) {
            e.preventDefault();
            const dbBackup = JSON.parse(JSON.stringify(db));
            let successMessage = '';
            
            const productData = {
                id: document.getElementById('product-id').value,
                name: document.getElementById('product-name').value,
                customer: document.getElementById('product-customer').value,
                fullBoxQuantity: parseInt(document.getElementById('product-fullBoxQuantity').value),
                erpCode: document.getElementById('product-erpCode').value,
                unitPrice: parseFloat(document.getElementById('product-unitPrice').value)
            };

            if (editingProductId) {
                const productIndex = db.products.findIndex(p => String(p.id).trim() === String(editingProductId).trim());
                if (productIndex > -1) {
                    // Prevent changing the ID, but update other fields
                    db.products[productIndex] = { ...db.products[productIndex], ...productData, id: editingProductId };
                    successMessage = translations[currentLanguage].product_update_success;
                }
            } else {
                if (db.products.some(p => String(p.id).trim() === String(productData.id).trim())) { showError('Duplicate ID!', translations[currentLanguage].product_id_exists); return; }
                db.products.push(productData);
                successMessage = translations[currentLanguage].product_add_success;
            }
            
            clearProductForm();
            populateAll();
            showSuccess(successMessage);

            try {
                await saveDataToSheet();
            } catch (error) {
                db = dbBackup;
                populateAll();
                showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
            }
        }
        
        async function handleUserFormSubmit(e) {
            e.preventDefault();
            const dbBackup = JSON.parse(JSON.stringify(db));
            let successMessage = '';

            const newUsername = document.getElementById('user-username').value;
            const newPassword = document.getElementById('user-password').value;
            const newRole = document.getElementById('user-role-select').value;
            
            if (!originalUsernameForEdit) {
                if (db.users.some(u => u.username === newUsername)) { showError('Duplicate Username!', translations[currentLanguage].username_exists); return; }
                db.users.push({ username: newUsername, password: newPassword, role: newRole });
                successMessage = translations[currentLanguage].user_add_success;
            } else {
                 const userIndex = db.users.findIndex(u => u.username === originalUsernameForEdit);
                if (userIndex === -1) { showError('Error', translations[currentLanguage].user_not_found_for_edit); clearUserForm(); return; }
                const isUsernameTaken = db.users.some(u => u.username === newUsername && u.username !== originalUsernameForEdit);
                if (isUsernameTaken) { showError('Duplicate Username!', translations[currentLanguage].username_exists); return; }

                if (currentUser.username === originalUsernameForEdit) {
                    currentUser.username = newUsername;
                    currentUser.password = newPassword;
                    currentUser.role = newRole;
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
                if (originalUsernameForEdit !== newUsername) {
                    db.history.forEach(record => { if (record.user === originalUsernameForEdit) { record.user = newUsername; } });
                    db.announcements.forEach(ann => { if (ann.postedBy === originalUsernameForEdit) { ann.postedBy = newUsername; } });
                }
                
                const userToUpdate = db.users[userIndex];
                userToUpdate.username = newUsername;
                userToUpdate.password = newPassword;
                userToUpdate.role = newRole;
                successMessage = translations[currentLanguage].user_update_success;
            }
            
            clearUserForm();
            populateAll();
            showSuccess(successMessage);

            try {
                await saveDataToSheet();
                 if (currentUser.username === newUsername) {
                    showDashboard();
                }
            } catch (error) {
                db = dbBackup;
                populateAll();
                showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
            }
        }

        async function handleEditHistorySubmit(e) {
            e.preventDefault();
            const dbBackup = JSON.parse(JSON.stringify(db));

            const historyId = document.getElementById('edit-history-id').value;
            const newQuantity = parseInt(document.getElementById('edit-history-quantity').value);
            const newInvoice = document.getElementById('edit-history-invoice').value;
            const newRemarks = document.getElementById('edit-history-remarks').value;
            const newProdDate = document.getElementById('edit-history-prod-date').value;

            const historyIndex = db.history.findIndex(h => h.date === historyId);
            if (historyIndex === -1) { showError('Error', translations[currentLanguage].history_not_found_for_edit); return; }
            const historyItem = db.history[historyIndex];
            const stockLot = db.stock.find(s => s.lotId === historyItem.lotId);
            if (!stockLot) { showError('Error', translations[currentLanguage].history_edit_no_lot); return; }
            
            let originalLotQuantity = stockLot.quantity;
            if (historyItem.type === 'export') {
                originalLotQuantity += historyItem.quantity;
            } else { 
                originalLotQuantity -= historyItem.quantity;
            }

            if (historyItem.type === 'import') {
                const amountUsed = historyItem.quantity - stockLot.quantity;
                if (newQuantity < amountUsed) {
                    const errorText = translations[currentLanguage].history_edit_import_not_enough.replaceAll('{qty}', amountUsed);
                    showError('Invalid Quantity', errorText);
                    return;
                }
            } else { 
                if (newQuantity > originalLotQuantity) {
                    const errorText = translations[currentLanguage].export_not_enough.replace('{qty}', originalLotQuantity);
                    showError('Not Enough Stock', errorText);
                    return;
                }
            }

            if (historyItem.type === 'export') {
                stockLot.quantity = originalLotQuantity - newQuantity;
            } else { 
                stockLot.quantity = originalLotQuantity + newQuantity;
            }

            stockLot.productionDate = newProdDate;
            historyItem.quantity = newQuantity;
            historyItem.remarks = newRemarks;
            if (historyItem.type === 'export') { historyItem.invoiceNumber = newInvoice; }
            
            populateAll();
            editHistoryModal.hide();
            showSuccess(translations[currentLanguage].history_edit_success);

            try {
                await saveDataToSheet();
            } catch (error) {
                db = dbBackup; 
                populateAll();
                showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
            }
        }

        async function handleEditStockSubmit(e) {
            e.preventDefault();
            const dbBackup = JSON.parse(JSON.stringify(db));

            const productId = document.getElementById('edit-stock-product-id').value;
            const newTotalQuantity = parseInt(document.getElementById('edit-stock-quantity').value);
            const product = db.products.find(p => String(p.id).trim() === String(productId).trim());
            if (!product) { showError('Error', translations[currentLanguage].product_not_found_error); return; }
            
            const originalTotal = db.stock.filter(s => String(s.productId).trim() === String(productId).trim()).reduce((sum, item) => sum + item.quantity, 0);
            db.stock = db.stock.filter(s => String(s.productId).trim() !== String(productId).trim());
            const newLotId = db.stock.length > 0 ? Math.max(...db.stock.map(s => s.lotId)) + 1 : 1;
            db.stock.push({ lotId: newLotId, productId: productId, quantity: newTotalQuantity, productionDate: 'Manual Adjustment' });
            
            const remarks = `Adjusted from ${originalTotal} to ${newTotalQuantity}`;
            addHistory('adjustment', product, newTotalQuantity, currentUser.username, newLotId, 'ADJUSTMENT', remarks);
            
            populateAll();
            editStockModal.hide();
            showSuccess(translations[currentLanguage].stock_update_success);

            try {
                await saveDataToSheet();
            } catch (error) {
                db = dbBackup;
                populateAll();
                showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
            }
        }

        /**
         * Handles the submission of the announcement form.
         * It either creates a new announcement or updates an existing one.
         * After updating the local 'db' object, it saves the changes to the Google Sheet.
         */
        async function handleAnnouncementFormSubmit(e) {
            e.preventDefault();
            const dbBackup = JSON.parse(JSON.stringify(db));
            let successMessage = '';
            
            const title = document.getElementById('announcement-title').value;
            const message = document.getElementById('announcement-message').value;
            const isActive = document.getElementById('announcement-active').checked;

            if (!title || !message) {
                showError(translations[currentLanguage].form_incomplete, 'Please provide a title and message.');
                return;
            }

            // Check if we are editing an existing announcement
            if (editingAnnouncementId) {
                const index = db.announcements.findIndex(a => String(a.id) === String(editingAnnouncementId));
                if (index > -1) {
                    db.announcements[index] = { ...db.announcements[index], title, message, isActive };
                    successMessage = translations[currentLanguage].announcement_update_success;
                }
            } else { // Or creating a new one
                const newId = db.announcements.length > 0 ? Math.max(...db.announcements.map(a => a.id)) + 1 : 1;
                db.announcements.push({ id: newId, title, message, postedBy: currentUser.username, postedDate: new Date().toISOString(), isActive });
                successMessage = translations[currentLanguage].announcement_add_success;
            }
            
            clearAnnouncementForm();
            populateAll(); // Refresh all UI components including the announcement table and display
            showSuccess(successMessage);

             try {
                await saveDataToSheet();
            } catch (error) {
                db = dbBackup;
                populateAll();
                showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
            }
        }
        
        function showLoginPage() { 
            stopDataSync(); 
            clearTimeout(inactivityTimer);
            clearActivityListeners();
            currentUser = null; 
            sessionStorage.removeItem('currentUser'); 
            loginPage.style.display = 'block'; 
            dashboardPage.style.display = 'none'; 
            document.getElementById('username').value = ''; 
            document.getElementById('password').value = ''; 
            errorMessage.classList.add('d-none'); 
        }

        function showDashboard() { 
            loginPage.style.display = 'none'; 
            dashboardPage.style.display = 'block'; 
            const roleText = translations[currentLanguage].user_role_display.replace('{role}', currentUser.role);
            userRoleSpan.innerHTML = `<i class="bi bi-person-check-fill me-1"></i> ${currentUser.username} (${roleText})`; 
            userRoleSpan.className = `badge rounded-pill me-2 fs-6 align-middle ${currentUser.role === 'admin' ? 'bg-success' : 'bg-info text-dark'}`; 
            
            const adminElements = document.querySelectorAll('.admin-nav'); 
            const displayStyle = currentUser.role === 'admin' ? 'block' : 'none'; 
            adminElements.forEach(el => el.style.display = displayStyle); 

            const stockContentColumn = document.getElementById('stock-content-column');
            if (currentUser.role === 'admin') {
                stockContentColumn.classList.remove('col-lg-12');
                stockContentColumn.classList.add('col-lg-9');
            } else {
                stockContentColumn.classList.remove('col-lg-9');
                stockContentColumn.classList.add('col-lg-12');
            }
            
            populateAll(); 
            startDataSync(); 
            setupActivityListeners();
            resetInactivityTimer();
        }

        function populateAll() { 
            populateStockSummary(); 
            populateUserManagementTable(); 
            populateProductManagementTable(); 
            populateHistoryTable(); 
            populateAnnouncementsTable(); // Renders the management table for admins
            displayActiveAnnouncements(); // Renders the announcements for users on the main page
            if (currentUser.role === 'admin') { 
                document.querySelectorAll('.admin-only-cell').forEach(el => el.style.display = 'table-cell'); 
            } else { 
                document.querySelectorAll('.admin-only-cell').forEach(el => el.style.display = 'none'); 
            } 
        }

        // --- RENDER FUNCTIONS (for dynamic content) ---
        function renderAllForms() {
            renderImportForm();
            renderExportForm();
            renderProductForm();
            renderUserForm();
            renderAnnouncementForm();
            renderHistoryFilterForm();
        }
        
        function populateStockSummary() {
            const T = translations[currentLanguage];
            const header = document.getElementById('stock-summary-table-header');
            header.innerHTML = `<tr>
                <th></th>
                <th>${T.stock_table_product}</th>
                <th>${T.erp_code}</th>
                <th>${T.customer}</th>
                <th>${T.stock_table_balance}</th>
                <th class="admin-only-cell">${T.actions}</th>
            </tr>`;
            
            stockSummaryTable.innerHTML = '';
            const productIdsInStock = [...new Set(db.stock.map(s => String(s.productId).trim()))];
            const filterOldStock = showOldStockFilter.checked;
            const searchTerm = stockSearchInput.value.toLowerCase();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

            let summary = productIdsInStock.map(id => {
                let productInfo = db.products.find(p => String(p.id).trim() === id);
                if (!productInfo) {
                    const latestHistoryEntry = db.history.find(h => String(h.productId).trim() === id);
                    productInfo = {
                        id: id,
                        name: latestHistoryEntry ? latestHistoryEntry.productName : T.product_not_found.replace('{id}', id),
                        customer: latestHistoryEntry ? latestHistoryEntry.customer || '-' : '-',
                        erpCode: latestHistoryEntry ? latestHistoryEntry.erpCode || '-' : '-',
                    };
                }
                const lots = db.stock.filter(s => String(s.productId).trim() === id);
                const totalQuantity = lots.reduce((sum, item) => sum + item.quantity, 0);
                const hasOldStock = lots.some(s => s.quantity > 0 && new Date(formatDate(s.productionDate)) < threeMonthsAgo);
                return { ...productInfo, totalQuantity, hasOldStock };
            });
            
            summary = summary.filter(p => p.totalQuantity > 0);
            if (filterOldStock) summary = summary.filter(p => p.hasOldStock);
            if (searchTerm) {
                summary = summary.filter(item => 
                    String(item.id).trim().toLowerCase().includes(searchTerm) || 
                    item.name.toLowerCase().includes(searchTerm) || 
                    (item.customer && item.customer.toLowerCase().includes(searchTerm)) 
                );
            }
            summary.sort((a, b) => String(a.id).localeCompare(String(b.id)));

            if (summary.length === 0) {
                const message = searchTerm ? T.stock_summary_no_results : (filterOldStock ? T.stock_summary_no_old_stock : T.stock_summary_no_stock);
                stockSummaryTable.innerHTML = `<tr><td colspan="6" class="text-center p-4">${message} <i class="bi bi-emoji-wink"></i></td></tr>`;
                return;
            }

            summary.forEach(item => {
                const row = document.createElement('tr');
                row.dataset.productId = item.id;
                if (item.hasOldStock) { row.classList.add('table-warning'); }
                row.innerHTML = `
                    <td>${item.hasOldStock ? '<i class="bi bi-exclamation-triangle-fill text-danger"></i>' : ''}</td>
                    <td>
                        <div><span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">${item.id}</span></div>
                        <small class="text-muted">${item.name}</small>
                    </td>
                    <td class="small-text">${item.erpCode || '-'}</td>
                    <td class="small-text">${item.customer || '-'}</td>
                    <td><span class="fw-bold">${item.totalQuantity.toLocaleString()}</span></td>
                    <td class="admin-only-cell">
                        <button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); window.app.editStockTotal('${item.id}')" title="${T.edit_stock_modal_title}"><i class="bi bi-pencil-fill"></i></button>
                    </td>`;
                row.addEventListener('click', () => window.app.showLotDetails(item.id));
                stockSummaryTable.appendChild(row);
            });
        }

        function populateHistoryTable() {
            const T = translations[currentLanguage];
            const header = document.getElementById('history-table-header');
            header.innerHTML = `<tr>
                <th>${T.history_table_type}</th>
                <th>${T.product_name}</th>
                <th>${T.quantity}</th>
                <th>${T.production_date}</th>
                <th>${T.history_table_invoice_remarks}</th>
                <th>${T.history_table_timestamp}</th>
                <th>${T.history_table_user}</th>
                <th class="admin-only-cell">${T.actions}</th>
            </tr>`;

            historyTable.innerHTML = '';
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            const type = document.getElementById('filter-type').value;
            const productId = document.getElementById('filter-product-id').value;
            const invoiceSearch = document.getElementById('filter-invoice-search').value.toLowerCase();

            if (!startDate && !endDate && !type && !productId && !invoiceSearch) {
                document.getElementById('history-total-quantity').textContent = T.history_total_quantity_display.replace('{total}', '0');
                historyTable.innerHTML = `<tr><td colspan="8" class="text-center p-4">${T.no_history_found_message} <i class="bi bi-info-circle-fill"></i></td></tr>`;
                return;
            }

            const filteredHistory = getFilteredHistory();
            const totalQuantity = filteredHistory.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('history-total-quantity').textContent = T.history_total_quantity_display.replace('{total}', totalQuantity.toLocaleString());

            if (filteredHistory.length === 0) {
                historyTable.innerHTML = `<tr><td colspan="8" class="text-center p-4">${T.no_history_for_filter_message}</td></tr>`;
                return;
            }
            filteredHistory.forEach(item => {
                const row = document.createElement('tr');
                let typeHtml, rowClass;
                // Find the production date from the stock data using lotId
                const lot = db.stock.find(s => s.lotId === item.lotId);
                switch (item.type) {
                    case 'import':
                        typeHtml = `<span class="badge bg-success-subtle text-success-emphasis rounded-pill"><i class="bi bi-arrow-down me-1"></i>${T.history_type_import}</span>`;
                        rowClass = 'history-import';
                        break;
                    case 'export':
                        typeHtml = `<span class="badge bg-info-subtle text-info-emphasis rounded-pill"><i class="bi bi-arrow-up me-1"></i>${T.history_type_export}</span>`;
                        rowClass = 'history-export';
                        break;
                    case 'adjustment':
                        typeHtml = `<span class="badge bg-warning-subtle text-warning-emphasis rounded-pill"><i class="bi bi-pencil-fill me-1"></i>${T.history_type_adjustment}</span>`;
                        rowClass = 'history-adjustment';
                        break;
                }
                row.classList.add(rowClass);
                const formattedDate = new Date(item.date).toLocaleString(currentLanguage === 'th' ? 'th-TH' : 'en-GB', {
                    year: 'numeric', month: 'short', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Bangkok'
                });
                const actionsContent = `<button class="btn btn-warning btn-sm" onclick="window.app.editHistory('${item.date}')"><i class="bi bi-pencil-fill"></i></button> <button class="btn btn-danger btn-sm" onclick="window.app.deleteHistory('${item.date}')"><i class="bi bi-trash3-fill"></i></button>`;
                row.innerHTML = ` <td>${typeHtml}</td> <td><div>${item.productName}</div><small class="text-muted">${item.productId}</small></td> <td>${item.quantity.toLocaleString()}</td> <td>${lot ? formatDate(lot.productionDate) : 'N/A'}</td> <td> <div>${item.invoiceNumber || '-'}</div> <small class="text-muted">${item.remarks || ''}</small> </td> <td>${formattedDate}</td> <td>${item.user}</td> <td class="admin-only-cell">${actionsContent}</td> `;
                historyTable.appendChild(row);
            });
        }
        
        // --- ADD EVENT LISTENERS ---
        function addEventListeners() {
            loginForm.addEventListener('submit', handleLogin);
            logoutBtn.addEventListener('click', () => confirmAction(translations[currentLanguage].confirm_logout_title, '', showLoginPage));
            document.getElementById('refresh-stock-summary-btn').addEventListener('click', () => loadDataFromSheet(true));
            
            document.getElementById('backup-stock-btn').addEventListener('click', () => {
                const stockBackupData = generateStockBackupData();
                backupToCSV(stockBackupData, 'stock_summary_backup.csv');
            });
            document.getElementById('backup-products-btn').addEventListener('click', () => {
                backupToCSV(db.products, 'products_backup.csv');
            });
            document.getElementById('backup-users-btn').addEventListener('click', () => {
                backupToCSV(db.users, 'users_backup.csv');
            });
            document.getElementById('backup-history-btn').addEventListener('click', () => {
                const historyData = getFilteredHistory();
                backupToCSV(historyData, 'history_backup.csv');
            });

            // Delegated event listeners for dynamic content
            document.body.addEventListener('input', (e) => {
                if (e.target.id === 'import-product-id') {
                    const searchTerm = e.target.value;
                    const suggestionsContainer = document.getElementById('import-product-suggestions');
                    const productSource = db.products;
                    showSuggestions(e.target, suggestionsContainer, productSource, searchTerm);
                }
                if (e.target.id === 'export-product-id') {
                    const searchTerm = e.target.value;
                    const suggestionsContainer = document.getElementById('export-product-suggestions');
                    const productsInStockIds = [...new Set(db.stock.filter(s => s.quantity > 0).map(s => String(s.productId).trim()))];
                    const productSource = db.products.filter(p => productsInStockIds.includes(String(p.id).trim()));
                    showSuggestions(e.target, suggestionsContainer, productSource, searchTerm);
                }
                if (e.target.id === 'filter-product-search') {
                    const searchTerm = e.target.value;
                    const suggestionsContainer = document.getElementById('filter-product-suggestions');
                    const productSource = db.products;
                    showFilterSuggestions(e.target, suggestionsContainer, productSource, searchTerm);
                }
                if (e.target.classList.contains('import-quantity')) {
                    updateImportTotal();
                }
                if (e.target.classList.contains('export-quantity')) {
                    updateExportTotal();
                }
                 if (e.target.id === 'stock-search-input') {
                    populateStockSummary();
                }
            });

            document.body.addEventListener('change', (e) => {
                if (e.target.id === 'import-product-id') {
                    const product = db.products.find(p => String(p.id).trim() === e.target.value.trim());
                    document.getElementById('import-product-name').value = product ? product.name : '';
                    document.getElementById('import-customer').value = product ? product.customer || '' : '';
                    document.getElementById('import-erp-code').value = product ? product.erpCode : '';
                    document.getElementById('import-fullbox').value = product ? product.fullBoxQuantity : '';
                }
                if (e.target.id === 'export-product-id') {
                    const product = db.products.find(p => String(p.id).trim() === e.target.value.trim());
                    document.getElementById('export-product-name').value = product ? product.name : '';
                    document.getElementById('export-customer').value = product ? product.customer || '' : '';
                    document.getElementById('export-erp-code').value = product ? product.erpCode : '';
                    document.getElementById('export-fullbox').value = product ? product.fullBoxQuantity : '';
                    populateExportLotsList(e.target.value);
                }
                if (e.target.type === 'checkbox' && e.target.closest('.export-lot-row')) {
                    const row = e.target.closest('.export-lot-row');
                    const quantityInput = row.querySelector('.export-quantity');
                    quantityInput.disabled = !e.target.checked;
                    if (!e.target.checked) {
                        quantityInput.value = '';
                    }
                    updateExportTotal();
                }
                 if (e.target.id === 'show-old-stock-filter') {
                    populateStockSummary();
                }
            });
            
            document.body.addEventListener('submit', function(e) {
                if(e.target.id === 'import-form') handleImport(e);
                if(e.target.id === 'export-form') handleExport(e);
                if(e.target.id === 'product-form') handleProductFormSubmit(e);
                if(e.target.id === 'user-form') handleUserFormSubmit(e);
                if(e.target.id === 'announcement-form') handleAnnouncementFormSubmit(e);
                if(e.target.id === 'history-filter-form') { e.preventDefault(); populateHistoryTable(); }
                if(e.target.id === 'edit-history-form') handleEditHistorySubmit(e);
                if(e.target.id === 'edit-stock-form') handleEditStockSubmit(e);
            });

            document.body.addEventListener('click', function(e) {
                if (e.target.id === 'add-import-lot-btn') addImportLotRow();
                if (e.target.classList.contains('remove-import-lot-btn')) {
                    e.target.closest('.import-lot-row').remove();
                    updateImportTotal();
                }
                if (e.target.id === 'clear-import-form-btn') renderImportForm();
                if (e.target.id === 'clear-export-form-btn') renderExportForm();
                if (e.target.id === 'clear-product-form-btn') clearProductForm();
                if (e.target.id === 'clear-user-form-btn') clearUserForm();
                if (e.target.id === 'clear-announcement-form-btn') clearAnnouncementForm();
                if (e.target.id === 'history-filter-reset-btn') {
                    document.getElementById('filter-product-id').value = '';
                    setTimeout(() => populateHistoryTable(), 0);
                }
                if (e.target.closest('.suggestions-container')) {
                     if (!e.target.closest('.position-relative')) {
                         document.querySelectorAll('.suggestions-container').forEach(c => c.innerHTML = '');
                    }
                }
            });
        }
        function handleLogin(e) { e.preventDefault(); const username = document.getElementById('username').value; const password = document.getElementById('password').value; const foundUser = db.users.find(u => u.username === username && u.password === password); if (foundUser) { sessionStorage.setItem('currentUser', JSON.stringify(foundUser)); checkLoginState(); } else { errorMessage.classList.remove('d-none'); } }
        
        // --- HELPER FUNCTIONS ---
        function formatDate(dateInput) {
            if (!dateInput || dateInput === 'Manual Adjustment') return dateInput;
            let date;
            if (!isNaN(dateInput) && Number.isFinite(Number(dateInput))) { date = new Date(Number(dateInput)); } 
            else if (typeof dateInput === 'string' && dateInput.includes('T')) { date = new Date(dateInput); } 
            else if (typeof dateInput === 'string') {
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateInput)) return dateInput;
                date = new Date(dateInput);
            } else { return dateInput; }
            if (isNaN(date.getTime())) return dateInput;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function showSuccess(title) { Swal.fire({ title: translations[currentLanguage].success_title, text: title, icon: 'success', timer: 2000, showConfirmButton: false }); }
        function showError(title, text) { Swal.fire(title, text, 'error'); }
        function confirmAction(title, text, callback) { 
            Swal.fire({ 
                title: title, 
                text: text, 
                icon: 'question', 
                showCancelButton: true, 
                confirmButtonText: translations[currentLanguage].ok_button, 
                cancelButtonText: translations[currentLanguage].cancel_button,
                confirmButtonColor: '#0d6efd',
                cancelButtonColor: '#6c757d'
            }).then((r) => { if (r.isConfirmed) callback(); }); 
        }
        function backupToCSV(data, filename) { if (!data || data.length === 0) { showError('No Data', translations[currentLanguage].backup_no_data); return; } const headers = Object.keys(data[0]); const csvRows = [headers.join(',')]; data.forEach(row => { const values = headers.map(header => `"${('' + row[header]).replace(/"/g, '""')}"`); csvRows.push(values.join(',')); }); const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob(['\uFEFF' + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' })); link.setAttribute('download', filename); document.body.appendChild(link); link.click(); document.body.removeChild(link); showSuccess(translations[currentLanguage].backup_downloading.replace('{filename}', filename)); }
        
        function getFilteredHistory() {
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            const type = document.getElementById('filter-type').value;
            const productId = document.getElementById('filter-product-id').value;
            const invoiceSearch = document.getElementById('filter-invoice-search').value.toLowerCase();

            let filteredHistory = db.history;

            if (startDate) { filteredHistory = filteredHistory.filter(item => item.date.split('T')[0] >= startDate); }
            if (endDate) { filteredHistory = filteredHistory.filter(item => item.date.split('T')[0] <= endDate); }
            if (type) { filteredHistory = filteredHistory.filter(item => item.type === type); }
            if (productId) { filteredHistory = filteredHistory.filter(item => String(item.productId).trim() === String(productId).trim()); }
            if (invoiceSearch) { filteredHistory = filteredHistory.filter(item => item.invoiceNumber && item.invoiceNumber.toLowerCase().includes(invoiceSearch));}
            
            return filteredHistory;
        }
        
        function generateStockBackupData() {
            const T = translations[currentLanguage];
            const stockSummary = {};

            db.stock.forEach(lot => {
                if (lot.quantity > 0) {
                    const date = formatDate(lot.productionDate);
                    const key = `${lot.productId}_${date}`;

                    if (!stockSummary[key]) {
                        let productInfo = db.products.find(p => String(p.id).trim() === String(lot.productId).trim());
                        if (!productInfo) {
                             productInfo = { name: T.product_not_found.replace('{id}', lot.productId), customer: '-', erpCode: '-' };
                        }
                        stockSummary[key] = {
                            productId: lot.productId,
                            productName: productInfo.name,
                            customer: productInfo.customer,
                            erpCode: productInfo.erpCode,
                            productionDate: date,
                            totalQuantity: 0
                        };
                    }
                    stockSummary[key].totalQuantity += lot.quantity;
                }
            });

            // Convert the summary object back to an array and sort it
            return Object.values(stockSummary).sort((a, b) => {
                if (a.productId < b.productId) return -1;
                if (a.productId > b.productId) return 1;
                return new Date(a.productionDate) - new Date(b.productionDate);
            });
        }

        function populateUserManagementTable() { 
            const T = translations[currentLanguage];
            const header = document.getElementById('user-management-table-header');
            header.innerHTML = `<tr><th>${T.username_label}</th><th>${T.user_role}</th><th>${T.actions}</th></tr>`;
            
            const userManagementTable = document.getElementById('user-management-table');
            userManagementTable.innerHTML = ''; 
            if (db.users.length === 0) {
                userManagementTable.innerHTML = `<tr><td colspan="3" class="text-center p-4">${T.user_management_no_data}</td></tr>`;
                return;
            }
            db.users.forEach(u => { 
                const r = document.createElement('tr'); 
                r.innerHTML = `<td><i class="bi bi-person-circle me-2"></i>${u.username}</td><td><span class="badge rounded-pill ${u.role === 'admin' ? 'bg-success' : 'bg-info text-dark'}">${u.role}</span></td><td><button class="btn btn-warning btn-sm" onclick="window.app.editUser('${u.username}')"><i class="bi bi-pencil-fill"></i></button> ${u.username !== 'admin' ? `<button class="btn btn-danger btn-sm" onclick="window.app.deleteUser('${u.username}')"><i class="bi bi-trash3-fill"></i></button>` : ''}</td>`; 
                userManagementTable.appendChild(r); 
            }); 
        }

        function populateProductManagementTable() {
            const T = translations[currentLanguage];
            const header = document.getElementById('product-management-table-header');
            header.innerHTML = `<tr><th>${T.product_id}</th><th>${T.product_name}</th><th>${T.customer}</th><th>${T.product_table_price}</th><th>${T.actions}</th></tr>`;

            const productManagementTable = document.getElementById('product-management-table');
            productManagementTable.innerHTML = '';
            if (db.products.length === 0) {
                productManagementTable.innerHTML = `<tr><td colspan="5" class="text-center p-4">${T.product_management_no_data}</td></tr>`;
                return;
            }
            db.products.forEach(p => {
                const r = document.createElement('tr');
                r.innerHTML = `<td>${p.id}</td><td>${p.name}</td><td>${p.customer || '-'}</td><td>${Number(p.unitPrice || 0).toFixed(2)}</td><td><button class="btn btn-warning btn-sm" onclick="window.app.editProduct('${p.id}')"><i class="bi bi-pencil-fill"></i></button> <button class="btn btn-danger btn-sm" onclick="window.app.deleteProduct('${p.id}')"><i class="bi bi-trash3-fill"></i></button></td>`;
                productManagementTable.appendChild(r);
            });
        }

        /**
         * Renders the table of all announcements in the admin management tab.
         * Fetches all announcements from the 'db', sorts them by date, and creates table rows.
         */
        function populateAnnouncementsTable() {
            const T = translations[currentLanguage];
            const header = document.getElementById('announcement-management-table-header');
            header.innerHTML = `<tr>
                <th>${T.announcement_table_header_title}</th>
                <th>${T.announcement_table_status}</th>
                <th>${T.announcement_table_posted_by}</th>
                <th>${T.announcement_table_posted_date}</th>
                <th>${T.actions}</th>
            </tr>`;

            const announcementManagementTable = document.getElementById('announcement-management-table');
            announcementManagementTable.innerHTML = '';
            const sortedAnnouncements = [...db.announcements].sort((a, b) => new Date(b.postedDate) - new Date(a.postedDate));

            if (sortedAnnouncements.length === 0) {
                announcementManagementTable.innerHTML = `<tr><td colspan="5" class="text-center p-4">${T.announcement_management_no_data}</td></tr>`;
                return;
            }

            sortedAnnouncements.forEach(ann => {
                const row = document.createElement('tr');
                const formattedDate = new Date(ann.postedDate).toLocaleString(currentLanguage === 'th' ? 'th-TH' : 'en-GB', {
                    year: 'numeric', month: 'short', day: 'numeric', timeZone: 'Asia/Bangkok'
                });
                const statusBadge = ann.isActive 
                    ? `<span class="badge bg-success-subtle text-success-emphasis rounded-pill">${T.announcement_status_active}</span>`
                    : `<span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">${T.announcement_status_inactive}</span>`;
                
                row.innerHTML = `
                    <td>${ann.title}</td>
                    <td>${statusBadge}</td>
                    <td>${ann.postedBy}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="window.app.editAnnouncement('${ann.id}')"><i class="bi bi-pencil-fill"></i></button>
                        <button class="btn btn-info btn-sm" onclick="window.app.toggleAnnouncementStatus('${ann.id}')"><i class="bi bi-toggle-${ann.isActive ? 'on' : 'off'}"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="window.app.deleteAnnouncement('${ann.id}')"><i class="bi bi-trash3-fill"></i></button>
                    </td>`;
                announcementManagementTable.appendChild(row);
            });
        }

        /**
         * Filters for active announcements and displays them in the dedicated area
         * on the main stock dashboard for all users to see.
         */
        function displayActiveAnnouncements() {
            const T = translations[currentLanguage];
            const announcementsDisplayArea = document.getElementById('announcements-display-area');
            announcementsDisplayArea.innerHTML = '';
            const activeAnnouncements = db.announcements.filter(ann => ann.isActive)
                                                      .sort((a, b) => new Date(b.postedDate) - new Date(a.postedDate));

            if (activeAnnouncements.length === 0) return;

            activeAnnouncements.forEach(ann => {
                const formattedDate = new Date(ann.postedDate).toLocaleString(currentLanguage === 'th' ? 'th-TH' : 'en-GB', {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Bangkok'
                });
                const footerText = T.announcement_posted_by_on.replace('{user}', ann.postedBy).replace('{date}', formattedDate);
                const announcementHtml = `
                    <div class="card announcement-card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-megaphone-fill me-2"></i>${ann.title}</span>
                            <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill">${T.announcement_badge}</span>
                        </div>
                        <div class="card-body">
                            <p class="card-text">${ann.message}</p>
                        </div>
                        <div class="card-footer text-end">${footerText}</div>
                    </div>`;
                announcementsDisplayArea.insertAdjacentHTML('beforeend', announcementHtml);
            });
        }

        function populateExportLotsList(productId) {
            const T = translations[currentLanguage];
            const container = document.getElementById('export-lots-container');
            container.innerHTML = '';
            if (!productId) {
                container.innerHTML = `<p class="text-muted text-center">${T.export_lot_placeholder_no_product}</p>`;
                return;
            }

            const lots = db.stock.filter(s => String(s.productId).trim() === String(productId).trim() && s.quantity > 0);
            if (lots.length === 0) {
                container.innerHTML = `<p class="text-muted text-center">${T.export_lot_placeholder_no_stock}</p>`;
                return;
            }

            const lotsByDate = lots.reduce((acc, lot) => {
                const date = formatDate(lot.productionDate);
                if (!acc[date]) acc[date] = 0;
                acc[date] += lot.quantity;
                return acc;
            }, {});

            const sortedDates = Object.keys(lotsByDate).sort((a, b) => new Date(a) - new Date(b));

            sortedDates.forEach(date => {
                const totalQuantity = lotsByDate[date];
                const row = document.createElement('div');
                row.className = 'row g-2 mb-2 align-items-center export-lot-row';
                row.dataset.date = date;
                row.innerHTML = `
                    <div class="col-auto">
                        <input class="form-check-input" type="checkbox">
                    </div>
                    <div class="col">
                        <label class="form-check-label">${T.export_lot_option.replace('{date}', date).replace('{qty}', totalQuantity.toLocaleString())}</label>
                    </div>
                    <div class="col-4">
                        <input type="number" class="form-control form-control-sm export-quantity" placeholder="${T.quantity}" min="1" max="${totalQuantity}" disabled>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function populateLotDetailsTable(productId) {
            const T = translations[currentLanguage];
            const header = document.getElementById('lot-detail-table-header');
            header.innerHTML = `<tr>
                <th>${T.production_date}</th>
                <th>${T.lot_modal_balance}</th>
                <th class="admin-only-cell">${T.actions}</th>
            </tr>`;
            
            const lotDetailTable = document.getElementById('lot-detail-table');
            lotDetailTable.innerHTML = '';
            
            const lots = db.stock.filter(s => String(s.productId).trim() === String(productId).trim() && s.quantity > 0);
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

            if(lots.length === 0) {
                lotDetailTable.innerHTML = `<tr><td colspan="3" class="text-center">${T.lot_modal_no_data}</td></tr>`;
                return;
            }

            const lotsByDate = lots.reduce((acc, lot) => {
                const date = formatDate(lot.productionDate);
                if (!acc[date]) acc[date] = { quantity: 0, isOld: false };
                acc[date].quantity += lot.quantity;
                if (new Date(date) < threeMonthsAgo && date !== 'Manual Adjustment') acc[date].isOld = true;
                return acc;
            }, {});

            const sortedDates = Object.keys(lotsByDate).sort((a, b) => new Date(a) - new Date(b));

            sortedDates.forEach(date => {
                const lotGroup = lotsByDate[date];
                const isOld = lotGroup.isOld;
                const row = document.createElement('tr');
                if (isOld) row.classList.add('table-warning');
                row.innerHTML = `
                    <td>${date} ${isOld ? '<i class="bi bi-exclamation-triangle-fill text-danger ms-2"></i>' : ''}</td>
                    <td>${lotGroup.quantity.toLocaleString()}</td>
                    <td class="admin-only-cell">
                        <button class="btn btn-danger btn-sm" onclick="window.app.deleteLotsByDate('${productId}', '${date}')"><i class="bi bi-trash3-fill"></i></button>
                    </td>`;
                lotDetailTable.appendChild(row);
            });
        }

        function showSuggestions(inputEl, containerEl, productSource, searchTerm) { containerEl.innerHTML = ''; if (!searchTerm) return; const lowerCaseSearchTerm = searchTerm.toLowerCase().trim(); const filteredProducts = productSource.filter(p => String(p.id).trim().toLowerCase().includes(lowerCaseSearchTerm) || p.name.toLowerCase().includes(lowerCaseSearchTerm)); filteredProducts.slice(0, 5).forEach(item => { const suggestionEl = document.createElement('a'); suggestionEl.href = '#'; suggestionEl.classList.add('list-group-item', 'list-group-item-action'); suggestionEl.textContent = `${item.id} - ${item.name}`; suggestionEl.addEventListener('click', (e) => { e.preventDefault(); inputEl.value = item.id; containerEl.innerHTML = ''; inputEl.dispatchEvent(new Event('change', { bubbles: true })); }); containerEl.appendChild(suggestionEl); }); }
        function showFilterSuggestions(inputEl, containerEl, productSource, searchTerm) { const hiddenInputEl = document.getElementById('filter-product-id'); containerEl.innerHTML = ''; if (!searchTerm) { hiddenInputEl.value = ''; return; } const lowerCaseSearchTerm = searchTerm.toLowerCase().trim(); const filteredProducts = productSource.filter(p => String(p.id).trim().toLowerCase().includes(lowerCaseSearchTerm) || p.name.toLowerCase().includes(lowerCaseSearchTerm)); filteredProducts.slice(0, 5).forEach(item => { const suggestionEl = document.createElement('a'); suggestionEl.href = '#'; suggestionEl.classList.add('list-group-item', 'list-group-item-action', 'p-2'); suggestionEl.textContent = `${item.id} - ${item.name}`; suggestionEl.addEventListener('click', (e) => { e.preventDefault(); inputEl.value = `${item.id} - ${item.name}`; hiddenInputEl.value = item.id; containerEl.innerHTML = ''; }); containerEl.appendChild(suggestionEl); }); }

        function clearProductForm() { editingProductId = null; document.getElementById('product-form').reset(); document.getElementById('product-id').readOnly = false; }
        function clearUserForm() { originalUsernameForEdit = null; document.getElementById('user-form').reset(); }
        function clearAnnouncementForm() { editingAnnouncementId = null; document.getElementById('announcement-form').reset(); document.getElementById('announcement-active').checked = true; }

        function addImportLotRow() {
            const T = translations[currentLanguage];
            const container = document.getElementById('import-lots-container');
            const newRow = document.createElement('div');
            newRow.className = 'row g-2 mb-2 align-items-center import-lot-row';
            newRow.innerHTML = `
                <div class="col-md-5">
                    <label class="form-label visually-hidden">${T.production_date}</label>
                    <input type="date" class="form-control import-prod-date" required>
                </div>
                <div class="col-md-5">
                    <label class="form-label visually-hidden">${T.quantity}</label>
                    <input type="number" class="form-control import-quantity" placeholder="${T.quantity}" required min="1">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm w-100 remove-import-lot-btn"><i class="bi bi-trash3-fill"></i></button>
                </div>
            `;
            container.appendChild(newRow);
        }

        function updateImportTotal() {
            const lotQuantities = document.querySelectorAll('#import-lots-container .import-quantity');
            let total = 0;
            lotQuantities.forEach(input => {
                total += parseInt(input.value) || 0;
            });
            document.getElementById('import-total-quantity').value = total.toLocaleString();
        }

        function updateExportTotal() {
            const lotRows = document.querySelectorAll('#export-lots-container .export-lot-row:has(input[type="checkbox"]:checked)');
            let total = 0;
            lotRows.forEach(row => {
                const quantityInput = row.querySelector('.export-quantity');
                total += parseInt(quantityInput.value) || 0;
            });
            document.getElementById('export-total-quantity').value = total.toLocaleString();
        }

        function renderImportForm() {
            const T = translations[currentLanguage];
            const importFormEl = document.getElementById('import-form');
            importFormEl.innerHTML = `
                <div class="col-md-4"> <label for="import-product-id" class="form-label">${T.product_id}</label> <div class="position-relative"> <input type="text" id="import-product-id" class="form-control" required autocomplete="off" placeholder="${T.search_placeholder}"> <div id="import-product-suggestions" class="list-group position-absolute w-100 suggestions-container"></div> </div> </div>
                <div class="col-md-5"> <label for="import-product-name" class="form-label">${T.product_name}</label> <input type="text" id="import-product-name" class="form-control" readonly style="background-color: #e9ecef;"> </div>
                <div class="col-md-3"> <label for="import-fullbox" class="form-label">${T.import_fullbox}</label> <input type="text" id="import-fullbox" class="form-control" readonly style="background-color: #e9ecef;"> </div>
                <div class="col-md-6"> <label for="import-customer" class="form-label">${T.customer}</label> <input type="text" id="import-customer" class="form-control" readonly style="background-color: #e9ecef;"> </div>
                <div class="col-md-6"> <label for="import-erp-code" class="form-label">${T.erp_code}</label> <input type="text" id="import-erp-code" class="form-control" readonly style="background-color: #e9ecef;"> </div>
                <hr class="my-3">
                <div id="import-lots-container" class="col-12"></div>
                <div class="col-12"><button type="button" id="add-import-lot-btn" class="btn btn-sm btn-outline-primary"><i class="bi bi-plus-circle-fill me-1"></i>${T.import_add_lot_button}</button></div>
                <hr class="my-3">
                <div class="col-md-4"> <label for="import-total-quantity" class="form-label">${T.import_total_quantity}</label> <input type="text" id="import-total-quantity" class="form-control fw-bold" readonly style="background-color: #e9ecef; font-size: 1.2rem;"> </div>
                <div class="col-md-8"> <label for="import-remarks" class="form-label">${T.remarks}</label> <textarea id="import-remarks" class="form-control" rows="2"></textarea> </div>
                <div class="col-12 mt-2"> <p class="text-danger fw-bold"><i class="bi bi-exclamation-triangle-fill me-2"></i>${T.import_warning}</p> </div>
                <div class="col-12"> <button type="submit" class="btn btn-primary"><i class="bi bi-save-fill me-2"></i>${T.import_save_button}</button> <button type="button" id="clear-import-form-btn" class="btn btn-secondary ms-2"><i class="bi bi-eraser-fill me-2"></i>${T.clear_form_button}</button> </div>`;
            addImportLotRow();
        }

        function renderExportForm() {
            const T = translations[currentLanguage];
            const exportFormEl = document.getElementById('export-form');
            exportFormEl.innerHTML = `
                <div class="col-md-4"> <label for="export-product-id" class="form-label">${T.product_id}</label> <div class="position-relative"> <input type="text" id="export-product-id" class="form-control" required autocomplete="off" placeholder="${T.search_placeholder}"> <div id="export-product-suggestions" class="list-group position-absolute w-100 suggestions-container"></div> </div> </div>
                <div class="col-md-5"> <label for="export-product-name" class="form-label">${T.product_name}</label> <input type="text" id="export-product-name" class="form-control" readonly style="background-color: #e9ecef;"> </div>
                <div class="col-md-3"> <label for="export-fullbox" class="form-label">${T.import_fullbox}</label> <input type="text" id="export-fullbox" class="form-control" readonly style="background-color: #e9ecef;"> </div>
                <div class="col-md-6"> <label for="export-customer" class="form-label">${T.customer}</label> <input type="text" id="export-customer" class="form-control" readonly style="background-color: #e9ecef;"> </div>
                <div class="col-md-6"> <label for="export-erp-code" class="form-label">${T.erp_code}</label> <input type="text" id="export-erp-code" class="form-control" readonly style="background-color: #e9ecef;"> </div>
                <hr class="my-3">
                <div class="col-12"><label class="form-label fw-bold">${T.export_lot_select}</label><div id="export-lots-container" class="border rounded p-2 bg-light"></div></div>
                <hr class="my-3">
                <div class="col-md-4"> <label for="export-total-quantity" class="form-label">${T.export_total_quantity}</label> <input type="text" id="export-total-quantity" class="form-control fw-bold" value="0" readonly style="background-color: #e9ecef; font-size: 1.2rem;"> </div>
                <div class="col-md-4"> <label for="export-invoice-number" class="form-label">${T.export_invoice}</label> <input type="text" id="export-invoice-number" class="form-control" required> </div>
                <div class="col-md-4"> <label for="export-remarks" class="form-label">${T.remarks}</label> <textarea id="export-remarks" class="form-control" rows="1"></textarea> </div>
                <div class="col-12 mt-2"> <p class="text-danger fw-bold"><i class="bi bi-exclamation-triangle-fill me-2"></i>${T.export_warning}</p> </div>
                <div class="col-12 mt-3"> <button type="submit" class="btn btn-success"><i class="bi bi-send-check-fill me-2"></i>${T.export_save_button}</button> <button type="button" id="clear-export-form-btn" class="btn btn-secondary ms-2"><i class="bi bi-eraser-fill me-2"></i>${T.clear_form_button}</button> </div>`;
        }

        function renderProductForm() {
            const T = translations[currentLanguage];
            const productFormEl = document.getElementById('product-form');
            productFormEl.innerHTML = `
                <div class="col-12"> <label for="product-id" class="form-label">${T.product_id}</label> <input type="text" id="product-id" class="form-control" required> </div>
                <div class="col-12"> <label for="product-name" class="form-label">${T.product_name}</label> <input type="text" id="product-name" class="form-control" required> </div>
                <div class="col-12"> <label for="product-customer" class="form-label">${T.customer}</label> <input type="text" id="product-customer" class="form-control"> </div>
                <div class="col-12"> <label for="product-fullBoxQuantity" class="form-label">${T.product_fullbox_rack}</label> <input type="number" id="product-fullBoxQuantity" class="form-control" required min="1"> </div>
                <div class="col-12"> <label for="product-erpCode" class="form-label">${T.erp_code}</label> <input type="text" id="product-erpCode" class="form-control"> </div>
                <div class="col-12"> <label for="product-unitPrice" class="form-label">${T.product_unit_price}</label> <input type="number" step="0.01" id="product-unitPrice" class="form-control" required min="0"> </div>
                <div class="col-12"> <button type="submit" class="btn btn-primary w-100"><i class="bi bi-save-fill me-2"></i>${T.product_save_button}</button> <button type="button" id="clear-product-form-btn" class="btn btn-secondary w-100 mt-2">${T.clear_form_button}</button> </div>`;
        }

        function renderUserForm() {
            const T = translations[currentLanguage];
            const userFormEl = document.getElementById('user-form');
            userFormEl.innerHTML = `
                <div class="col-12"> <label for="user-username" class="form-label">${T.username_label}</label> <input type="text" id="user-username" class="form-control" required> </div>
                <div class="col-12"> <label for="user-password" class="form-label">${T.password_label}</label> <input type="password" id="user-password" class="form-control" required> </div>
                <div class="col-12"> <label for="user-role-select" class="form-label">${T.user_role}</label> <select id="user-role-select" class="form-select" required><option value="user">User</option><option value="admin">Admin</option></select> </div>
                <div class="col-12"> <button type="submit" class="btn btn-primary w-100"><i class="bi bi-save-fill me-2"></i>${T.user_save_button}</button> <button type="button" id="clear-user-form-btn" class="btn btn-secondary w-100 mt-2">${T.clear_form_button}</button> </div>`;
        }
        
        /**
         * Renders the announcement creation/editing form.
         * If an announcement object is passed, it populates the form for editing.
         */
        function renderAnnouncementForm(announcement = {}) {
            const T = translations[currentLanguage];
            const announcementFormEl = document.getElementById('announcement-form');
            announcementFormEl.innerHTML = `
                <input type="hidden" id="announcement-id" value="${announcement.id || ''}">
                <div class="col-12"> <label for="announcement-title" class="form-label">${T.announcement_title}</label> <input type="text" id="announcement-title" class="form-control" required value="${announcement.title || ''}"> </div>
                <div class="col-12"> <label for="announcement-message" class="form-label">${T.announcement_message}</label> <textarea id="announcement-message" class="form-control" rows="4" required>${announcement.message || ''}</textarea> </div>
                <div class="col-12">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="announcement-active" ${announcement.isActive === false ? '' : 'checked'}>
                        <label class="form-check-label" for="announcement-active">${T.announcement_show}</label>
                    </div>
                </div>
                <div class="col-12"> <button type="submit" class="btn btn-primary w-100"><i class="bi bi-save-fill me-2"></i>${T.announcement_save_button}</button> <button type="button" id="clear-announcement-form-btn" class="btn btn-secondary w-100 mt-2">${T.clear_form_button}</button> </div>`;
        }

        function renderHistoryFilterForm() {
            const T = translations[currentLanguage];
            const historyFilterForm = document.getElementById('history-filter-form');
            historyFilterForm.innerHTML = `
                <div class="col-lg-2 col-md-6"> <label for="filter-start-date" class="form-label">${T.history_filter_from}</label> <input type="date" id="filter-start-date" class="form-control form-control-sm"> </div>
                <div class="col-lg-2 col-md-6"> <label for="filter-end-date" class="form-label">${T.history_filter_to}</label> <input type="date" id="filter-end-date" class="form-control form-control-sm"> </div>
                <div class="col-lg-2 col-md-6"> <label for="filter-type" class="form-label">${T.history_filter_type}</label> <select id="filter-type" class="form-select form-select-sm"> <option value="">${T.history_filter_type_all}</option> <option value="import">${T.history_filter_type_import}</option> <option value="export">${T.history_filter_type_export}</option> <option value="adjustment">${T.history_filter_type_adjustment}</option> </select> </div>
                <div class="col-lg-2 col-md-6"> <label for="filter-product-search" class="form-label">${T.history_filter_product}</label> <div class="position-relative"> <input type="text" id="filter-product-search" class="form-control form-control-sm" placeholder="${T.history_filter_type_all}" autocomplete="off"> <input type="hidden" id="filter-product-id"> <div id="filter-product-suggestions" class="list-group position-absolute w-100 suggestions-container"></div> </div> </div>
                <div class="col-lg-2 col-md-6"> <label for="filter-invoice-search" class="form-label">${T.history_filter_invoice}</label> <input type="text" id="filter-invoice-search" class="form-control form-control-sm" placeholder="${T.search_placeholder}" autocomplete="off"> </div>
                <div class="col-lg-2 col-md-12 d-flex mt-auto"> <button type="submit" class="btn btn-primary btn-sm flex-grow-1 me-1"><i class="bi bi-search me-1"></i>${T.history_filter_search}</button> <button type="reset" id="history-filter-reset-btn" class="btn btn-secondary btn-sm flex-grow-1 ms-1">${T.history_filter_clear}</button> </div>`;
        }

        function renderEditHistoryForm(historyItem, stockLot) {
            const T = translations[currentLanguage];
            const editHistoryForm = document.getElementById('edit-history-form');
            const isExport = historyItem.type === 'export';
            
            const title = isExport ? 'แก้ไขประวัติการส่งออก' : 'แก้ไขประวัติการรับเข้า';
            const quantityLabel = isExport ? T.export_quantity : T.import_quantity;

            document.getElementById('edit-history-modal-title').innerHTML = `<i class="bi bi-pencil-square me-2"></i>${title}`;

            editHistoryForm.innerHTML = `
                <input type="hidden" id="edit-history-id" value="${historyItem.date}">
                <div class="mb-3"> <label class="form-label">${T.product_name}</label> <input type="text" id="edit-history-product-name" class="form-control" value="${historyItem.productName} (Lot ID: ${historyItem.lotId})" readonly> </div>
                <div class="mb-3"> <label for="edit-history-prod-date" class="form-label">${T.production_date}</label> <input type="date" id="edit-history-prod-date" class="form-control" value="${formatDate(stockLot.productionDate)}" required> </div>
                <div class="mb-3"> <label for="edit-history-quantity" class="form-label">${quantityLabel}</label> <input type="number" id="edit-history-quantity" class="form-control" value="${historyItem.quantity}" required min="0"> </div>
                <div class="mb-3" id="edit-history-invoice-group" style="display: ${isExport ? 'block' : 'none'}"> <label for="edit-history-invoice" class="form-label">${T.export_invoice}</label> <input type="text" id="edit-history-invoice" class="form-control" value="${historyItem.invoiceNumber || ''}" ${isExport ? 'required' : ''}> </div>
                <div class="mb-3"> <label for="edit-history-remarks" class="form-label">${T.remarks}</label> <textarea id="edit-history-remarks" class="form-control" rows="2">${historyItem.remarks || ''}</textarea> </div>
                <div class="d-grid"> <button type="submit" class="btn btn-primary">${T.save_button}</button> </div>`;
        }

        function renderEditStockForm(product, totalQuantity) {
            const T = translations[currentLanguage];
            const editStockForm = document.getElementById('edit-stock-form');
            editStockForm.innerHTML = `
                <input type="hidden" id="edit-stock-product-id" value="${product.id}">
                <div class="mb-3"> <label class="form-label">${T.product_name}</label> <input type="text" id="edit-stock-product-name" class="form-control" value="${product.id} - ${product.name}" readonly> </div>
                <div class="mb-3"> <label for="edit-stock-quantity" class="form-label">${T.edit_stock_new_total}</label> <input type="number" id="edit-stock-quantity" class="form-control" value="${totalQuantity}" required min="0"> </div>
                <div class="form-text">${T.edit_stock_note}</div>
                <div class="d-grid mt-3"> <button type="submit" class="btn btn-primary">${T.edit_stock_save_button}</button> </div>`;
        }
        
        // --- START THE APP ---
        init();
    });
    </script>
</body>
</html>
