<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรับเข้า-ส่งออกสินค้า FG (Google Sheets)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d6efd; /* Main blue */
            --secondary-color: #6c757d; /* Gray */
            --success-color: #198754; /* Green */
            --danger-color: #dc3545; /* Red */
            --warning-color: #ffc107; /* Yellow */
            --bg-color: #f0f2f5; /* Light gray background */
            --text-color: #212529;
            --border-radius: 12px;
            --header-bg: #e7f1ff; /* Light blue header background */
        }
        body { 
            background-color: var(--bg-color); 
            color: var(--text-color); 
        }
        body.lang-th { font-family: 'Mitr', sans-serif; }
        body.lang-en { font-family: 'Inter', sans-serif; }

        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .card { border-radius: var(--border-radius); border: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); overflow: hidden; }
        .card-header-custom { background: linear-gradient(135deg, var(--primary-color), #0dcaf0); color: white; border-bottom: none; }
        .card-header { background-color: var(--header-bg); border-bottom: 1px solid #dee2e6; }
        .btn { border-radius: var(--border-radius); padding: 10px 20px; font-weight: 500; transition: transform 0.2s ease, box-shadow 0.2s ease; border: none; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: #0b5ed7; }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: #157347; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #bb2d3b; }
        .btn-warning { background-color: var(--warning-color); color: #000;}
        .btn-warning:hover { background-color: #ffcd39; }
        .btn-outline-danger { color: var(--danger-color); border-color: var(--danger-color); }
        .btn-outline-danger:hover { background-color: var(--danger-color); color: white; }
        .btn-info { background-color: #0dcaf0; }
        .btn-info:hover { background-color: #31d2f2; }
        .form-control, .form-select, .form-check-input { border-radius: var(--border-radius); border: 1px solid #ddd; }
        .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .form-check-input:checked { background-color: var(--primary-color); border-color: var(--primary-color); }
        .nav-pills .nav-link { border-radius: var(--border-radius); color: var(--text-color); }
        .nav-pills .nav-link.active, .nav-pills .show>.nav-link { background-color: var(--primary-color); color: white; }
        .table-hover tbody tr { cursor: pointer; }
        .table-hover tbody tr:hover { background-color: #eef5ff; transform: scale(1.01); transition: all 0.2s ease-in-out; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        thead { background-color: var(--header-bg); }
        #main-dashboard { display: none; }
        .history-import { border-left: 5px solid var(--success-color); }
        .history-export { border-left: 5px solid #0dcaf0; }
        .history-adjustment { border-left: 5px solid var(--warning-color); }
        .history-reversal { border-left: 5px solid var(--danger-color); background-color: #fff5f5; }
        .suggestions-container { z-index: 1050; }
        .suggestions-container a:hover { background-color: var(--primary-color); color: white; }
        .filter-card { overflow: visible; }
        .refresh-note {
            position: fixed;
            bottom: 15px;
            right: 15px;
            padding: 8px 12px;
            background-color: #e7f1ff;
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1100;
            display: flex;
            align-items: center;
            font-size: 0.8rem;
        }
        .small-text { font-size: 0.85rem; color: #6c757d; }
        .announcement-card {
            border-left: 5px solid var(--primary-color);
            background-color: #e7f1ff;
        }
        .announcement-card .card-header {
            background-color: #d0e7ff;
            color: var(--primary-color);
            font-weight: bold;
        }
        .announcement-card .card-body {
            font-size: 0.95rem;
        }
        .announcement-card .card-footer {
            font-size: 0.8rem;
            color: var(--secondary-color);
            background-color: #e7f1ff;
            border-top: 1px solid #c0d8f7;
        }
        #export-lots-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .variance-positive { color: var(--success-color); font-weight: bold; }
        .variance-negative { color: var(--danger-color); font-weight: bold; }
    </style>
</head>
<body>

    <!-- Login Page -->
    <!-- Login Page -->
    <div id="login-page" class="container">
        <div class="login-container position-relative">
            <!-- Manual Download Buttons Container -->
            <div class="position-absolute top-0 end-0 p-3" style="z-index: 100;">
                <div class="dropdown">
                    <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="manualsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-question-circle-fill me-1"></i> คู่มือการใช้งาน
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="manualsDropdown">
                        <li>
                            <a class="dropdown-item" href="https://drive.google.com/uc?id=1tOAPkgK9a8D4ebDqA8wl8-sNrAmr-NKk" download="คู่มือการใช้งานระบบสต็อกสินค้า FG.pdf">
                                <i class="bi bi-file-earmark-pdf-fill me-2"></i>คู่มือระบบ STOCK FG
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="https://drive.google.com/uc?id=1EX3Bcd7KTKkXdEaGVOb7g8Xo-PTzPCPf" download="คู่มือการรับเข้าสินค้า.pdf">
                                <i class="bi bi-file-earmark-pdf-fill me-2"></i>คู่มือระบบ ERP
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- END NEW -->

            <!-- NEW LAYOUT: Logo on Left, Form on Right -->
            <div class="row w-100 align-items-center justify-content-center">
                <!-- Left Column: Logo & Welcome Text (Hidden on small screens) -->
                <div class="col-md-6 col-lg-6 text-center d-none d-md-block px-5">
                    <img src="https://raw.githubusercontent.com/admin1234881/Stockfg/main/291315_logo_20230216140112%20(1).jpeg" alt="Company Logo" class="mb-4" style="max-width: 180px; height: auto; border-radius: 8px;">
                    <h1 class="display-5 fw-bold" style="color: var(--primary-color);">ATECH FG STOCK</h1>
                    <p class="lead text-muted">ระบบบริหารจัดการสต็อกสินค้าสำเร็จรูป</p>
                </div>

                <!-- Right Column: Login Form -->
                <div class="col-md-6 col-lg-5">
                    <div class="card shadow-lg">
                        <div class="card-header card-header-custom p-3 text-center">
                            <h3><i class="bi bi-box-seam-fill me-2"></i><span data-lang-key="login_header">ระบบสต็อกสินค้า</span></h3>
                            <h4 class="fw-normal">ATECH FG</h4>
                        </div>
                        <div class="card-body p-4">
                            <form id="login-form">
                                <div class="mb-3">
                                    <label for="username" class="form-label" data-lang-key="username_label">ชื่อผู้ใช้</label>
                                    <input type="text" class="form-control" id="username" required autocomplete="off">
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label" data-lang-key="password_label">รหัสผ่าน</label>
                                    <input type="password" class="form-control" id="password" required autocomplete="off">
                                </div>
                                <div id="error-message" class="text-danger mb-3 d-none" data-lang-key="login_error">ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง</div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary"><span data-lang-key="login_button">เข้าสู่ระบบ</span> <i class="bi bi-arrow-right-circle-fill"></i></button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Main Dashboard -->
<div id="main-dashboard" class="container-fluid px-4 pb-4 pt-0">
        <!-- NEW: Wrapper for sticky elements -->
        <div style="position: sticky; top: 0; z-index: 1020; background-color: var(--bg-color); padding-top: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <header class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                <h1 class="h4"><i class="bi bi-box2-heart-fill me-2" style="color: var(--primary-color);"></i>STOCK IN-OUT FG</h1>
                <div class="d-flex align-items-center">
                    <!-- Language Switcher -->
                    <div class="dropdown me-3">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="language-switcher" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-translate me-1"></i> <span id="language-switcher-label">ภาษา</span>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="language-switcher">
                            <li><a class="dropdown-item" href="#" onclick="setLanguage('th')">ไทย</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setLanguage('en')">English</a></li>
                        </ul>
                    </div>
                    <span id="user-role" class="badge rounded-pill me-2 fs-6 align-middle"></span>
                    <button id="logout-btn" class="btn btn-outline-danger btn-sm"><i class="bi bi-box-arrow-right me-1"></i><span data-lang-key="logout_button">ออกจากระบบ</span></button>
                </div>
            </header>

            <!-- Navigation Tabs -->
            <ul class="nav nav-pills nav-fill mb-4" id="pills-tab" role="tablist">
                <li class="nav-item m-1" role="presentation">
                    <button class="nav-link active" id="pills-stock-tab" data-bs-toggle="pill" data-bs-target="#pills-stock" type="button" role="tab"><i class="bi bi-house-heart-fill me-2"></i><span data-lang-key="nav_stock">สต็อกคงเหลือ</span></button>
                </li>
                <!-- NEW: Dashboard Tab -->
                <li class="nav-item m-1" role="presentation">
                    <button class="nav-link" id="pills-dashboard-tab" data-bs-toggle="pill" data-bs-target="#pills-dashboard" type="button" role="tab"><i class="bi bi-speedometer2 me-2"></i><span data-lang-key="nav_dashboard">แดชบอร์ด</span></button>
                </li>
                <li class="nav-item m-1" role="presentation" id="nav-import-item">
                    <button class="nav-link" id="pills-import-tab" data-bs-toggle="pill" data-bs-target="#pills-import" type="button" role="tab"><i class="bi bi-arrow-down-square-fill me-2"></i><span data-lang-key="nav_import">รับเข้าสินค้า</span></button>
                </li>
                <li class="nav-item m-1" role="presentation" id="nav-export-item">
                    <button class="nav-link" id="pills-export-tab" data-bs-toggle="pill" data-bs-target="#pills-export" type="button" role="tab"><i class="bi bi-arrow-up-square-fill me-2"></i><span data-lang-key="nav_export">ส่งออกสินค้า</span></button>
                </li>
                <li class="nav-item m-1" role="presentation" id="nav-history-item">
                    <button class="nav-link" id="pills-history-tab" data-bs-toggle="pill" data-bs-target="#pills-history" type="button" role="tab"><i class="bi bi-clock-history me-2"></i><span data-lang-key="nav_history">ประวัติ</span></button>
                </li>
                <li class="nav-item m-1" role="presentation" id="nav-stock-count-item">
                    <button class="nav-link" id="pills-stock-count-tab" data-bs-toggle="pill" data-bs-target="#pills-stock-count" type="button" role="tab"><i class="bi bi-clipboard2-check-fill me-2"></i><span data-lang-key="nav_stock_count">นับสต็อก</span></button>
                </li>
                <li class="nav-item m-1" role="presentation" id="nav-products-item">
                    <button class="nav-link" id="pills-products-tab" data-bs-toggle="pill" data-bs-target="#pills-products" type="button" role="tab"><i class="bi bi-box-seam me-2"></i><span data-lang-key="nav_products">จัดการสินค้า</span></button>
                </li>
                <li class="nav-item m-1" role="presentation" id="nav-users-item">
                    <button class="nav-link" id="pills-users-tab" data-bs-toggle="pill" data-bs-target="#pills-users" type="button" role="tab"><i class="bi bi-people-fill me-2"></i><span data-lang-key="nav_users">จัดการผู้ใช้</span></button>
                </li>
                <li class="nav-item m-1" role="presentation" id="nav-announcements-item">
                    <button class="nav-link" id="pills-announcements-tab" data-bs-toggle="pill" data-bs-target="#pills-announcements" type="button" role="tab"><i class="bi bi-megaphone-fill me-2"></i><span data-lang-key="nav_announcements">จัดการประกาศ</span></button>
                </li>
            </ul>
        </div>

        <div id="announcements-display-area" class="mb-4"></div>


        <!-- Tab Content -->
        <div class="tab-content" id="pills-tabContent">
            <!-- Stock Tab -->
            <div class="tab-pane fade show active" id="pills-stock" role="tabpanel">
                <div class="row">
                    <div class="col-lg-3" id="backup-card-container">
                        <div class="card mb-4">
                            <div class="card-header fw-bold"><i class="bi bi-cloud-arrow-down-fill me-2"></i><span data-lang-key="backup_title">สำรองข้อมูล</span></div>
                            <div class="card-body">
                                <p class="text-center mb-2" data-lang-key="backup_desc">ดาวน์โหลดข้อมูลต่างๆ เป็นไฟล์ CSV</p>
                                <div class="d-grid gap-2">
                                    <button id="backup-stock-btn" class="btn btn-info btn-sm"><i class="bi bi-archive-fill me-2"></i><span data-lang-key="backup_stock">ข้อมูลสต็อก</span></button>
                                    <button id="backup-products-btn" class="btn btn-info btn-sm"><i class="bi bi-box-seam-fill me-2"></i><span data-lang-key="backup_products">ข้อมูลสินค้า</span></button>
                                    <button id="backup-users-btn" class="btn btn-info btn-sm"><i class="bi bi-person-lines-fill me-2"></i><span data-lang-key="backup_users">ข้อมูลผู้ใช้</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-9" id="stock-content-column">
                        <div class="card mb-4">
                            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-table me-2"></i><span data-lang-key="stock_summary_title">สรุปยอดสต็อกสินค้าคงเหลือ</span></span>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="show-old-stock-filter">
                                    <label class="form-check-label" for="show-old-stock-filter" data-lang-key="stock_show_old_filter">แสดงเฉพาะสต็อกที่ผลิตเกิน 3 เดือน</label>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="input-group mb-3">
                                    <input type="text" id="stock-search-input" class="form-control" data-lang-key-placeholder="stock_search_placeholder" placeholder="ค้นหารหัสสินค้า, ชื่อสินค้า หรือลูกค้า...">
                                    <button class="btn btn-secondary" type="button" id="refresh-stock-summary-btn" title="Refresh Data"><i class="bi bi-arrow-clockwise"></i></button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead id="stock-summary-table-header"></thead>
                                        <tbody id="stock-summary-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

    <!-- Dashboard Tab (NEW) -->
    <div class="tab-pane fade" id="pills-dashboard" role="tabpanel">
        <div class="row g-4">
            <!-- Date Filter Card -->
            <div class="col-xl-4 col-lg-12">
                <div class="card h-100">
                    <div class="card-header fw-bold" data-lang-key="dashboard_filter_date_range_title">เลือกช่วงวันที่ดูยอดขาย</div>
                    <div class="card-body d-flex flex-column justify-content-center">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label for="dashboard-start-date" class="form-label small-text" data-lang-key="dashboard_filter_from">จากวันที่</label>
                                <input type="date" id="dashboard-start-date" class="form-control form-control-sm">
                            </div>
                            <div class="col-md-6">
                                <label for="dashboard-end-date" class="form-label small-text" data-lang-key="dashboard_filter_to">ถึงวันที่</label>
                                <input type="date" id="dashboard-end-date" class="form-control form-control-sm">
                            </div>
                            <div class="col-12 mt-3">
                                <button class="btn btn-primary w-100" id="dashboard-filter-btn" data-lang-key="dashboard_show_data">แสดงข้อมูล</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Stock Card -->
            <div class="col-xl-4 col-lg-6">
                <div class="card h-100 bg-primary-subtle text-primary-emphasis">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title mb-2" data-lang-key="dashboard_total_stock_value_title">มูลค่าสต็อกสินค้าทั้งหมด</h5>
                                <h2 class="card-text fw-bold" id="dashboard-total-stock-quantity">...</h2>
                                <small class="text-muted" id="dashboard-total-stock-value">...</small>
                            </div>
                            <i class="bi bi-currency-dollar" style="font-size: 3rem;"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Sales Card -->
            <div class="col-xl-4 col-lg-6">
                <div class="card h-100 bg-success-subtle text-success-emphasis">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title mb-2" data-lang-key="dashboard_total_sales_title">ยอดขายทั้งหมด (ช่วงวันที่)</h5>
                                <h2 class="card-text fw-bold" id="dashboard-total-sales-quantity">...</h2>
                                <small class="text-muted" id="dashboard-total-sales-value">...</small>
                            </div>
                            <i class="bi bi-graph-up-arrow" style="font-size: 3rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Autopart Sales Card -->
            <div class="col-xl-6 col-lg-6">
                <div class="card h-100" style="background-color: #fff3cd; color: #664d03;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title mb-2" data-lang-key="dashboard_autopart_sales_title">ยอดขาย Autopart (ช่วงวันที่)</h5>
                                <h2 class="card-text fw-bold" id="dashboard-autopart-sales-quantity">...</h2>
                                <small id="dashboard-autopart-sales-value">...</small>
                            </div>
                            <i class="bi bi-car-front-fill" style="font-size: 3rem;"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Electronic Sales Card -->
            <div class="col-xl-6 col-lg-6">
                <div class="card h-100" style="background-color: #cfe2ff; color: #0a3675;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title mb-2" data-lang-key="dashboard_electronic_sales_title">ยอดขาย Electronic (ช่วงวันที่)</h5>
                                <h2 class="card-text fw-bold" id="dashboard-electronic-sales-quantity">...</h2>
                                <small id="dashboard-electronic-sales-value">...</small>
                            </div>
                            <i class="bi bi-cpu-fill" style="font-size: 3rem;"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Summary by Customer Table -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header fw-bold" data-lang-key="dashboard_sales_by_customer_title">สรุปยอดขายแยกตามลูกค้า (ช่วงวันที่)</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
			<thead>
    				<tr>
        		<th style="width: 5%;" data-lang-key="dashboard_rank">อันดับ</th>
        		<th data-lang-key="customer">ลูกค้า</th>
        		<th style="width: 15%;" data-lang-key="dashboard_type">ประเภท</th>
        		<th class="text-end" data-lang-key="dashboard_sales_qty">ยอดขาย (จำนวน)</th>
        		<th class="text-center" style="width: 35%;" data-lang-key="dashboard_sales_value">ยอดขาย (มูลค่า)</th>
    			</tr>
			</thead>
                                <tbody id="dashboard-sales-table">
                                    <tr><td colspan="5" class="text-center text-muted p-4">กรุณาเลือกช่วงวันที่แล้วกด "แสดงข้อมูล"</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
            <!-- Import Tab -->
            <div class="tab-pane fade" id="pills-import" role="tabpanel">
                <div class="card">
                    <div class="card-header fw-bold"><i class="bi bi-box-arrow-in-down me-2"></i><span data-lang-key="import_form_title">ฟอร์มรับเข้าสินค้า</span></div>
                    <div class="card-body">
                        <form id="import-form" class="row g-3"></form>
                    </div>
                </div>
            </div>

            <!-- Export Tab -->
            <div class="tab-pane fade" id="pills-export" role="tabpanel">
                <div class="card">
                    <div class="card-header fw-bold"><i class="bi bi-box-arrow-up me-2"></i><span data-lang-key="export_form_title">ฟอร์มส่งออกสินค้า</span></div>
                    <div class="card-body">
                        <form id="export-form" class="row g-3"></form>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div class="tab-pane fade" id="pills-history" role="tabpanel">
                <div class="card mb-3 filter-card">
                    <div class="card-body" style="background-color: #fdf2f5;">
                        <form id="history-filter-form" class="row g-3 align-items-end"></form>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-list-ol me-2"></i>
                            <span data-lang-key="history_table_title">ประวัติการทำรายการ</span>
                            <span id="history-total-quantity" class="badge bg-primary ms-2"></span>
                        </div>
                        <button id="backup-history-btn" class="btn btn-info btn-sm"><i class="bi bi-download me-1"></i><span data-lang-key="backup_history">ดาวน์โหลดประวัติ (CSV)</span></button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead id="history-table-header"></thead>
                                <tbody id="history-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Stock Count Tab -->
            <div class="tab-pane fade" id="pills-stock-count" role="tabpanel">
                <div id="stock-count-main-view">
                    <!-- This will be populated by JavaScript -->
                </div>
            </div>

            <!-- Product Management Tab -->
            <div class="tab-pane fade" id="pills-products" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header fw-bold"><i class="bi bi-pencil-square me-2"></i><span data-lang-key="product_form_title">ฟอร์มข้อมูลสินค้า</span></div>
                            <div class="card-body">
                                <form id="product-form" class="row g-3"></form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header fw-bold"><i class="bi bi-card-list me-2"></i><span data-lang-key="product_table_title">รายการสินค้าทั้งหมด</span></div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead id="product-management-table-header"></thead>
                                        <tbody id="product-management-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management Tab -->
            <div class="tab-pane fade" id="pills-users" role="tabpanel">
                <div class="row">
                    <div class="col-lg-5 mb-4">
                        <div class="card">
                            <div class="card-header fw-bold"><i class="bi bi-person-plus-fill me-2"></i><span data-lang-key="user_form_title">ฟอร์มข้อมูลผู้ใช้</span></div>
                            <div class="card-body">
                                <form id="user-form" class="row g-3"></form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-7">
                        <div class="card">
                            <div class="card-header fw-bold"><i class="bi bi-list-ul me-2"></i><span data-lang-key="user_table_title">รายการผู้ใช้ทั้งหมด</span></div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead id="user-management-table-header"></thead>
                                        <tbody id="user-management-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Announcement Management Tab -->
            <div class="tab-pane fade" id="pills-announcements" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header fw-bold"><i class="bi bi-megaphone me-2"></i><span data-lang-key="announcement_form_title">สร้าง/แก้ไขประกาศ</span></div>
                            <div class="card-body">
                                <form id="announcement-form" class="row g-3"></form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header fw-bold"><i class="bi bi-card-list me-2"></i><span data-lang-key="announcement_table_title">รายการประกาศทั้งหมด</span></div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead id="announcement-management-table-header"></thead>
                                        <tbody id="announcement-management-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="lotDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content" style="border-radius: var(--border-radius);">
                <div class="modal-header" style="background-color: #e7f1ff;">
                    <h5 class="modal-title" id="lotDetailModalLabel"><i class="bi bi-card-list me-2"></i><span data-lang-key="lot_modal_title">รายละเอียดล็อตของ</span>: <span id="modal-product-name" class="fw-bold"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table align-middle">
                        <thead id="lot-detail-table-header"></thead>
                        <tbody id="lot-detail-table"></tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-lang-key="close_button">ปิด</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="editStockModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: var(--border-radius);">
                <div class="modal-header" style="background-color: #fffbe6;">
                    <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i><span data-lang-key="edit_stock_modal_title">ปรับยอดสต็อกด้วยตนเอง</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-stock-form"></form>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Count Modal (for counting) -->
    <div class="modal fade" id="stockCountModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--header-bg);">
                    <h5 class="modal-title" id="stockCountModalLabel"><i class="bi bi-clipboard2-check-fill me-2"></i><span data-lang-key="stock_count_modal_title">บันทึกการนับสต็อก</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="stockCountModalBody">
                    <!-- Content will be populated by JS -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-lang-key="cancel_button">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" id="save-stock-count-btn"><i class="bi bi-save-fill me-2"></i><span data-lang-key="stock_count_save_button">บันทึกผลการนับ</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Count Report Modal (for viewing/approving) -->
    <div class="modal fade" id="stockCountReportModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #e6fff3;">
                    <h5 class="modal-title" id="stockCountReportModalLabel"><i class="bi bi-file-earmark-spreadsheet-fill me-2"></i><span data-lang-key="stock_count_report_title">รายงานผลการนับสต็อก</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="stockCountReportModalBody">
                    <!-- Content will be populated by JS -->
                </div>
                <div class="modal-footer" id="stockCountReportModalFooter">
                    <!-- Buttons will be populated by JS -->
                </div>
            </div>
        </div>
    </div>

        
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
    // --- TRANSLATION OBJECT ---
    const translations = {
        th: {
            // General
            username_label: "ชื่อผู้ใช้",
            password_label: "รหัสผ่าน",
            product_id: "รหัสสินค้า",
            product_name: "ชื่อสินค้า",
            customer: "ลูกค้า",
            erp_code: "รหัส ERP",
            quantity: "จำนวน",
            production_date: "วันที่ผลิต",
            remarks: "หมายเหตุ",
            actions: "ดำเนินการ",
            save_button: "บันทึก",
            clear_form_button: "ล้างฟอร์ม",
            close_button: "ปิด",
            search_placeholder: "ค้นหา...",
            ok_button: "ตกลง",
            cancel_button: "ยกเลิก",
            packaging_type: "ประเภทบรรจุภัณฑ์",
            packaging_std: "แพ็คกิ้งสแตนดาร์ด",
            packaging_temp: "แพ็คกิ้งชั่วคราว",
            packaging_placeholder: "-- เลือกประเภท --", 
            // Login
            login_header: "ระบบสต็อกสินค้า",
            login_button: "เข้าสู่ระบบ",
            login_error: "ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง",
            // Header & Nav
            logout_button: "ออกจากระบบ",
            confirm_logout_title: "ยืนยันการออกจากระบบ?",
            nav_stock: "สต็อกคงเหลือ",
            nav_import: "รับเข้าสินค้า",
            nav_export: "ส่งออกสินค้า",
            nav_history: "ประวัติ",
            nav_stock_count: "นับสต็อก",
            nav_products: "จัดการสินค้า",
            nav_users: "จัดการผู้ใช้",
            nav_announcements: "จัดการประกาศ",
            // NEW: Dashboard
            nav_dashboard: "แดชบอร์ด",
            dashboard_total_stock_value_title: "มูลค่าสต็อกสินค้าทั้งหมด",
            dashboard_total_sales_title: "ยอดขายทั้งหมด (ช่วงวันที่)",
            dashboard_sales_by_customer_title: "สรุปยอดขายแยกตามลูกค้า (ช่วงวันที่)",
            dashboard_filter_date_range_title: "เลือกช่วงวันที่ดูยอดขาย",
            dashboard_filter_from: "จากวันที่",
            dashboard_filter_to: "ถึงวันที่",
            dashboard_show_data: "แสดงข้อมูล",
            dashboard_sales_qty: "ยอดขาย (จำนวน)",
            dashboard_sales_value: "ยอดขาย (มูลค่า)",
            dashboard_no_sales_data: "ไม่พบข้อมูลยอดขายสำหรับช่วงวันที่ที่เลือก",
            dashboard_qty_label: "จำนวน: ", // NEW
            dashboard_pieces_label: " ชิ้น", // NEW
	        dashboard_autopart_sales_title: "ยอดขาย Autopart (ช่วงวันที่)",
	        dashboard_electronic_sales_title: "ยอดขาย Electronic (ช่วงวันที่)",	   
	    dashboard_rank: "อันดับ",
	    dashboard_type: "ประเภท",
	    dashboard_initial_prompt: "กรุณาเลือกช่วงวันที่แล้วกด \"แสดงข้อมูล\"",
	    dashboard_customer_unspecified: "ไม่ระบุลูกค้า",
	    dashboard_type_autopart: "Autopart",
	    dashboard_type_electronic: "Electronic",
	    dashboard_type_other: "อื่นๆ",
            // Stock Tab
            backup_title: "สำรองข้อมูล",
            backup_desc: "ดาวน์โหลดข้อมูลต่างๆ เป็นไฟล์ CSV",
            backup_stock: "ข้อมูลสต็อก",
            backup_products: "ข้อมูลสินค้า",
            backup_users: "ข้อมูลผู้ใช้",
            stock_summary_title: "สรุปยอดสต็อกสินค้าคงเหลือ",
            stock_show_old_filter: "แสดงเฉพาะสต็อกที่ผลิตเกิน 3 เดือน",
            stock_search_placeholder: "ค้นหารหัสสินค้า, ชื่อสินค้า หรือลูกค้า...",
            stock_table_product: "รหัส/ชื่อสินค้า",
            stock_table_balance: "ยอดคงเหลือทั้งหมด",
            // Import Tab
            import_form_title: "ฟอร์มรับเข้าสินค้า",
            import_add_lot_button: "เพิ่มล็อตวันที่ผลิต",
            import_total_quantity: "ยอดรวมที่จะรับเข้า",
            import_fullbox: "จำนวนเต็มกล่อง",
            import_quantity: "จำนวนที่รับเข้า",
            import_warning: "เช็ควันที่รับเข้าจากชิ้นงานให้ดีก่อนรับเข้า",
            import_save_button: "บันทึกการรับเข้า",
            // Export Tab
            export_form_title: "ฟอร์มส่งออกสินค้า",
            export_total_quantity: "ยอดรวมที่จะส่งออก",
            export_lot_select: "ล็อตวันที่ผลิต",
            export_quantity: "จำนวนที่ส่งออก",
            export_invoice: "เลขที่ Invoice",
            export_warning: "การส่งออกสินค้าควรคำนึงถึงหลัก FIFO (เข้าก่อน-ออกก่อน)",
            export_save_button: "บันทึกการส่งออก",
            export_temp_confirm_title: "ยืนยันการส่งออก?",
            export_temp_confirm_text: "คุณกำลังจะส่งออกสินค้าที่เป็น 'แพ็คกิ้งชั่วคราว' ยืนยันที่จะดำเนินการต่อใช่ไหม?",
	        export_type_label: "ประเภทการส่งออก",
                export_type_sale: "ขายสินค้า (Sale)",
                export_type_production: "เบิกโดยฝ่ายผลิต (Production)",
                export_type_qc: "เบิกโดย QC (QC)",
                export_type_other: "อื่นๆ (Other)",
                error_invoice_required_for_sale: "กรุณากรอกเลขที่ Invoice สำหรับการขายสินค้า",
            // History Tab
            history_filter_from: "จากวันที่",
            history_filter_to: "ถึงวันที่",
            history_filter_type: "ประเภท",
            history_filter_product: "สินค้า",
            history_filter_invoice: "เลขที่ Invoice",
            history_filter_search: "ค้นหา",
            history_filter_clear: "ล้าง",
            history_filter_type_all: "ทั้งหมด",
            history_filter_type_import: "รับเข้า",
            history_filter_type_export: "ส่งออก",
            history_filter_type_adjustment: "ปรับปรุงยอด",
            history_filter_type_reversal: "ยกเลิกรายการ",
            history_table_title: "ประวัติการทำรายการ",
            backup_history: "ดาวน์โหลดประวัติ (CSV)",
            history_table_type: "ประเภท",
            history_table_packaging: "ประเภทบรรจุภัณฑ์",
            history_table_invoice_remarks: "Invoice / หมายเหตุ",
            history_table_timestamp: "วันที่ทำรายการ",
            history_table_user: "ผู้ทำรายการ",
            // Stock Count Tab
            stock_count_title: "การนับสต็อก",
            stock_count_start_button: "เริ่มนับสต็อกใหม่",
            stock_count_history_title: "ประวัติการนับสต็อก",
            stock_count_modal_title: "บันทึกการนับสต็อก",
            stock_count_save_button: "บันทึกผลการนับ",
            stock_count_system_qty: "ยอดในระบบ",
            stock_count_counted_qty: "ยอดที่นับได้",
            stock_count_table_id: "รหัสการนับ",
            stock_count_table_date: "วันที่นับ",
            stock_count_table_user: "ผู้ดำเนินการ",
            stock_count_table_status: "สถานะ",
            stock_count_status_pending: "รอตรวจสอบ",
            stock_count_status_approved: "อนุมัติแล้ว",
            stock_count_report_title: "รายงานผลการนับสต็อก",
            stock_count_variance: "ผลต่าง",
            stock_count_approve_button: "ยืนยันการปรับยอด",
            stock_count_confirm_approve_title: "ยืนยันการปรับยอด?",
            stock_count_confirm_approve_text: "ระบบจะสร้างรายการ 'ปรับปรุงยอด' ในประวัติเพื่อทำให้ยอดสต็อกตรงกับยอดที่นับได้",
            stock_count_adjustment_remark: "ปรับยอดจากการนับสต็อก {countId} (นับโดย: {countedBy})",
            stock_count_no_history: "ยังไม่มีประวัติการนับสต็อก",
            stock_count_approve_error_already_approved: "รายการนับสต็อกนี้ได้รับการอนุมัติไปแล้ว",
            stock_count_approve_success: "อนุมัติและปรับยอดสต็อกเรียบร้อยแล้ว",
            // Product Management
            product_form_title: "ฟอร์มข้อมูลสินค้า",
            product_fullbox_rack: "จำนวนเต็มกล่อง/แร็ค",
            product_unit_price: "ราคาต่อหน่วย",
            product_save_button: "บันทึกข้อมูลสินค้า",
            product_table_title: "รายการสินค้าทั้งหมด",
            product_table_price: "ราคา/หน่วย",
            // User Management
            user_form_title: "ฟอร์มข้อมูลผู้ใช้",
            user_role: "สิทธิ์",
            user_permissions: "สิทธิ์การใช้งาน",
            permission_canImport: "รับเข้าสินค้า",
            permission_canExport: "ส่งออกสินค้า",
            permission_canViewHistory: "ดูประวัติ",
            permission_canCountStock: "นับสต็อก",
            permission_canManageProducts: "จัดการสินค้า",
            permission_canManageUsers: "จัดการผู้ใช้",
            permission_canManageAnnouncements: "จัดการประกาศ",
            user_save_button: "บันทึกข้อมูลผู้ใช้",
            user_table_title: "รายการผู้ใช้ทั้งหมด",
            // Announcement Management
            announcement_form_title: "สร้าง/แก้ไขประกาศ",
            announcement_title: "หัวข้อประกาศ",
            announcement_message: "ข้อความประกาศ",
            announcement_show: "แสดงประกาศนี้",
            announcement_save_button: "บันทึกประกาศ",
            announcement_table_title: "รายการประกาศทั้งหมด",
            announcement_table_header_title: "หัวข้อ",
            announcement_table_status: "สถานะ",
            announcement_table_posted_by: "ผู้ประกาศ",
            announcement_table_posted_date: "วันที่ประกาศ",
            // Modals
            lot_modal_title: "รายละเอียดล็อตของ",
            lot_modal_balance: "จำนวนคงเหลือ",
            edit_stock_modal_title: "ปรับยอดสต็อกด้วยตนเอง",
            edit_stock_new_total: "ยอดรวมใหม่",
            edit_stock_note: "การบันทึกจะสร้างรายการ 'ปรับปรุงยอด' ใหม่ในประวัติ",
            edit_stock_save_button: "บันทึกยอดใหม่",
            edit_stock_confirm_title: "ยืนยันการปรับยอดสต็อก?",
            edit_stock_confirm_text: "A new transaction will be created to adjust the stock for product {productId} to {quantity} units.",
            // Refresh Note
            refresh_title: "รีเฟรช (F5)",
            refresh_desc: "เพื่อข้อมูลล่าสุด",
            // SweetAlerts
            loading: "กำลังโหลดข้อมูล...",
            saving: "กำลังบันทึกข้อมูล...",
            please_wait: "กรุณารอสักครู่ค่ะ",
            data_updated: "ข้อมูลอัปเดตแล้ว!",
            load_error_title: "โหลดข้อมูลไม่สำเร็จ!",
            load_error_text: "ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้ ({error}) กรุณาลองรีเฟรชหน้าเว็บใหม่อีกครั้ง",
            critical_load_error_title: "ข้อผิดพลาดร้ายแรงในการโหลดข้อมูล",
            critical_load_error_text: "เซิร์ฟเวอร์ส่งคืนข้อมูลที่สำคัญ (เช่น รายการสินค้า) ที่ว่างเปล่า แต่ข้อมูลเดิมยังมีอยู่ การดำเนินการถูกยกเลิกเพื่อป้องกันข้อมูลสูญหาย กรุณาติดต่อผู้ดูแลระบบ",
            save_error_title: "บันทึกข้อมูลไม่สำเร็จ!",
            save_error_text: "เกิดข้อผิดพลาดในการส่งข้อมูลไปบันทึก: {error}",
            background_save_error: "เกิดข้อผิดพลาดระหว่างการบันทึกเบื้องหลัง กรุณารีเฟรชหน้าเว็บเพื่อซิงค์ข้อมูล",
            session_expired_title: "หมดเวลาใช้งาน",
            session_expired_text: "ไม่มีการใช้งานระบบเกิน 30 นาที กรุณาลงชื่อเข้าใช้ใหม่",
            confirm_delete_title: "ยืนยันการลบถาวร?",
            confirm_delete_prompt: "โปรดพิมพ์ 'ลบ' เพื่อยืนยัน",
            confirm_delete_lot_text: "ล็อตทั้งหมดของสินค้า {productId} ที่ผลิตวันที่ {productionDate} จะถูกลบอย่างถาวร!",
            delete_lot_success: "ลบล็อตสินค้าตามวันที่เรียบร้อยแล้วค่ะ",
            delete_lot_error: "ไม่พบล็อตที่ต้องการลบ",
            confirm_delete_product_text: "สินค้า {productId} จะถูกลบออกจากระบบอย่างถาวร",
            delete_product_error: "ยังมีสินค้านี้อยู่ในสต็อกค่ะ",
            delete_product_success: "ลบสินค้าเรียบร้อยแล้ว",
            confirm_delete_user_text: "ผู้ใช้ {username} จะถูกลบออกจากระบบ",
            delete_user_admin_error: "ไม่สามารถลบผู้ใช้ admin หลักได้ค่ะ",
            delete_user_success: "ลบผู้ใช้เรียบร้อยแล้ว",
            confirm_reverse_history_title: "ยืนยันการยกเลิกรายการ?",
            reverse_history_export_text: "การดำเนินการนี้จะคืนสินค้ากลับเข้าสต็อก และไม่สามารถย้อนกลับได้",
            reverse_history_import_text: "การดำเนินการนี้จะหักสินค้าออกจากสต็อก และไม่สามารถย้อนกลับได้",
            reverse_history_import_error_not_enough: "สต็อกในล็อตนี้ถูกใช้ไปแล้ว ไม่สามารถยกเลิกรายการรับเข้าได้",
            reverse_history_success: "ยกเลิกรายการและปรับสต็อกเรียบร้อย",
            reverse_history_find_error: "ไม่พบรายการที่ต้องการยกเลิก อาจเกิดจากข้อมูลกำลังซิงค์ กรุณารอสักครู่แล้วลองใหม่อีกครั้ง",
            // Dynamic texts
            user_role_display: "สิทธิ์: {role}",
            history_total_quantity_display: "ยอดรวม: {total}",
            no_history_found_message: "กรุณาใส่ข้อมูลเพื่อค้นหาประวัติการทำรายการค่ะ",
            history_no_transactions_yet: "ยังไม่มีประวัติการทำรายการค่ะ",
            no_history_for_filter_message: "ไม่พบข้อมูลตามเงื่อนไขที่กำหนดค่ะ",
            history_type_import: "รับเข้า",
            history_type_export: "ส่งออก",
            history_type_adjustment: "ปรับปรุงยอด",
            history_type_reversal: "ยกเลิก",
            announcement_status_active: "ใช้งานอยู่",
            announcement_status_inactive: "ไม่ใช้งาน",
            announcement_posted_by_on: "ประกาศโดย: {user} เมื่อ: {date}",
            announcement_badge: "ประกาศ",
            export_lot_placeholder_select: "-- เลือกล็อตตามวันที่ผลิต --",
            export_lot_placeholder_no_product: "-- กรุณาเลือกสินค้าก่อน --",
            export_lot_placeholder_no_stock: "-- สินค้าหมดสต็อกแล้วจ้า --",
            export_lot_option: "วันที่ผลิต: {date} (เหลือทั้งหมด: {qty})",
            export_quantity_placeholder: "สูงสุด: {qty}",
            product_not_found: "(ไม่มีข้อมูลสินค้า {id})",
            stock_summary_no_results: "ไม่พบสินค้าที่ตรงกับการค้นหาค่ะ",
            stock_summary_no_old_stock: "ไม่พบสต็อกที่เก่ากว่า 3 เดือนค่ะ",
            stock_summary_no_stock: "ยังไม่มีข้อมูลสต็อกเลยจ้า",
            lot_modal_no_data: "ไม่พบข้อมูลล็อตสำหรับสินค้านี้",
            product_management_no_data: "ยังไม่มีข้อมูลสินค้าค่ะ",
            user_management_no_data: "ยังไม่มีข้อมูลผู้ใช้ค่ะ",
            announcement_management_no_data: "ยังไม่มีประกาศค่ะ",
            form_incomplete: "ข้อมูลไม่ครบถ้วน",
            product_name_required: "กรุณาระบุชื่อสินค้า",
            export_data_incomplete: "กรุณาเลือกสินค้า, วันที่ผลิต, และระบุจำนวนที่ต้องการส่งออก",
            export_no_stock_for_date: "ไม่พบสต็อกสำหรับวันที่ผลิตที่เลือก",
            export_not_enough: "มีสินค้าในสต็อกสำหรับวันที่นี้เพียง {qty} ชิ้น",
            product_id_exists: "มีรหัสสินค้านี้ในระบบแล้วค่ะ",
            username_exists: "มีชื่อผู้ใช้นี้ในระบบแล้วค่ะ",
            user_not_found_for_edit: "ไม่พบผู้ใช้ที่ต้องการแก้ไข",
            history_not_found_for_edit: "ไม่พบประวัติที่ต้องการแก้ไข",
            history_edit_no_lot: "ไม่พบสต็อกล็อตเดิมของประวัติรายการนี้",
            history_edit_not_enough: "ไม่สามารถแก้ไขจำนวนได้ สต็อกคงเหลือในล็อตนี้ (รวมที่คืน) มีเพียง {qty} ชิ้น",
            history_edit_import_not_enough: "ไม่สามารถลดจำนวนรับเข้าให้ต่ำกว่า {qty} ชิ้นได้ เนื่องจากมีสินค้าจำนวนดังกล่าวถูกใช้ไปแล้ว",
            product_not_found_error: "ไม่พบสินค้า",
            success_title: "เรียบร้อย!",
            import_success: "รับสินค้า {name} เข้ามาแล้วจ้า",
            export_success: "ส่งออกสินค้า {name} เรียบร้อยแล้วค่ะ",
            product_update_success: "อัปเดตข้อมูลสินค้าเรียบร้อย",
            product_add_success: "เพิ่มสินค้าใหม่เรียบร้อย",
            user_add_success: "เพิ่มผู้ใช้ใหม่เรียบร้อย",
            user_update_success: "อัปเดตข้อมูลผู้ใช้เรียบร้อย",
            history_edit_success: "แก้ไขประวัติเรียบร้อย",
            stock_update_success: "ปรับปรุงยอดสต็อกเรียบร้อย",
            announcement_update_success: "อัปเดตประกาศเรียบร้อยแล้ว",
            announcement_add_success: "เพิ่มประกาศใหม่เรียบร้อยแล้ว",
            announcement_status_update_success: "อัปเดตสถานะประกาศเรียบร้อยแล้ว",
            backup_no_data: "ไม่สามารถสำรองข้อมูลที่ว่างเปล่าได้ค่ะ",
            backup_downloading: "กำลังดาวน์โหลดไฟล์ {filename}",
            future_date_error: "ไม่สามารถเลือกวันที่ผลิตล่วงหน้าได้ค่ะ",
            fifo_warning_title: "ยืนยันการส่งมอบ?",
            fifo_warning_text: "ล็อตวันที่ {date} (เก่าที่สุด) ยังมียอดคงเหลืออยู่ คุณยืนยันที่จะส่งมอบล็อตที่ใหม่กว่าใช่ไหม?"
        },
        en: {
            // General
            username_label: "Username",
            password_label: "Password",
            product_id: "Product ID",
            product_name: "Product Name",
            customer: "Customer",
            erp_code: "ERP Code",
            quantity: "Quantity",
            production_date: "Production Date",
            remarks: "Remarks",
            actions: "Actions",
            save_button: "Save",
            clear_form_button: "Clear Form",
            close_button: "Close",
            search_placeholder: "Search...",
            ok_button: "OK",
            cancel_button: "Cancel",
            packaging_type: "Packaging Type",
            packaging_std: "Standard Packing",
            packaging_temp: "Temporary Packing",
            packaging_placeholder: "-- Select Type --",
            // Login
            login_header: "Stock System",
            login_button: "Login",
            login_error: "Incorrect username or password.",
            // Header & Nav
            logout_button: "Logout",
            confirm_logout_title: "Confirm Logout?",
            nav_stock: "Stock Balance",
            nav_import: "Import Goods",
            nav_export: "Export Goods",
            nav_history: "History",
            nav_stock_count: "Stock Count",
            nav_products: "Manage Products",
            nav_users: "Manage Users",
            nav_announcements: "Manage Announcements",
            // NEW: Dashboard
            nav_dashboard: "Dashboard",
            dashboard_total_stock_value_title: "Total Stock Value",
            dashboard_total_sales_title: "Total Sales (Date Range)",
            dashboard_sales_by_customer_title: "Sales Summary by Customer (Date Range)",
            dashboard_filter_date_range_title: "Select Date Range for Sales",
            dashboard_filter_from: "From Date",
            dashboard_filter_to: "To Date",
            dashboard_show_data: "Show Data",
            dashboard_sales_qty: "Sales (Quantity)",
            dashboard_sales_value: "Sales (Value)",
            dashboard_no_sales_data: "No sales data found for the selected date range.",
            dashboard_qty_label: "Quantity: ", // NEW
            dashboard_pieces_label: " pcs", // NEW
	        dashboard_autopart_sales_title: "Autopart Sales (Date Range)",
	        dashboard_electronic_sales_title: "Electronic Sales (Date Range)",
            // Stock Tab
            backup_title: "Backup Data",
            backup_desc: "Download various data as CSV files.",
            backup_stock: "Stock Data",
            backup_products: "Product Data",
            backup_users: "User Data",
            stock_summary_title: "Stock Balance Summary",
            stock_show_old_filter: "Show only stock older than 3 months",
            stock_search_placeholder: "Search Product ID, Name, or Customer...",
            stock_table_product: "Product ID/Name",
            stock_table_balance: "Total Balance",
            // Import Tab
            import_form_title: "Import Goods Form",
            import_add_lot_button: "Add Production Lot",
            import_total_quantity: "Total Import Quantity",
            import_fullbox: "Full Box Qty",
            import_quantity: "Import Quantity",
            import_warning: "Please double-check the production date on the product before importing.",
            import_save_button: "Save Import",
            // Export Tab
            export_form_title: "Export Goods Form",
            export_total_quantity: "Total Export Quantity",
            export_lot_select: "Production Date Lot",
            export_quantity: "Export Quantity",
            export_invoice: "Invoice No.",
            export_warning: "Exports should follow the FIFO (First-In, First-Out) principle.",
            export_save_button: "Save Export",
            export_temp_confirm_title: "Confirm Export?",
            export_temp_confirm_text: "You are about to export an item with 'Temporary Packing'. Are you sure you want to proceed?",	      
       	       export_type_label: "Export Type",
                export_type_sale: "Sale",
                export_type_production: "Production Withdrawal",
                export_type_qc: "QC Withdrawal",
                export_type_other: "Other",
                error_invoice_required_for_sale: "Please enter an Invoice Number for sales transactions.",
            // History Tab
            history_filter_from: "From Date",
            history_filter_to: "To Date",
            history_filter_type: "Type",
            history_filter_product: "Product",
            history_filter_invoice: "Invoice No.",
            history_filter_search: "Search",
            history_filter_clear: "Clear",
            history_filter_type_all: "All",
            history_filter_type_import: "Import",
            history_filter_type_export: "Export",
            history_filter_type_adjustment: "Adjustment",
            history_filter_type_reversal: "Reversal",
            history_table_title: "Transaction History",
            backup_history: "Download History (CSV)",
            history_table_type: "Type",
            history_table_packaging: "Packaging",
            history_table_invoice_remarks: "Invoice / Remarks",
            history_table_timestamp: "Timestamp",
            history_table_user: "User",
            // Stock Count Tab
            stock_count_title: "Stock Count",
            stock_count_start_button: "Start New Stock Count",
            stock_count_history_title: "Stock Count History",
            stock_count_modal_title: "Record Stock Count",
            stock_count_save_button: "Save Count Results",
            stock_count_system_qty: "System Qty",
            stock_count_counted_qty: "Counted Qty",
            stock_count_table_id: "Count ID",
            stock_count_table_date: "Count Date",
            stock_count_table_user: "Performed By",
            stock_count_table_status: "Status",
            stock_count_status_pending: "Pending Review",
            stock_count_status_approved: "Approved",
            stock_count_report_title: "Stock Count Report",
            stock_count_variance: "Variance",
            stock_count_approve_button: "Approve Adjustment",
            stock_count_confirm_approve_title: "Confirm Adjustment?",
            stock_count_confirm_approve_text: "This will create an 'Adjustment' entry in the history to match the counted quantity.",
            stock_count_adjustment_remark: "Adjustment from Stock Count {countId} (Counted by: {countedBy})",
            stock_count_no_history: "No stock count history yet.",
            stock_count_approve_error_already_approved: "This stock count has already been approved.",
            stock_count_approve_success: "Adjustment approved and stock updated successfully.",
            // Product Management
            product_form_title: "Product Information Form",
            product_fullbox_rack: "Full Box/Rack Qty",
            product_unit_price: "Unit Price",
            product_save_button: "Save Product Data",
            product_table_title: "All Products List",
            product_table_price: "Price/Unit",
            // User Management
            user_form_title: "User Information Form",
            user_role: "Role",
            user_permissions: "Permissions",
            permission_canImport: "Import Goods",
            permission_canExport: "Export Goods",
            permission_canViewHistory: "View History",
            permission_canCountStock: "Perform Stock Count",
            permission_canManageProducts: "Manage Products",
            permission_canManageUsers: "Manage Users",
            permission_canManageAnnouncements: "Manage Announcements",
            user_save_button: "Save User Data",
            user_table_title: "All Users List",
            // Announcement Management
            announcement_form_title: "Create/Edit Announcement",
            announcement_title: "Title",
            announcement_message: "Message",
            announcement_show: "Show this announcement",
            announcement_save_button: "Save Announcement",
            announcement_table_title: "All Announcements List",
            announcement_table_header_title: "Title",
            announcement_table_status: "Status",
            announcement_table_posted_by: "Posted By",
            announcement_table_posted_date: "Posted Date",
            // Modals
            lot_modal_title: "Lot Details for",
            lot_modal_balance: "Remaining Quantity",
            edit_stock_modal_title: "Manual Stock Adjustment",
            edit_stock_new_total: "New Total Quantity",
            edit_stock_note: "Saving will create a new 'Adjustment' entry in the history.",
            edit_stock_save_button: "Save New Total",
            edit_stock_confirm_title: "Confirm Stock Adjustment?",
            edit_stock_confirm_text: "A new transaction will be created to adjust the stock for product {productId} to {quantity} units.",
            // SweetAlerts
            loading: "Loading data...",
            saving: "Saving data...",
            please_wait: "Please wait",
            data_updated: "Data updated!",
            load_error_title: "Failed to Load Data!",
            load_error_text: "Could not connect to the database ({error}). Please try refreshing the page.",
            critical_load_error_title: "Critical Load Error",
            critical_load_error_text: "The server returned a critical empty data set (e.g., product list), but local data exists. The operation has been cancelled to prevent data loss. Please contact an administrator.",
            save_error_title: "Failed to Save Data!",
            save_error_text: "An error occurred while saving data: {error}",
            background_save_error: "An error occurred during the background save. Please refresh the page to sync data.",
            session_expired_title: "Session Expired",
            session_expired_text: "You have been inactive for over 30 minutes. Please log in again.",
            confirm_delete_title: "Confirm Permanent Deletion?",
            confirm_delete_prompt: "Please type 'delete' to confirm",
            confirm_delete_lot_text: "All lots for product {productId} produced on {productionDate} will be permanently deleted!",
            delete_lot_success: "Lots deleted successfully.",
            delete_lot_error: "Could not find the lots to delete.",
            confirm_delete_product_text: "Product {productId} will be permanently deleted from the system.",
            delete_product_error: "Cannot delete! This product is still in stock.",
            delete_product_success: "Product deleted successfully.",
            confirm_delete_user_text: "User {username} will be removed from the system.",
            delete_user_admin_error: "Cannot delete the main admin user.",
            delete_user_success: "User deleted successfully.",
            confirm_reverse_history_title: "Confirm Transaction Reversal?",
            reverse_history_export_text: "This action will return the items to stock and cannot be undone.",
            reverse_history_import_text: "This action will deduct the items from stock and cannot be undone.",
            reverse_history_import_error_not_enough: "Stock from this lot has already been used. Cannot reverse this import.",
            reverse_history_success: "Transaction reversed and stock adjusted successfully.",
            reverse_history_find_error: "Could not find the transaction to reverse. The data might be syncing. Please wait a moment and try again.",
            // Dynamic texts
            user_role_display: "Role: {role}",
            history_total_quantity_display: "Total: {total}",
            no_history_found_message: "Please provide filter criteria to search for transaction history.",
            history_no_transactions_yet: "No transaction history yet.",
            no_history_for_filter_message: "No data found for the specified criteria.",
            history_type_import: "Import",
            history_type_export: "Export",
            history_type_adjustment: "Adjustment",
            history_type_reversal: "Reversal",
            announcement_status_active: "Active",
            announcement_status_inactive: "Inactive",
            announcement_posted_by_on: "Posted by: {user} on: {date}",
            announcement_badge: "Announcement",
            export_lot_placeholder_select: "-- Select Production Lot --",
            export_lot_placeholder_no_product: "-- Please select a product first --",
            export_lot_placeholder_no_stock: "-- This product is out of stock --",
            export_lot_option: "Prod. Date: {date} (Available: {qty})",
            export_quantity_placeholder: "Max: {qty}",
            product_not_found: "(Product info not found for {id})",
            stock_summary_no_results: "No products match your search.",
            stock_summary_no_old_stock: "No stock older than 3 months found.",
            stock_summary_no_stock: "No stock data available yet.",
            lot_modal_no_data: "No lot data found for this product.",
            product_management_no_data: "No product data yet.",
            user_management_no_data: "No user data yet.",
            announcement_management_no_data: "No announcements yet.",
            form_incomplete: "Incomplete Information",
            product_name_required: "Please specify the product name.",
            export_data_incomplete: "Please select a product, production date, and specify the export quantity.",
            export_no_stock_for_date: "No stock found for the selected production date.",
            export_not_enough: "Only {qty} units are available in stock for this date.",
            product_id_exists: "This Product ID already exists in the system.",
            username_exists: "This username already exists in the system.",
            user_not_found_for_edit: "Could not find the user to edit.",
            history_not_found_for_edit: "Could not find the history record to edit.",
            history_edit_no_lot: "Original stock lot for this history record not found.",
            history_edit_not_enough: "Cannot edit quantity. Stock available in this lot (including returned items) is only {qty}.",
            history_edit_import_not_enough: "Cannot reduce import quantity below {qty}, as that many units have already been used.",
            product_not_found_error: "Product not found",
            success_title: "เรียบร้อย!",
            import_success: "Imported {name} successfully.",
            export_success: "Exported {name} successfully.",
            product_update_success: "Product information updated successfully.",
            product_add_success: "New product added successfully.",
            user_add_success: "New user added successfully.",
            user_update_success: "User information updated successfully.",
            history_edit_success: "History record edited successfully.",
            stock_update_success: "Stock total updated successfully.",
            announcement_update_success: "Announcement updated successfully.",
            announcement_add_success: "New announcement added successfully.",
            announcement_status_update_success: "Announcement status updated successfully.",
            backup_no_data: "Cannot back up empty data.",
            backup_downloading: "กำลังดาวน์โหลดไฟล์ {filename}",
            future_date_error: "ไม่สามารถเลือกวันที่ผลิตล่วงหน้าได้ค่ะ",
            fifo_warning_title: "ยืนยันการส่งมอบ?",
            fifo_warning_text: "ล็อตวันที่ {date} (เก่าที่สุด) ยังมียอดคงเหลืออยู่ คุณยืนยันที่จะส่งมอบล็อตที่ใหม่กว่าใช่ไหม?"
        },
        en: {
            // General
            username_label: "Username",
            password_label: "Password",
            product_id: "Product ID",
            product_name: "Product Name",
            customer: "Customer",
            erp_code: "ERP Code",
            quantity: "Quantity",
            production_date: "Production Date",
            remarks: "Remarks",
            actions: "Actions",
            save_button: "Save",
            clear_form_button: "Clear Form",
            close_button: "Close",
            search_placeholder: "Search...",
            ok_button: "OK",
            cancel_button: "Cancel",
            packaging_type: "Packaging Type",
            packaging_std: "Standard Packing",
            packaging_temp: "Temporary Packing",
            packaging_placeholder: "-- Select Type --",
            // Login
            login_header: "Stock System",
            login_button: "Login",
            login_error: "Incorrect username or password.",
            // Header & Nav
            logout_button: "Logout",
            confirm_logout_title: "Confirm Logout?",
            nav_stock: "Stock Balance",
            nav_import: "Import Goods",
            nav_export: "Export Goods",
            nav_history: "History",
            nav_stock_count: "Stock Count",
            nav_products: "Manage Products",
            nav_users: "Manage Users",
            nav_announcements: "Manage Announcements",
            // NEW: Dashboard
            nav_dashboard: "Dashboard",
            dashboard_total_stock_value_title: "Total Stock Value",
            dashboard_total_sales_title: "Total Sales (Date Range)",
            dashboard_sales_by_customer_title: "Sales Summary by Customer (Date Range)",
            dashboard_filter_date_range_title: "Select Date Range for Sales",
            dashboard_filter_from: "From Date",
            dashboard_filter_to: "To Date",
            dashboard_show_data: "Show Data",
            dashboard_sales_qty: "Sales (Quantity)",
            dashboard_sales_value: "Sales (Value)",
            dashboard_no_sales_data: "No sales data found for the selected date range.",
            dashboard_qty_label: "Quantity: ",
            dashboard_pieces_label: " pcs",
            dashboard_autopart_sales_title: "Autopart Sales (Date Range)",
            dashboard_electronic_sales_title: "Electronic Sales (Date Range)",
            dashboard_rank: "Rank",
            dashboard_type: "Type",
            dashboard_initial_prompt: "Please select a date range and click \"Show Data\"",
            dashboard_customer_unspecified: "Unspecified Customer",
            dashboard_type_autopart: "Autopart",
            dashboard_type_electronic: "Electronic",
            dashboard_type_other: "Other",
            // Stock Tab
            backup_title: "Backup Data",
            backup_desc: "Download various data as CSV files.",
            backup_stock: "Stock Data",
            backup_products: "Product Data",
            backup_users: "User Data",
            stock_summary_title: "Stock Balance Summary",
            stock_show_old_filter: "Show only stock older than 3 months",
            stock_search_placeholder: "Search Product ID, Name, or Customer...",
            stock_table_product: "Product ID/Name",
            stock_table_balance: "Total Balance",
            // Import Tab
            import_form_title: "Import Goods Form",
            import_add_lot_button: "Add Production Lot",
            import_total_quantity: "Total Import Quantity",
            import_fullbox: "Full Box Qty",
            import_quantity: "Import Quantity",
            import_warning: "Please double-check the production date on the product before importing.",
            import_save_button: "Save Import",
            // Export Tab
            export_form_title: "Export Goods Form",
            export_total_quantity: "Total Export Quantity",
            export_lot_select: "Production Date Lot",
            export_quantity: "Export Quantity",
            export_invoice: "Invoice No.",
            export_warning: "Exports should follow the FIFO (First-In, First-Out) principle.",
            export_save_button: "Save Export",
            export_temp_confirm_title: "Confirm Export?",
            export_temp_confirm_text: "You are about to export an item with 'Temporary Packing'. Are you sure you want to proceed?",
	    export_type_label: "Export Type",
            export_type_sale: "Sale",
            export_type_production: "Production Withdrawal",
            export_type_qc: "QC Withdrawal",
            export_type_other: "Other",
            error_invoice_required_for_sale: "Please enter an Invoice Number for sales transactions.",
            // History Tab
            history_filter_from: "From Date",
            history_filter_to: "To Date",
            history_filter_type: "Type",
            history_filter_product: "Product",
            history_filter_invoice: "Invoice No.",
            history_filter_search: "Search",
            history_filter_clear: "Clear",
            history_filter_type_all: "All",
            history_filter_type_import: "Import",
            history_filter_type_export: "Export",
            history_filter_type_adjustment: "Adjustment",
            history_filter_type_reversal: "Reversal",
            history_table_title: "Transaction History",
            backup_history: "Download History (CSV)",
            history_table_type: "Type",
            history_table_packaging: "Packaging",
            history_table_invoice_remarks: "Invoice / Remarks",
            history_table_timestamp: "Timestamp",
            history_table_user: "User",
            // Stock Count Tab
            stock_count_title: "Stock Count",
            stock_count_start_button: "Start New Stock Count",
            stock_count_history_title: "Stock Count History",
            stock_count_modal_title: "Record Stock Count",
            stock_count_save_button: "Save Count Results",
            stock_count_system_qty: "System Qty",
            stock_count_counted_qty: "Counted Qty",
            stock_count_table_id: "Count ID",
            stock_count_table_date: "Count Date",
            stock_count_table_user: "Performed By",
            stock_count_table_status: "Status",
            stock_count_status_pending: "Pending Review",
            stock_count_status_approved: "Approved",
            stock_count_report_title: "Stock Count Report",
            stock_count_variance: "Variance",
            stock_count_approve_button: "Approve Adjustment",
            stock_count_confirm_approve_title: "Confirm Adjustment?",
            stock_count_confirm_approve_text: "This will create an 'Adjustment' entry in the history to match the counted quantity.",
            stock_count_adjustment_remark: "Adjustment from Stock Count {countId} (Counted by: {countedBy})",
            stock_count_no_history: "No stock count history yet.",
            stock_count_approve_error_already_approved: "This stock count has already been approved.",
            stock_count_approve_success: "Adjustment approved and stock updated successfully.",
            // Product Management
            product_form_title: "Product Information Form",
            product_fullbox_rack: "Full Box/Rack Qty",
            product_unit_price: "Unit Price",
            product_save_button: "Save Product Data",
            product_table_title: "All Products List",
            product_table_price: "Price/Unit",
            // User Management
            user_form_title: "User Information Form",
            user_role: "Role",
            user_permissions: "Permissions",
            permission_canImport: "Import Goods",
            permission_canExport: "Export Goods",
            permission_canViewHistory: "View History",
            permission_canCountStock: "Perform Stock Count",
            permission_canManageProducts: "Manage Products",
            permission_canManageUsers: "Manage Users",
            permission_canManageAnnouncements: "Manage Announcements",
            user_save_button: "Save User Data",
            user_table_title: "All Users List",
            // Announcement Management
            announcement_form_title: "Create/Edit Announcement",
            announcement_title: "Title",
            announcement_message: "Message",
            announcement_show: "Show this announcement",
            announcement_save_button: "Save Announcement",
            announcement_table_title: "All Announcements List",
            announcement_table_header_title: "Title",
            announcement_table_status: "Status",
            announcement_table_posted_by: "Posted By",
            announcement_table_posted_date: "Posted Date",
            // Modals
            lot_modal_title: "Lot Details for",
            lot_modal_balance: "Remaining Quantity",
            edit_stock_modal_title: "Manual Stock Adjustment",
            edit_stock_new_total: "New Total Quantity",
            edit_stock_note: "Saving will create a new 'Adjustment' entry in the history.",
            edit_stock_save_button: "Save New Total",
            edit_stock_confirm_title: "Confirm Stock Adjustment?",
            edit_stock_confirm_text: "A new transaction will be created to adjust the stock for product {productId} to {quantity} units.",
            // SweetAlerts
            loading: "Loading data...",
            saving: "Saving data...",
            please_wait: "Please wait",
            data_updated: "Data updated!",
            load_error_title: "Failed to Load Data!",
            load_error_text: "Could not connect to the database ({error}). Please try refreshing the page.",
            critical_load_error_title: "Critical Load Error",
            critical_load_error_text: "The server returned a critical empty data set (e.g., product list), but local data exists. The operation has been cancelled to prevent data loss. Please contact an administrator.",
            save_error_title: "Failed to Save Data!",
            save_error_text: "An error occurred while saving data: {error}",
            background_save_error: "An error occurred during the background save. Please refresh the page to sync data.",
            session_expired_title: "Session Expired",
            session_expired_text: "You have been inactive for over 30 minutes. Please log in again.",
            confirm_delete_title: "Confirm Permanent Deletion?",
            confirm_delete_prompt: "Please type 'delete' to confirm",
            confirm_delete_lot_text: "All lots for product {productId} produced on {productionDate} will be permanently deleted!",
            delete_lot_success: "Lots deleted successfully.",
            delete_lot_error: "Could not find the lots to delete.",
            confirm_delete_product_text: "Product {productId} will be permanently deleted from the system.",
            delete_product_error: "Cannot delete! This product is still in stock.",
            delete_product_success: "Product deleted successfully.",
            confirm_delete_user_text: "User {username} will be removed from the system.",
            delete_user_admin_error: "Cannot delete the main admin user.",
            delete_user_success: "User deleted successfully.",
            confirm_reverse_history_title: "Confirm Transaction Reversal?",
            reverse_history_export_text: "This action will return the items to stock and cannot be undone.",
            reverse_history_import_text: "This action will deduct the items from stock and cannot be undone.",
            reverse_history_import_error_not_enough: "Stock from this lot has already been used. Cannot reverse this import.",
            reverse_history_success: "Transaction reversed and stock adjusted successfully.",
            reverse_history_find_error: "Could not find the transaction to reverse. The data might be syncing. Please wait a moment and try again.",
            // Dynamic texts
            user_role_display: "Role: {role}",
            history_total_quantity_display: "Total: {total}",
            no_history_found_message: "Please provide filter criteria to search for transaction history.",
            history_no_transactions_yet: "No transaction history yet.",
            no_history_for_filter_message: "No data found for the specified criteria.",
            history_type_import: "Import",
            history_type_export: "Export",
            history_type_adjustment: "Adjustment",
            history_type_reversal: "Reversal",
            announcement_status_active: "Active",
            announcement_status_inactive: "Inactive",
            announcement_posted_by_on: "Posted by: {user} on: {date}",
            announcement_badge: "Announcement",
            export_lot_placeholder_select: "-- Select Production Lot --",
            export_lot_placeholder_no_product: "-- Please select a product first --",
            export_lot_placeholder_no_stock: "-- This product is out of stock --",
            export_lot_option: "Prod. Date: {date} (Available: {qty})",
            export_quantity_placeholder: "Max: {qty}",
            product_not_found: "(Product info not found for {id})",
            stock_summary_no_results: "No products match your search.",
            stock_summary_no_old_stock: "No stock older than 3 months found.",
            stock_summary_no_stock: "No stock data available yet.",
            lot_modal_no_data: "No lot data found for this product.",
            product_management_no_data: "No product data yet.",
            user_management_no_data: "No user data yet.",
            announcement_management_no_data: "No announcements yet.",
            form_incomplete: "Incomplete Information",
            product_name_required: "Please specify the product name.",
            export_data_incomplete: "Please select a product, production date, and specify the export quantity.",
            export_no_stock_for_date: "No stock found for the selected production date.",
            export_not_enough: "Only {qty} units are available in stock for this date.",
            product_id_exists: "This Product ID already exists in the system.",
            username_exists: "This username already exists in the system.",
            user_not_found_for_edit: "Could not find the user to edit.",
            history_not_found_for_edit: "Could not find the history record to edit.",
            history_edit_no_lot: "Original stock lot for this history record not found.",
            history_edit_not_enough: "Cannot edit quantity. Stock available in this lot (including returned items) is only {qty}.",
            history_edit_import_not_enough: "Cannot reduce import quantity below {qty}, as that many units have already been used.",
            product_not_found_error: "Product not found",
            success_title: "Success!",
            import_success: "Imported {name} successfully.",
            export_success: "Exported {name} successfully.",
            product_update_success: "Product information updated successfully.",
            product_add_success: "New product added successfully.",
            user_add_success: "New user added successfully.",
            user_update_success: "User information updated successfully.",
            history_edit_success: "History record edited successfully.",
            stock_update_success: "Stock total updated successfully.",
            announcement_update_success: "Announcement updated successfully.",
            announcement_add_success: "New announcement added successfully.",
            announcement_status_update_success: "Announcement status updated successfully.",
            backup_no_data: "Cannot back up empty data.",
            backup_downloading: "Downloading file {filename}",
            future_date_error: "Cannot select a future production date.",
            fifo_warning_title: "Confirm Export?",
            fifo_warning_text: "The oldest lot ({date}) still has remaining stock. Do you confirm you want to export a newer lot?"
        }

    };

    let currentLanguage = sessionStorage.getItem('currentLanguage') || 'th';

    document.addEventListener('DOMContentLoaded', () => {
        
        let hasHistoryBeenSearched = false;

        // --- GLOBAL FUNCTION FOR LANGUAGE SWITCHING ---
        window.setLanguage = (lang) => {
            currentLanguage = lang;
            sessionStorage.setItem('currentLanguage', lang);
            document.body.className = `lang-${lang}`;

            // Update all static text
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[lang][key]) {
                    el.innerHTML = translations[lang][key];
                }
            });
            
            // Update placeholders
            document.querySelectorAll('[data-lang-key-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-key-placeholder');
                if (translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });

            // Update language switcher label
            document.getElementById('language-switcher-label').innerText = lang === 'th' ? 'ไทย' : 'English';

            // Re-render all dynamic content
            renderAllForms();
            if (currentUser) {
                const userRoleSpan = document.getElementById('user-role');
                const roleText = translations[currentLanguage].user_role_display.replace('{role}', currentUser.role);
                userRoleSpan.innerHTML = `<i class="bi bi-person-check-fill me-1"></i> ${currentUser.username} (${roleText})`;

                populateAll();
            }
        };

        // --- GOOGLE APPS SCRIPT CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyDGLLwqnY1hOyDqM-Q6UlKRktrSneEAEtHkcsEuBQDaQMsgiBYGZPb30RMEQD2S17_OQ/exec';

        // --- DATABASE SIMULATION & PERSISTENCE ---
        let db = { users: [], products: [], history: [], announcements: [], stockCounts: [] };
        let calculatedStock = []; // This will hold the stock calculated from history
        let dataSyncInterval = null;
        let inactivityTimer = null;
        let editingAnnouncementId = null; 

        // --- INACTIVITY & SYNC FUNCTIONS ---
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(logoutDueToInactivity, 30 * 60 * 1000); // 30 minutes
        }

        function logoutDueToInactivity() {
            stopDataSync();
            Swal.fire({
                title: translations[currentLanguage].session_expired_title,
                text: translations[currentLanguage].session_expired_text,
                icon: 'warning',
                confirmButtonText: translations[currentLanguage].ok_button,
                allowOutsideClick: false,
            }).then(() => {
                showLoginPage();
            });
        }
        
        function setupActivityListeners() {
            const events = ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'];
            events.forEach(event => window.addEventListener(event, resetInactivityTimer, true));
        }

        function clearActivityListeners() {
            const events = ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'];
            events.forEach(event => window.removeEventListener(event, resetInactivityTimer, true));
        }

        function startDataSync() {
            if (dataSyncInterval) clearInterval(dataSyncInterval);
            dataSyncInterval = setInterval(() => loadDataFromSheet(false), 30000); // Sync every 30 seconds
        }

        function stopDataSync() {
            if (dataSyncInterval) {
                clearInterval(dataSyncInterval);
                dataSyncInterval = null;
            }
        }
        
        /**
         * Generic function to call the Google Apps Script backend.
         * @param {string} action - The action to perform (e.g., 'appendHistory', 'updateProduct').
         * @param {object} payload - The data to send with the action.
         * @returns {Promise<object>} - The JSON response from the server.
         */
        async function callAppsScript(action, payload) {
            const requestBody = {
                action: action,
                payload: payload
            };
            let response; 
            try {
                response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(requestBody),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    }
                });

                const responseText = await response.text();

                if (!response.ok) {
                    console.error("Server responded with an error:", {
                        status: response.status,
                        statusText: response.statusText,
                        body: responseText
                    });
                    throw new Error(`Server error (${response.status}). Check Apps Script logs.`);
                }
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error("Failed to parse server response as JSON.", { responseBody: responseText });
                    throw new Error("Invalid response from server. Please re-deploy your Apps Script and ensure 'Who has access' is set to 'Anyone'.");
                }

                // **CRITICAL FIX**: Check for an error status *within* the JSON response itself.
                if (data.status === 'error') {
                    console.error("Apps Script returned an error:", data.message);
                    throw new Error(data.message || 'An unknown error occurred in the backend script.');
                }

                return data;

            } catch (error) {
                console.error(`Error calling Apps Script action '${action}':`, error);
                throw error;
            }
        }


        async function loadDataFromSheet(isInitialLoad = false) {
            if (isInitialLoad) {
                Swal.fire({
                    title: translations[currentLanguage].loading,
                    text: translations[currentLanguage].please_wait,
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading() }
                });
            }

            try {
                // The GET request now only fetches data, it doesn't contain stock.
                const response = await fetch(SCRIPT_URL, {
                    method: 'GET',
                    redirect: 'follow'
                });

                if (!response.ok) {
                    if (isInitialLoad) throw new Error(`Network response was not ok. Status: ${response.status}`);
                    else { console.error('Background refresh failed.'); return; }
                }
                const newData = await response.json();
                
                const isProductDataWiped = db.products && db.products.length > 0 && newData.products && newData.products.length === 0;
                const isUserDataWiped = db.users && db.users.length > 0 && newData.users && newData.users.length === 0;

                if (isProductDataWiped || isUserDataWiped) {
                    console.error("Critical Error Prevented: Server returned an empty critical data array. Halting data sync.");
                    if (isInitialLoad) {
                        showError(translations[currentLanguage].critical_load_error_title, translations[currentLanguage].critical_load_error_text);
                    }
                    stopDataSync(); 
                    return; 
                }

                // Ensure all data arrays exist to prevent errors
                newData.products = newData.products || [];
                newData.users = newData.users || [];
                newData.history = newData.history || [];
                newData.announcements = newData.announcements || [];
                newData.stockCounts = newData.stockCounts || [];
                
                if (JSON.stringify(db) !== JSON.stringify(newData)) {
                    db = newData;
                    console.log('Data updated from Google Sheet at:', new Date().toLocaleTimeString());
                    if (currentUser) {
                        calculateStockFromHistory(); // Recalculate stock after getting new history
                        populateAll();
                    }
                    
                    if (!isInitialLoad) {
                        const Toast = Swal.mixin({
                            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
                        });
                        Toast.fire({ icon: 'success', title: translations[currentLanguage].data_updated });
                    }
                }
                
                if (isInitialLoad) Swal.close();
            } catch (error) {
                console.error('Error loading data from Google Sheet:', error);
                if (isInitialLoad) showError(translations[currentLanguage].load_error_title, translations[currentLanguage].load_error_text.replace('{error}', error.message));
            }
        }
        
        // --- DOM ELEMENTS ---
        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('main-dashboard');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const logoutBtn = document.getElementById('logout-btn');
        const userRoleSpan = document.getElementById('user-role');
        const stockSummaryTable = document.getElementById('stock-summary-table');
        const lotDetailModal = new bootstrap.Modal(document.getElementById('lotDetailModal'));
        const lotDetailTable = document.getElementById('lot-detail-table');
        const modalProductName = document.getElementById('modal-product-name');
        const showOldStockFilter = document.getElementById('show-old-stock-filter');
        const editStockModal = new bootstrap.Modal(document.getElementById('editStockModal'));
        const stockSearchInput = document.getElementById('stock-search-input');
        const importFormEl = document.getElementById('import-form');
        const exportFormEl = document.getElementById('export-form');
        const productFormEl = document.getElementById('product-form');
        const userFormEl = document.getElementById('user-form');
        const historyFilterForm = document.getElementById('history-filter-form');
        const editStockForm = document.getElementById('edit-stock-form');
        const userManagementTable = document.getElementById('user-management-table');
        const productManagementTable = document.getElementById('product-management-table');
        const historyTable = document.getElementById('history-table');
        const announcementFormEl = document.getElementById('announcement-form');
        const announcementManagementTable = document.getElementById('announcement-management-table');
        const announcementsDisplayArea = document.getElementById('announcements-display-area');
        const stockCountModal = new bootstrap.Modal(document.getElementById('stockCountModal'));
        const stockCountReportModal = new bootstrap.Modal(document.getElementById('stockCountReportModal'));
        // NEW: Dashboard elements
        const dashboardFilterBtn = document.getElementById('dashboard-filter-btn');
        const dashboardStartDateInput = document.getElementById('dashboard-start-date');
        const dashboardEndDateInput = document.getElementById('dashboard-end-date');
        const dashboardTotalStockValue = document.getElementById('dashboard-total-stock-value');
        const dashboardTotalStockQuantity = document.getElementById('dashboard-total-stock-quantity');
        const dashboardTotalSalesQuantity = document.getElementById('dashboard-total-sales-quantity');
        const dashboardTotalSalesValue = document.getElementById('dashboard-total-sales-value');
        const dashboardSalesTable = document.getElementById('dashboard-sales-table');
	


        // --- STATE MANAGEMENT ---
        let currentUser = null;
        let editingProductId = null;
        let originalUsernameForEdit = null;

        // --- GLOBAL APP OBJECT ---
        window.app = {
            editProduct: (productId) => {
                if (!currentUser || (currentUser.role !== 'admin' && !currentUser.canManageProducts)) return;
                const product = db.products.find(p => String(p.id).trim() === String(productId).trim());
                if (product) {
                    editingProductId = productId;
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('product-id').readOnly = true;
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-customer').value = product.customer || '';
                    document.getElementById('product-fullBoxQuantity').value = product.fullBoxQuantity || '';
                    document.getElementById('product-erpCode').value = product.erpCode || '';
                    document.getElementById('product-unitPrice').value = product.unitPrice || 0;
                    
                    const productFormCard = document.querySelector('#pills-products .card');
                    productFormCard.scrollIntoView({ behavior: 'smooth' });
                    document.getElementById('product-name').focus();
                }
            },
            deleteProduct: (productId) => {
                if (!currentUser || (currentUser.role !== 'admin' && !currentUser.canManageProducts)) return;
                const productStock = calculatedStock.find(s => String(s.productId).trim() === String(productId).trim() && s.totalQuantity > 0);

                if (productStock) {
                    showError('Cannot Delete!', translations[currentLanguage].delete_product_error);
                    return;
                }
                const confirmText = translations[currentLanguage].confirm_delete_product_text.replace('{productId}', productId);
                confirmDestructiveAction(confirmText, async () => {
                    try {
                        await callAppsScript('deleteProduct', { id: productId });
                        // Optimistic update
                        db.products = db.products.filter(p => String(p.id).trim() !== String(productId).trim());
                        populateAll();
                        showSuccess(translations[currentLanguage].delete_product_success);
                    } catch (error) {
                        showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
                    }
                });
            },
            editUser: (username) => {
                if (!currentUser || (currentUser.role !== 'admin' && !currentUser.canManageUsers)) return;
                const user = db.users.find(u => u.username === username);
                if (user) {
                    originalUsernameForEdit = username;
                    renderUserForm(user);
                    document.getElementById('user-username').readOnly = true;
                }
            },
            deleteUser: (username) => {
                if (!currentUser || (currentUser.role !== 'admin' && !currentUser.canManageUsers)) return;
                if (username === 'admin') {
                    showError('Cannot Delete!', translations[currentLanguage].delete_user_admin_error);
                    return;
                }
                const confirmText = translations[currentLanguage].confirm_delete_user_text.replace('{username}', username);
                confirmDestructiveAction(confirmText, async () => {
                    try {
                        await callAppsScript('deleteUser', { username: username });
                        // Optimistic update
                        db.users = db.users.filter(u => u.username !== username);
                        populateAll();
                        showSuccess(translations[currentLanguage].delete_user_success);
                    } catch (error) {
                        showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
                    }
                });
            },
            reverseHistory: (historyItem) => {
                if (!currentUser || currentUser.role !== 'admin') return;
                if (!historyItem || historyItem.type === 'reversal') {
                    return;
                }

                const message = historyItem.type === 'export' 
                    ? translations[currentLanguage].reverse_history_export_text
                    : translations[currentLanguage].reverse_history_import_text;

                confirmAction(translations[currentLanguage].confirm_reverse_history_title, message, async () => {
                    if (historyItem.type === 'import') {
                        const prodDateToReverse = formatDate(historyItem.productionDate || historyItem.ProductionDate || historyItem.production_date);

                        // Find all exports from this specific lot that happened *after* the import.
                        const exportsFromThisLot = db.history.filter(h =>
                            h.type === 'export' &&
                            String(h.productId).trim() === String(historyItem.productId).trim() &&
                            formatDate(h.productionDate || h.ProductionDate || h.production_date) === prodDateToReverse &&
                            new Date(h.date) > new Date(historyItem.date)
                        );

                        // Find all reversals of those exports.
                        const reversedExportIds = db.history
                            .filter(h => h.type === 'reversal' && /Reversal of transaction ID: exp-/.test(h.remarks))
                            .map(h => h.remarks.match(/Reversal of transaction ID: (exp-[\w-]+)/)[1]);

                        // Calculate the net exported quantity from this lot.
                        let netExportedQuantity = 0;
                        exportsFromThisLot.forEach(exp => {
                            if (!reversedExportIds.includes(exp.id)) {
                                netExportedQuantity += parseFloat(exp.quantity) || 0;
                            }
                        });

                        if (netExportedQuantity > 0) {
                            showError('Cannot Reverse!', translations[currentLanguage].reverse_history_import_error_not_enough);
                            return;
                        }
                    }

                    const reversalQuantity = historyItem.type === 'export' 
                        ? parseFloat(historyItem.quantity)
                        : -parseFloat(historyItem.quantity);

                    const reversalEntry = {
                        id: 'rev-' + Date.now(),
                        date: new Date().toISOString(),
                        type: 'reversal',
                        productId: historyItem.productId,
                        productName: historyItem.productName,
                        customer: historyItem.customer,
                        erpCode: historyItem.erpCode,
                        productionDate: historyItem.productionDate || historyItem.ProductionDate || historyItem.production_date,
                        invoiceNumber: historyItem.invoiceNumber,
                        quantity: reversalQuantity,
                        user: currentUser.username,
                        remarks: `Reversal of transaction ID: ${historyItem.id}. Original remarks: ${historyItem.remarks || ''}`,
                        packagingType: historyItem.packagingType // Carry over packaging type
                    };

                    try {
                        await callAppsScript('appendHistory', reversalEntry);
                        db.history.unshift(reversalEntry); 
                        calculateStockFromHistory();
                        populateAll();
                        showSuccess(translations[currentLanguage].reverse_history_success);
                    } catch (error) {
                        showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
                    }
                });
            },
            editStockTotal: (productId) => {
                if (!currentUser || currentUser.role !== 'admin') return;
                const product = db.products.find(p => String(p.id).trim() === String(productId).trim());
                if (product) {
                    const stockInfo = calculatedStock.find(s => String(s.productId).trim() === String(productId).trim());
                    const totalQuantity = stockInfo ? stockInfo.totalQuantity : 0;
                    renderEditStockForm(product, totalQuantity);
                    editStockModal.show();
                }
            },
            showLotDetails: (productId) => {
                modalProductName.textContent = productId;
                populateLotDetailsTable(productId);
                lotDetailModal.show();
            },
            editAnnouncement: (announcementId) => {
                if (!currentUser || (currentUser.role !== 'admin' && !currentUser.canManageAnnouncements)) return;
                const announcement = db.announcements.find(a => String(a.id) === String(announcementId));
                if (announcement) {
                    editingAnnouncementId = announcementId;
                    renderAnnouncementForm(announcement);
                }
            },
            deleteAnnouncement: (announcementId) => {
                if (!currentUser || (currentUser.role !== 'admin' && !currentUser.canManageAnnouncements)) return;
                confirmDestructiveAction('This announcement will be permanently deleted.', async () => {
                     try {
                        await callAppsScript('deleteAnnouncement', { id: announcementId });
                        db.announcements = db.announcements.filter(a => String(a.id) !== String(announcementId));
                        populateAll();
                        showSuccess(translations[currentLanguage].announcement_update_success);
                    } catch (error) {
                        showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
                    }
                });
            },
            toggleAnnouncementStatus: async (announcementId) => {
                if (!currentUser || (currentUser.role !== 'admin' && !currentUser.canManageAnnouncements)) return;
                const announcement = db.announcements.find(a => String(a.id) === String(announcementId));
                if (announcement) {
                    const updatedAnnouncement = { ...announcement, isActive: !announcement.isActive };
                    try {
                        await callAppsScript('updateAnnouncement', updatedAnnouncement);
                        announcement.isActive = !announcement.isActive; // Optimistic update
                        populateAll();
                        showSuccess(translations[currentLanguage].announcement_status_update_success);
                    } catch (error) {
                        showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
                    }
                }
            },
            // NEW: Stock Count Functions
            startNewStockCount: () => {
                renderStockCountModalBody();
                stockCountModal.show();
            },
            saveStockCount: async () => {
                const T = translations[currentLanguage];
                const countItems = [];
                const rows = document.querySelectorAll('#stock-count-product-list .stock-count-row');
                
                rows.forEach(row => {
                    const countedQtyInput = row.querySelector('.counted-qty-input');
                    // Only include items that were actually counted
                    if (countedQtyInput.value !== '') {
                        countItems.push({
                            productId: row.dataset.productId,
                            productName: row.dataset.productName,
                            systemQty: parseInt(row.dataset.systemQty, 10),
                            countedQty: parseInt(countedQtyInput.value, 10)
                        });
                    }
                });

                if (countItems.length === 0) {
                    showError(T.form_incomplete, "Please count at least one item.");
                    return;
                }

                const newCount = {
                    id: 'sc-' + Date.now(),
                    date: new Date().toISOString(),
                    user: currentUser.username,
                    status: 'pending',
                    items: countItems
                };

                // Optimistic Update
                db.stockCounts.unshift(newCount);
                populateStockCountMainView();
                stockCountModal.hide();
                showSuccess(T.success_title, T.stock_count_save_button);

                // Background Save
                try {
                    await callAppsScript('addStockCount', newCount);
                    console.log(`Background save successful for stock count ${newCount.id}`);
                } catch (error) {
                    showError(T.save_error_title, `${T.save_error_text.replace('{error}', error.message)}\n\n${T.background_save_error}`);
                }
            },
            viewStockCountReport: (countId) => {
                const count = db.stockCounts.find(sc => sc.id === countId);
                if (count) {
                    renderStockCountReportModalBody(count);
                    stockCountReportModal.show();
                }
            },
            approveStockCount: (countId) => {
                const T = translations[currentLanguage];
                const count = db.stockCounts.find(sc => sc.id === countId);

                if (!count || count.status === 'approved') {
                    showError('Error', T.stock_count_approve_error_already_approved);
                    return;
                }
                
                const confirmText = T.stock_count_confirm_approve_text;
                confirmAction(T.stock_count_confirm_approve_title, confirmText, async () => {
                    const adjustmentEntries = [];
                    count.items.forEach(item => {
                        const variance = item.countedQty - item.systemQty;
                        if (variance !== 0) {
                            const product = db.products.find(p => String(p.id).trim() === String(item.productId).trim());
                            const humanReadableRemark = T.stock_count_adjustment_remark.replace('{countId}', count.id).replace('{countedBy}', count.user);
                            const machineReadableRemark = `STOCK_COUNT_ADJ:${count.id}|${humanReadableRemark}`;
                            
                            adjustmentEntries.push({
                                id: 'adj-' + Date.now() + '-' + item.productId,
                                date: new Date().toISOString(),
                                type: 'adjustment',
                                productId: item.productId,
                                productName: product ? product.name : item.productName,
                                customer: product ? product.customer : '',
                                erpCode: product ? product.erpCode : '',
                                quantity: variance, // This is the difference
                                productionDate: 'Stock Count Adjustment',
                                user: currentUser.username,
                                remarks: machineReadableRemark,
                                packagingType: 'standard' // Adjustments are considered standard
                            });
                        }
                    });

                    // Optimistic Update
                    const originalStatus = count.status;
                    count.status = 'approved';
                    adjustmentEntries.forEach(entry => db.history.unshift(entry));
                    
                    calculateStockFromHistory();
                    populateAll();
                    stockCountReportModal.hide();
                    showSuccess(T.success_title, T.stock_count_approve_success);

                    // Background Save
                    try {
                        // First, save all the adjustments
                        if (adjustmentEntries.length > 0) {
                            await callAppsScript('appendBatchHistory', adjustmentEntries);
                        }
                        // Then, update the status of the count
                        await callAppsScript('updateStockCountStatus', { id: countId, status: 'approved' });
                        console.log(`Successfully approved and adjusted stock for count ${countId}`);
                    } catch (error) {
                        // Rollback optimistic update on failure
                        count.status = originalStatus;
                        db.history.splice(0, adjustmentEntries.length);
                        calculateStockFromHistory();
                        populateAll();
                        showError(T.save_error_title, `${T.save_error_text.replace('{error}', error.message)}\n\n${T.background_save_error}`);
                    }
                });
            },
            // NEW: Dashboard functions
            populateDashboard: () => {
                populateStockDashboard();

                let startDate = dashboardStartDateInput.value;
                let endDate = dashboardEndDateInput.value;

                // หากวันที่ยังไม่ได้ถูกกำหนด (เช่น โหลดครั้งแรก หรือหลังจากรีเซ็ต)
                // ให้กำหนดเป็นวันที่ 1 ของเดือนปัจจุบัน ถึงวันสุดท้ายของเดือนปัจจุบัน
                if (!startDate || !endDate) {
                    const today = new Date();
                    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    startDate = formatDate(firstDayOfMonth);
                    endDate = formatDate(lastDayOfMonth);
                    dashboardStartDateInput.value = startDate;
                    dashboardEndDateInput.value = endDate;
                }

                // ใช้ค่าวันที่ปัจจุบันจาก input เสมอในการ populate sales dashboard
                populateSalesDashboard(new Date(startDate), new Date(endDate));
            }
        };

        async function init() {
            setLanguage(currentLanguage);
            await loadDataFromSheet(true);
            checkLoginState();
            addEventListeners();
        }

        function checkLoginState() {
            const user = JSON.parse(sessionStorage.getItem('currentUser'));
            if (user) {
                const userInDb = db.users.find(u => u.username === user.username && u.password === user.password);
                if (userInDb) {
                    currentUser = userInDb;
                    showDashboard();
                } else {
                    showLoginPage();
                }
            } else {
                showLoginPage();
            }
        }
        
        async function handleImport(e) {
            e.preventDefault();
            const T = translations[currentLanguage];
            const productId = document.getElementById('import-product-id').value;
            const productName = document.getElementById('import-product-name').value;
            if (!productName) {
                showError(T.form_incomplete, T.product_name_required);
                return;
            }
            
            const productForHistory = {
                id: productId,
                name: productName,
                customer: document.getElementById('import-customer').value,
                erpCode: document.getElementById('import-erp-code').value
            };
            const remarks = document.getElementById('import-remarks').value;
            const lotRows = document.querySelectorAll('#import-lots-container .import-lot-row');
            const newHistoryEntries = [];

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for(const row of lotRows) {
                const quantity = parseInt(row.querySelector('.import-quantity').value);
                const productionDateStr = row.querySelector('.import-prod-date').value;
                const packagingType = row.querySelector('.import-packaging-type').value;
                if (!productionDateStr) continue;
                
                // FIX: Corrected variable name from productionDateDateStr to productionDateStr
                const parts = productionDateStr.split('-');
                const productionDate = new Date(parts[0], parts[1] - 1, parts[2]);

                if (productionDate > today) {
                    showError(T.form_incomplete, T.future_date_error);
                    return;
                }

                if (quantity > 0) {
                    newHistoryEntries.push({
                        id: 'imp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5),
                        date: new Date().toISOString(),
                        type: 'import',
                        productId: productForHistory.id,
                        productName: productForHistory.name,
                        customer: productForHistory.customer,
                        erpCode: productForHistory.erpCode,
                        quantity: quantity,
                        productionDate: productionDateStr,
                        user: currentUser.username,
                        invoiceNumber: null,
                        remarks: remarks,
                        packagingType: packagingType
                    });
                }
            }

            if (newHistoryEntries.length === 0) {
                showError(T.form_incomplete, "Please add at least one valid lot.");
                return;
            }

            // --- Optimistic Update ---
            newHistoryEntries.forEach(entry => db.history.unshift(entry));
            calculateStockFromHistory();
            populateAll();
            showSuccess(T.import_success.replace('{name}', productName));
            renderImportForm();

            // --- Background Save ---
            try {
                await callAppsScript('appendBatchHistory', newHistoryEntries);
                console.log(`Background save successful for ${productName}`);
            } catch (error) {
                showError(T.save_error_title, `${T.save_error_text.replace('{error}', error.message)}\n\n${T.background_save_error}`);
            }
        }

        async function handleExport(e) {
            e.preventDefault();
            const T = translations[currentLanguage];
            const productId = document.getElementById('export-product-id').value;
            const selectedLotRows = document.querySelectorAll('#export-lots-container .export-lot-row:has(input[type="checkbox"]:checked)');
            const invoiceNumber = document.getElementById('export-invoice-number').value.trim();
            const exportType = document.getElementById('export-type').value; // <-- [เพิ่ม] ดึงข้อมูลประเภทการส่งออก

            // [เพิ่ม] ถ้าเป็นการขาย บังคับให้กรอก Invoice Number
            if (exportType === 'Sale' && !invoiceNumber) {
                showError('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกเลขที่ Invoice สำหรับการขายสินค้า');
                return;
            }
            
            // --- [แก้ไข] ขั้นตอนที่ 0: ตรวจสอบและ "เตือน" Invoice ซ้ำ ---
            if (invoiceNumber) {
                const isInvoiceDuplicate = db.history.some(item => {
                    if (item && item.type === 'export' && item.invoiceNumber) {
                        const existingInvoice = String(item.invoiceNumber).trim().toLowerCase();
                        const newInvoice = invoiceNumber.toLowerCase();
                        return existingInvoice === newInvoice;
                    }
                    return false;
                });

                if (isInvoiceDuplicate) {
                    const result = await Swal.fire({
                        title: 'Invoice ซ้ำ!',
                        text: `เลขที่ Invoice "${invoiceNumber}" นี้ถูกใช้ไปแล้ว คุณต้องการบันทึกซ้ำใช่ไหม?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'ใช่, บันทึกซ้ำ',
                        cancelButtonText: 'ยกเลิก'
                    });
                    if (!result.isConfirmed) {
                        return; // ถ้าผู้ใช้กดยกเลิก ให้จบการทำงานทันที
                    }
                }
            }

            // --- ขั้นตอนที่ 1: ตรวจสอบแพ็คกิ้งชั่วคราว ---
            const isExportingTemp = Array.from(selectedLotRows).some(row => row.dataset.packaging === 'temporary');
            if (isExportingTemp) {
                const result = await Swal.fire({
                    title: T.export_temp_confirm_title,
                    text: T.export_temp_confirm_text,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: T.ok_button,
                    cancelButtonText: T.cancel_button
                });
                if (!result.isConfirmed) {
                    return;
                }
            }

            // --- ขั้นตอนที่ 2: ตรวจสอบ FIFO ---
            const productStock = calculatedStock.find(p => String(p.productId).trim() === String(productId).trim());
            const availableLots = productStock ? productStock.lots.filter(l => l.quantity > 0).sort((a, b) => new Date(a.productionDate) - new Date(b.productionDate)) : [];
            const selectedLotDates = Array.from(selectedLotRows).map(row => row.dataset.date);
            let isFifoViolated = false;
            if (availableLots.length > 0 && selectedLotDates.length > 0) {
                const oldestAvailableDateStr = availableLots[0].productionDate;
                const isOldestSelected = selectedLotDates.includes(oldestAvailableDateStr);
                if (!isOldestSelected) {
                    isFifoViolated = true;
                }
            }

            if (isFifoViolated) {
                const oldestDate = availableLots[0].productionDate;
                const result = await Swal.fire({
                    title: T.fifo_warning_title,
                    text: T.fifo_warning_text.replace('{date}', oldestDate),
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: T.ok_button,
                    cancelButtonText: T.cancel_button
                });
                if (!result.isConfirmed) {
                    return;
                }
            }

 const remarks = document.getElementById('export-remarks').value;
            let product = db.products.find(p => String(p.id).trim() === String(productId).trim()) || { id: productId, name: 'N/A' };
            const newHistoryEntries = [];

            for (const row of selectedLotRows) {
                const productionDate = row.dataset.date;
                const packagingType = row.dataset.packaging;
                const quantityToExport = parseInt(row.querySelector('.export-quantity').value);

                newHistoryEntries.push({
                    id: 'exp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5),
                    date: new Date().toISOString(),
                    type: 'export',
                    exportType: exportType, // <-- [เพิ่ม] บันทึกประเภทการส่งออก
                    productId: product.id,
                    productName: product.name,
                    customer: product.customer,
                    erpCode: product.erpCode,
                    quantity: quantityToExport,
                    productionDate: productionDate,
                    user: currentUser.username,
                    invoiceNumber: invoiceNumber,
                    remarks: remarks,
                    packagingType: packagingType
                });
            }

            // --- Optimistic Update ---
            newHistoryEntries.forEach(entry => db.history.unshift(entry));
            calculateStockFromHistory();
            populateAll();
            showSuccess(T.export_success.replace('{name}', product.name));
            renderExportForm();

            // --- Background Save ---
            try {
                await callAppsScript('appendBatchHistory', newHistoryEntries);
                console.log(`Background export successful for ${product.name}`);
            } catch (error) {
                showError(T.save_error_title, `${T.save_error_text.replace('{error}', error.message)}\n\n${T.background_save_error}`);
            }
        }
	async function handleAnnouncementFormSubmit(e) {
            e.preventDefault();
            let successMessage = '';
            
            const announcementData = {
                id: editingAnnouncementId || 'ann-' + Date.now(),
                title: document.getElementById('announcement-title').value,
                message: document.getElementById('announcement-message').value,
                isActive: document.getElementById('announcement-active').checked,
                postedBy: currentUser.username,
                postedDate: new Date().toISOString()
            };

            if (!announcementData.title || !announcementData.message) {
                showError(translations[currentLanguage].form_incomplete, 'Please provide a title and message.');
                return;
            }

            try {
                if (editingAnnouncementId) {
                    await callAppsScript('updateAnnouncement', announcementData);
                    const index = db.announcements.findIndex(a => String(a.id) === String(editingAnnouncementId));
                    if (index > -1) db.announcements[index] = announcementData;
                    successMessage = translations[currentLanguage].announcement_update_success;
                } else {
                    await callAppsScript('addAnnouncement', announcementData);
                    db.announcements.unshift(announcementData);
                    successMessage = translations[currentLanguage].announcement_add_success;
                }
                
                clearAnnouncementForm();
                populateAll();
                showSuccess(successMessage);
            } catch (error) {
                showError(translations[currentLanguage].save_error_title, translations[currentLanguage].save_error_text.replace('{error}', error.message));
            }
        }
        
        function showLoginPage() { 
            stopDataSync(); 
            clearTimeout(inactivityTimer);
            clearActivityListeners();
            currentUser = null; 
            sessionStorage.removeItem('currentUser'); 
            loginPage.style.display = 'block'; 
            dashboardPage.style.display = 'none'; 
            document.getElementById('username').value = ''; 
            document.getElementById('password').value = ''; 
            errorMessage.classList.add('d-none'); 
        }

        function showDashboard() { 
            loginPage.style.display = 'none'; 
            dashboardPage.style.display = 'block'; 
            const roleText = translations[currentLanguage].user_role_display.replace('{role}', currentUser.role);
            userRoleSpan.innerHTML = `<i class="bi bi-person-check-fill me-1"></i> ${currentUser.username} (${roleText})`; 
            userRoleSpan.className = `badge rounded-pill me-2 fs-6 align-middle ${currentUser.role === 'admin' ? 'bg-success' : 'bg-info text-dark'}`; 
            
            // NEW: Granular permission checks for UI elements
            const isAdmin = currentUser.role === 'admin';
            document.getElementById('nav-import-item').style.display = isAdmin || currentUser.canImport ? '' : 'none';
            document.getElementById('nav-export-item').style.display = isAdmin || currentUser.canExport ? '' : 'none';
            document.getElementById('nav-history-item').style.display = isAdmin || currentUser.canViewHistory ? '' : 'none';
            document.getElementById('nav-stock-count-item').style.display = isAdmin || currentUser.canCountStock ? '' : 'none';
            document.getElementById('nav-products-item').style.display = isAdmin || currentUser.canManageProducts ? '' : 'none';
            document.getElementById('nav-users-item').style.display = isAdmin || currentUser.canManageUsers ? '' : 'none';
            document.getElementById('nav-announcements-item').style.display = isAdmin || currentUser.canManageAnnouncements ? '' : 'none';
            document.getElementById('backup-card-container').style.display = isAdmin ? '' : 'none';

            const stockContentColumn = document.getElementById('stock-content-column');
            if (isAdmin) {
                stockContentColumn.classList.remove('col-lg-12');
                stockContentColumn.classList.add('col-lg-9');
            } else {
                stockContentColumn.classList.remove('col-lg-9');
                stockContentColumn.classList.add('col-lg-12');
            }
            
            calculateStockFromHistory();
            populateAll(); 
            startDataSync(); 
            setupActivityListeners();
            resetInactivityTimer();
        }

        function populateAll() { 
            populateStockSummary(); 
            populateUserManagementTable(); 
            populateProductManagementTable(); 
            populateHistoryTable(); 
            populateAnnouncementsTable();
            displayActiveAnnouncements();
            populateStockCountMainView();
            window.app.populateDashboard(); // NEW: Call dashboard population
        }

        // --- RENDER FUNCTIONS (for dynamic content) ---
        function renderAllForms() {
            renderImportForm();
            renderExportForm();
            renderProductForm();
            renderUserForm();
            renderAnnouncementForm();
            renderHistoryFilterForm();
        }
        
        function populateStockSummary() {
            const T = translations[currentLanguage];
            const header = document.getElementById('stock-summary-table-header');
            const isAdmin = currentUser.role === 'admin';
            header.innerHTML = `<tr>
                <th></th>
                <th>${T.stock_table_product}</th>
                <th>${T.erp_code}</th>
                <th>${T.customer}</th>
                <th>${T.stock_table_balance}</th>
                ${isAdmin ? `<th>${T.actions}</th>` : ''}
            </tr>`;
            
            stockSummaryTable.innerHTML = '';
            const filterOldStock = showOldStockFilter.checked;
            const searchTerm = stockSearchInput.value.toLowerCase();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

            let summary = calculatedStock.map(stockItem => {
                let productInfo = db.products.find(p => String(p.id).trim() === String(stockItem.productId).trim());
                   if (!productInfo) {
                       productInfo = { id: stockItem.productId, name: T.product_not_found.replace('{id}', stockItem.productId), customer: '-', erpCode: '-' };
                   }
                const hasOldStock = stockItem.lots.some(l => l.quantity > 0 && new Date(formatDate(l.productionDate)) < threeMonthsAgo);
                return { ...productInfo, ...stockItem, hasOldStock };
            });
            
            summary = summary.filter(p => p.totalQuantity > 0);
            if (filterOldStock) summary = summary.filter(p => p.hasOldStock);
            if (searchTerm) {
                summary = summary.filter(item => 
                    String(item.id).trim().toLowerCase().includes(searchTerm) || 
                    item.name.toLowerCase().includes(searchTerm) || 
                    (item.customer && item.customer.toLowerCase().includes(searchTerm)) 
                );
            }
            summary.sort((a, b) => String(a.id).localeCompare(String(b.id)));

            if (summary.length === 0) {
                const message = searchTerm ? T.stock_summary_no_results : (filterOldStock ? T.stock_summary_no_old_stock : T.stock_summary_no_stock);
                stockSummaryTable.innerHTML = `<tr><td colspan="${isAdmin ? 6 : 5}" class="text-center p-4">${message} <i class="bi bi-emoji-wink"></i></td></tr>`;
                return;
            }

            summary.forEach(item => {
                const row = document.createElement('tr');
                row.dataset.productId = item.id;
                if (item.hasOldStock) { row.classList.add('table-warning'); }
                row.innerHTML = `
                    <td>${item.hasOldStock ? '<i class="bi bi-exclamation-triangle-fill text-danger"></i>' : ''}</td>
                    <td>
                        <div><span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">${item.id}</span></div>
                        <small class="text-muted">${item.name}</small>
                    </td>
                    <td class="small-text">${item.erpCode || '-'}</td>
                    <td class="small-text">${item.customer || '-'}</td>
                    <td><span class="fw-bold">${item.totalQuantity.toLocaleString()}</span></td>
                    ${isAdmin ? `<td><button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); window.app.editStockTotal('${item.id}')" title="${T.edit_stock_modal_title}"><i class="bi bi-pencil-fill"></i></button></td>` : ''}
                `;
                row.addEventListener('click', () => window.app.showLotDetails(item.id));
                stockSummaryTable.appendChild(row);
            });
        }

        function populateHistoryTable() {
            const T = translations[currentLanguage];
            const header = document.getElementById('history-table-header');
            const isAdmin = currentUser.role === 'admin';
            header.innerHTML = `<tr>
                <th>${T.history_table_type}</th>
                <th>${T.product_name}</th>
                <th>${T.quantity}</th>
                <th>${T.production_date}</th>
                <th>${T.history_table_packaging}</th>
                <th>${T.erp_code}</th>
                <th>${T.history_table_invoice_remarks}</th>
                <th>${T.history_table_timestamp}</th>
                <th>${T.history_table_user}</th>
                ${isAdmin ? `<th>${T.actions}</th>` : ''}
            </tr>`;

            historyTable.innerHTML = '';
            const colspan = isAdmin ? 10 : 9;

            if (db.history.length === 0) {
                document.getElementById('history-total-quantity').textContent = '';
                historyTable.innerHTML = `<tr><td colspan="${colspan}" class="text-center p-4">${T.history_no_transactions_yet}</td></tr>`;
                return;
            }

            if (!hasHistoryBeenSearched) {
                document.getElementById('history-total-quantity').textContent = '';
                historyTable.innerHTML = `<tr><td colspan="${colspan}" class="text-center p-4">${T.no_history_found_message}</td></tr>`;
                return;
            }

            const filteredHistory = getFilteredHistory();
            
            filteredHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

            const totalQuantity = filteredHistory.reduce((sum, item) => {
                const qty = parseFloat(item.quantity);
                return sum + (isNaN(qty) ? 0 : qty); // Simplified total calculation
            }, 0);

            const formattedTotal = totalQuantity % 1 === 0 ? totalQuantity.toLocaleString() : totalQuantity.toFixed(2);
            document.getElementById('history-total-quantity').textContent = T.history_total_quantity_display.replace('{total}', formattedTotal);

            if (filteredHistory.length === 0) {
                historyTable.innerHTML = `<tr><td colspan="${colspan}" class="text-center p-4">${T.no_history_for_filter_message}</td></tr>`;
                return;
            }
            
            filteredHistory.forEach(item => {
                const row = document.createElement('tr');
                let typeHtml, rowClass;
                switch (item.type) {
                    case 'import':
                        typeHtml = `<span class="badge bg-success-subtle text-success-emphasis rounded-pill"><i class="bi bi-arrow-down me-1"></i>${T.history_type_import}</span>`;
                        rowClass = 'history-import';
                        break;
                    case 'export':
                        typeHtml = `<span class="badge bg-info-subtle text-info-emphasis rounded-pill"><i class="bi bi-arrow-up me-1"></i>${T.history_type_export}</span>`;
                        rowClass = 'history-export';
                        break;
                    case 'adjustment':
                        typeHtml = `<span class="badge bg-warning-subtle text-warning-emphasis rounded-pill"><i class="bi bi-pencil-fill me-1"></i>${T.history_type_adjustment}</span>`;
                        rowClass = 'history-adjustment';
                        break;
                    case 'reversal':
                        typeHtml = `<span class="badge bg-danger-subtle text-danger-emphasis rounded-pill"><i class="bi bi-arrow-repeat me-1"></i>${T.history_type_reversal}</span>`;
                        rowClass = 'history-reversal'; // No more strikethrough
                        break;
                }
                row.classList.add(rowClass);
                const formattedDate = new Date(item.date).toLocaleString(currentLanguage === 'th' ? 'th-TH' : 'en-GB', {
                    year: 'numeric', month: 'short', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Bangkok'
                });
                
                const itemString = JSON.stringify(item).replace(/'/g, '&apos;'); 
                const actionsContent = (isAdmin && (item.type === 'import' || item.type === 'export')) ? `<button class="btn btn-danger btn-sm reverse-history-btn" data-history-item='${itemString}'><i class="bi bi-x-circle-fill"></i></button>` : '';
                
                const prodDate = item.productionDate || item.ProductionDate || item.production_date;
                
                // Display quantity with sign for adjustment and reversal
                let quantityDisplay = item.quantity.toLocaleString();
                if (item.type === 'adjustment' || item.type === 'reversal') {
                    quantityDisplay = (item.quantity > 0 ? '+' : '') + item.quantity.toLocaleString();
                }

                let displayRemark = item.remarks || '';
                if(item.type === 'adjustment') {
                    displayRemark = (displayRemark.split('|')[1] || displayRemark).trim();
                }

                let packagingBadge = '';
                if (item.type === 'import' || item.type === 'export' || item.type === 'reversal') {
                    if (item.packagingType === 'temporary') {
                        packagingBadge = `<span class="badge bg-warning-subtle text-warning-emphasis rounded-pill">${T.packaging_temp}</span>`;
                    } else {
                        packagingBadge = `<span class="badge bg-success-subtle text-success-emphasis rounded-pill">${T.packaging_std}</span>`;
                    }
                } else {
                    packagingBadge = '-';
                }

                row.innerHTML = `
                    <td>${typeHtml}</td>
                    <td><div>${item.productName}</div><small class="text-muted">${item.productId}</small></td>
                    <td>${quantityDisplay}</td>
                    <td>${formatDate(prodDate) || 'N/A'}</td>
                    <td>${packagingBadge}</td>
                    <td class="small-text">${item.erpCode || '-'}</td>
                    <td><div>${item.invoiceNumber || '-'}</div><small class="text-muted">${displayRemark}</small></td>
                    <td>${formattedDate}</td>
                    <td>${item.user}</td>
                    ${isAdmin ? `<td>${actionsContent}</td>` : ''}
                `;
                historyTable.appendChild(row);
            });
        }
        
        // --- ADD EVENT LISTENERS ---
        function addEventListeners() {
            loginForm.addEventListener('submit', handleLogin);
            logoutBtn.addEventListener('click', () => confirmAction(translations[currentLanguage].confirm_logout_title, '', showLoginPage));
            document.getElementById('refresh-stock-summary-btn').addEventListener('click', () => loadDataFromSheet(true));
            
            document.getElementById('backup-stock-btn').addEventListener('click', () => {
                const stockBackupData = generateStockBackupData();
                backupToCSV(stockBackupData, 'stock_summary_backup.csv');
            });
            document.getElementById('backup-products-btn').addEventListener('click', () => {
                backupToCSV(db.products, 'products_backup.csv');
            });
            document.getElementById('backup-users-btn').addEventListener('click', () => {
                backupToCSV(db.users, 'users_backup.csv');
            });
            
            document.getElementById('backup-history-btn').addEventListener('click', () => {
                const T = translations[currentLanguage];
                const historyData = getFilteredHistory();

                if (!historyData || historyData.length === 0) {
                    showError('No Data', T.backup_no_data);
                    return;
                }

                // Pre-process the data to format dates correctly for CSV export
                const dataToExport = historyData.map(item => {
                    // Create a copy to avoid modifying the original db object
                    const newItem = { ...item };

                    // Format the main transaction timestamp
                    newItem.date = new Date(item.date).toLocaleString(currentLanguage === 'th' ? 'th-TH' : 'en-GB', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', second: '2-digit',
                        timeZone: 'Asia/Bangkok'
                    });

                    // Format the production date
                    const prodDate = item.productionDate || item.ProductionDate || item.production_date;
                    newItem.productionDate = formatDate(prodDate);

                    return newItem;
                });
                
                const footerText = `Downloaded by: ${currentUser.username} on ${new Date().toLocaleString(currentLanguage === 'th' ? 'th-TH' : 'en-GB')}`;
                const footer = {
                    left: 'FS-112',
                    right: footerText
                };

                backupToCSV(dataToExport, 'history_backup.csv', footer);
            });

            // Delegated event listeners for dynamic content
            document.body.addEventListener('input', (e) => {
                if (e.target.id === 'import-product-id') {
                    const searchTerm = e.target.value;
                    const suggestionsContainer = document.getElementById('import-product-suggestions');
                    const productSource = db.products;
                    showSuggestions(e.target, suggestionsContainer, productSource, searchTerm);
                }
                if (e.target.id === 'export-product-id') {
                    const searchTerm = e.target.value;
                    // FIX: Trim the productId from calculatedStock to ensure consistent matching against trimmed product IDs.
                    const productsInStockIds = calculatedStock.filter(s => s.totalQuantity > 0).map(s => String(s.productId).trim());
                    const productSource = db.products.filter(p => productsInStockIds.includes(String(p.id).trim()));
                    showSuggestions(e.target, document.getElementById('export-product-suggestions'), productSource, searchTerm);
                }
                if (e.target.id === 'filter-product-search') {
                    const searchTerm = e.target.value;
                    const suggestionsContainer = document.getElementById('filter-product-suggestions');
                    const productSource = db.products;
                    showFilterSuggestions(e.target, suggestionsContainer, productSource, searchTerm);
                }
                if (e.target.classList.contains('import-quantity')) {
                    updateImportTotal();
                }
                if (e.target.classList.contains('export-quantity')) {
                    updateExportTotal();
                }
                   if (e.target.id === 'stock-search-input') {
                    populateStockSummary();
                }
            });

            document.body.addEventListener('change', (e) => {
                if (e.target.id === 'import-product-id') {
                    const product = db.products.find(p => String(p.id).trim() === e.target.value.trim());
                    document.getElementById('import-product-name').value = product ? product.name : '';
                    document.getElementById('import-customer').value = product ? product.customer || '' : '';
                    document.getElementById('import-erp-code').value = product ? product.erpCode : '';
                    document.getElementById('import-fullbox').value = product ? product.fullBoxQuantity : '';
                }
                if (e.target.id === 'export-product-id') {
                    const product = db.products.find(p => String(p.id).trim() === e.target.value.trim());
                    document.getElementById('export-product-name').value = product ? product.name : '';
                    document.getElementById('export-customer').value = product ? product.customer || '' : '';
                    document.getElementById('export-erp-code').value = product ? product.erpCode : '';
                    document.getElementById('export-fullbox').value = product ? product.fullBoxQuantity : '';
                    populateExportLotsList(e.target.value);
                }
                if (e.target.type === 'checkbox' && e.target.closest('.export-lot-row')) {
                    const row = e.target.closest('.export-lot-row');
                    const quantityInput = row.querySelector('.export-quantity');
                    quantityInput.disabled = !e.target.checked;
                    if (!e.target.checked) {
                        quantityInput.value = '';
                    }
                    updateExportTotal();
                }
                   if (e.target.id === 'show-old-stock-filter') {
                    populateStockSummary();
                }
            });
            
            document.body.addEventListener('submit', function(e) {
                if(e.target.id === 'import-form') handleImport(e);
                if(e.target.id === 'export-form') handleExport(e);
                if(e.target.id === 'product-form') handleProductFormSubmit(e);
                if(e.target.id === 'user-form') handleUserFormSubmit(e);
                if(e.target.id === 'announcement-form') handleAnnouncementFormSubmit(e);
                if(e.target.id === 'history-filter-form') {
                    e.preventDefault();
                    hasHistoryBeenSearched = true;
                    populateHistoryTable();
                }
                if(e.target.id === 'edit-stock-form') handleEditStockSubmit(e);
            });

            document.body.addEventListener('click', function(e) {
                if (e.target.id === 'add-import-lot-btn') addImportLotRow();
                if (e.target.classList.contains('remove-import-lot-btn')) {
                    e.target.closest('.import-lot-row').remove();
                    updateImportTotal();
                }
                if (e.target.id === 'clear-import-form-btn') renderImportForm();
                if (e.target.id === 'clear-export-form-btn') renderExportForm();
                if (e.target.id === 'clear-product-form-btn') clearProductForm();
                if (e.target.id === 'clear-user-form-btn') clearUserForm();
                if (e.target.id === 'clear-announcement-form-btn') clearAnnouncementForm();
                if (e.target.id === 'history-filter-reset-btn') {
                    document.getElementById('filter-product-id').value = '';
                    hasHistoryBeenSearched = false;
                    setTimeout(() => populateHistoryTable(), 0);
                }
                if (!e.target.closest('.position-relative')) {
                    document.querySelectorAll('.suggestions-container').forEach(c => c.innerHTML = '');
                }

                if (e.target.closest('.reverse-history-btn')) {
                    const button = e.target.closest('.reverse-history-btn');
                    const historyItemString = button.dataset.historyItem;
                    if (historyItemString) {
                        try {
                            const historyItem = JSON.parse(historyItemString);
                            window.app.reverseHistory(historyItem);
                        } catch (err) {
                            console.error("Failed to parse history item from data attribute:", err);
                            showError("Error", "Could not process the request.");
                        }
                    }
                }

                // NEW: Stock Count Listeners
                if (e.target.id === 'start-stock-count-btn') {
                    window.app.startNewStockCount();
                }
                if (e.target.id === 'save-stock-count-btn') {
                    window.app.saveStockCount();
                }
                const viewReportBtn = e.target.closest('.view-stock-count-report-btn');
                if (viewReportBtn) {
                    window.app.viewStockCountReport(viewReportBtn.dataset.countId);
                }
                const approveBtn = e.target.closest('.approve-stock-count-btn');
                if (approveBtn) {
                    window.app.approveStockCount(approveBtn.dataset.countId);
                }

                // NEW: Dashboard filter button
                if (e.target.id === 'dashboard-filter-btn') {
                    const startDate = dashboardStartDateInput.value;
                    const endDate = dashboardEndDateInput.value;
                    if (startDate && endDate) {
                        populateSalesDashboard(new Date(startDate), new Date(endDate));
                    } else {
                        showError('ข้อมูลไม่ครบถ้วน', 'กรุณาเลือกวันที่เริ่มต้นและวันที่สิ้นสุด');
                    }
                }
            });
        }

        /**
         * [SECURITY WARNING] This login method is insecure. It fetches all user data, including passwords,
         * to the client-side for validation. In a production environment, the username and password
         * should be sent to the server (Google Apps Script), and the server should validate them
         * without ever sending the password list to the client.
         */
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const foundUser = db.users.find(u => u.username === username && u.password === password);
            if (foundUser) {
                sessionStorage.setItem('currentUser', JSON.stringify(foundUser));
                checkLoginState();
            } else {
                errorMessage.classList.remove('d-none');
            }
        }
        
        // --- HELPER FUNCTIONS ---
        function formatDate(dateInput) {
            if (!dateInput || dateInput === 'Manual Adjustment' || dateInput === 'Stock Count Adjustment') return dateInput;
            let date;
            if (!isNaN(dateInput) && Number.isFinite(Number(dateInput))) { date = new Date(Number(dateInput)); } 
            else if (typeof dateInput === 'string' && dateInput.includes('T')) { date = new Date(dateInput); } 
            else if (typeof dateInput === 'string') {
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateInput)) return dateInput;
                date = new Date(dateInput);
            } else { return dateInput; }
            if (isNaN(date.getTime())) return dateInput;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function showSuccess(title, text='') { Swal.fire({ title: title, text: text, icon: 'success', timer: 2000, showConfirmButton: false }); }
        function showError(title, text) { Swal.fire(title, text, 'error'); }
        function confirmAction(title, text, callback) { 
            Swal.fire({ 
                title: title, 
                text: text, 
                icon: 'question', 
                showCancelButton: true, 
                confirmButtonText: translations[currentLanguage].ok_button, 
                cancelButtonText: translations[currentLanguage].cancel_button,
                confirmButtonColor: '#0d6efd',
                cancelButtonColor: '#6c757d'
            }).then((r) => { if (r.isConfirmed) callback(); }); 
        }
        
        function confirmDestructiveAction(text, callback) {
            const T = translations[currentLanguage];
            const confirmWord = T.confirm_delete_prompt === "Please type 'delete' to confirm" ? "delete" : "ลบ";

            Swal.fire({
                title: T.confirm_delete_title,
                text: text,
                icon: 'warning',
                input: 'text',
                inputPlaceholder: T.confirm_delete_prompt,
                showCancelButton: true,
                confirmButtonText: T.ok_button,
                cancelButtonText: T.cancel_button,
                confirmButtonColor: '#dc3545',
                preConfirm: (inputValue) => {
                    if (inputValue.toLowerCase() !== confirmWord) {
                        Swal.showValidationMessage(`Please type "${confirmWord}" to proceed.`);
                        return false;
                    }
                    return true;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    callback();
                }
            });
        }

        function backupToCSV(data, filename, footer = null) {
            if (!data || data.length === 0) {
                showError('No Data', translations[currentLanguage].backup_no_data);
                return;
            }

            const allKeys = new Set();
            data.forEach(row => {
                Object.keys(row).forEach(key => allKeys.add(key));
            });
            const headers = Array.from(allKeys);
            const csvRows = [headers.join(',')];

            data.forEach(row => {
                const values = headers.map(header => {
                    const val = row[header] === null || row[header] === undefined ? '' : row[header];
                    const escaped = ('' + val).replace(/"/g, '""');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            });

            if (footer) {
                csvRows.push(''); 
                csvRows.push(''); 
                
                const footerCols = new Array(headers.length).fill('');
                footerCols[0] = `"${footer.left}"`; 
                footerCols[headers.length - 1] = `"${footer.right}"`; 
                csvRows.push(footerCols.join(','));
            }

            const blob = new Blob(['\uFEFF' + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showSuccess(translations[currentLanguage].backup_downloading.replace('{filename}', filename));
        }
        
        function getFilteredHistory() {
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            const type = document.getElementById('filter-type').value;
            const productId = document.getElementById('filter-product-id').value;
            const invoiceSearch = document.getElementById('filter-invoice-search').value.toLowerCase();

            let filteredHistory = Array.isArray(db.history) ? db.history : [];

            if (startDate) { filteredHistory = filteredHistory.filter(item => item && item.date && String(item.date).split('T')[0] >= startDate); }
            if (endDate) { filteredHistory = filteredHistory.filter(item => item && item.date && String(item.date).split('T')[0] <= endDate); }
            if (type) { filteredHistory = filteredHistory.filter(item => item && item.type === type); }
            if (productId) { filteredHistory = filteredHistory.filter(item => item && String(item.productId).trim() === String(productId).trim()); }
            if (invoiceSearch) { filteredHistory = filteredHistory.filter(item => item && item.invoiceNumber && String(item.invoiceNumber).toLowerCase().includes(invoiceSearch));}
            
            return filteredHistory;
        }
        
        function generateStockBackupData() {
            const T = translations[currentLanguage];
            const stockBackup = [];
            calculatedStock.forEach(product => {
                product.lots.forEach(lot => {
                    if (lot.quantity > 0) {
                        let productInfo = db.products.find(p => String(p.id).trim() === String(product.productId).trim());
                        if (!productInfo) {
                            productInfo = { name: T.product_not_found.replace('{id}', product.productId), customer: '-', erpCode: '-' };
                        }
                        stockBackup.push({
                            productId: product.productId,
                            productName: productInfo.name,
                            customer: productInfo.customer,
                            erpCode: productInfo.erpCode,
                            productionDate: lot.productionDate,
                            quantity: lot.quantity,
                            packagingType: lot.packagingType
                        });
                    }
                });
            });
            return stockBackup;
        }

        function populateUserManagementTable() { 
            const T = translations[currentLanguage];
            const header = document.getElementById('user-management-table-header');
            header.innerHTML = `<tr><th>${T.username_label}</th><th>${T.user_role}</th><th>${T.actions}</th></tr>`;
            
            const userManagementTable = document.getElementById('user-management-table');
            userManagementTable.innerHTML = ''; 
            if (db.users.length === 0) {
                userManagementTable.innerHTML = `<tr><td colspan="3" class="text-center p-4">${T.user_management_no_data}</td></tr>`;
                return;
            }
            db.users.forEach(u => { 
                const r = document.createElement('tr'); 
                r.innerHTML = `<td><i class="bi bi-person-circle me-2"></i>${u.username}</td><td><span class="badge rounded-pill ${u.role === 'admin' ? 'bg-success' : 'bg-info text-dark'}">${u.role}</span></td><td><button class="btn btn-warning btn-sm" onclick="window.app.editUser('${u.username}')"><i class="bi bi-pencil-fill"></i></button> ${u.username !== 'admin' ? `<button class="btn btn-danger btn-sm" onclick="window.app.deleteUser('${u.username}')"><i class="bi bi-trash3-fill"></i></button>` : ''}</td>`; 
                userManagementTable.appendChild(r); 
            }); 
        }

        function populateProductManagementTable() {
            const T = translations[currentLanguage];
            const header = document.getElementById('product-management-table-header');
            header.innerHTML = `<tr><th>${T.product_id}</th><th>${T.product_name}</th><th>${T.customer}</th><th>${T.product_table_price}</th><th>${T.actions}</th></tr>`;

            const productManagementTable = document.getElementById('product-management-table');
            productManagementTable.innerHTML = '';
            if (db.products.length === 0) {
                productManagementTable.innerHTML = `<tr><td colspan="5" class="text-center p-4">${T.product_management_no_data}</td></tr>`;
                return;
            }
            db.products.forEach(p => {
                const r = document.createElement('tr');
                r.innerHTML = `<td>${p.id}</td><td>${p.name}</td><td>${p.customer || '-'}</td><td>${Number(p.unitPrice || 0).toFixed(2)}</td><td><button class="btn btn-warning btn-sm" onclick="window.app.editProduct('${p.id}')"><i class="bi bi-pencil-fill"></i></button> <button class="btn btn-danger btn-sm" onclick="window.app.deleteProduct('${p.id}')"><i class="bi bi-trash3-fill"></i></button></td>`;
                productManagementTable.appendChild(r);
            });
        }

        function populateAnnouncementsTable() {
            const T = translations[currentLanguage];
            const header = document.getElementById('announcement-management-table-header');
            header.innerHTML = `<tr>
                <th>${T.announcement_table_header_title}</th>
                <th>${T.announcement_table_status}</th>
                <th>${T.announcement_table_posted_by}</th>
                <th>${T.announcement_table_posted_date}</th>
                <th>${T.actions}</th>
            </tr>`;

            const announcementManagementTable = document.getElementById('announcement-management-table');
            announcementManagementTable.innerHTML = '';
            const sortedAnnouncements = [...db.announcements].sort((a, b) => new Date(b.postedDate) - new Date(a.postedDate));

            if (sortedAnnouncements.length === 0) {
                announcementManagementTable.innerHTML = `<tr><td colspan="5" class="text-center p-4">${T.announcement_management_no_data}</td></tr>`;
                return;
            }

            sortedAnnouncements.forEach(ann => {
                const row = document.createElement('tr');
                const formattedDate = new Date(ann.postedDate).toLocaleString(currentLanguage === 'th' ? 'th-TH' : 'en-GB', {
                    year: 'numeric', month: 'short', day: 'numeric', timeZone: 'Asia/Bangkok'
                });
                const statusBadge = ann.isActive 
                    ? `<span class="badge bg-success-subtle text-success-emphasis rounded-pill">${T.announcement_status_active}</span>`
                    : `<span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">${T.announcement_status_inactive}</span>`;
                
                row.innerHTML = `
                    <td>${ann.title}</td>
                    <td>${statusBadge}</td>
                    <td>${ann.postedBy}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="window.app.editAnnouncement('${ann.id}')"><i class="bi bi-pencil-fill"></i></button>
                        <button class="btn btn-info btn-sm" onclick="window.app.toggleAnnouncementStatus('${ann.id}')"><i class="bi bi-toggle-${ann.isActive ? 'on' : 'off'}"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="window.app.deleteAnnouncement('${ann.id}')"><i class="bi bi-trash3-fill"></i></button>
                    </td>`;
                announcementManagementTable.appendChild(row);
            });
        }

        function displayActiveAnnouncements() {
            const T = translations[currentLanguage];
            const announcementsDisplayArea = document.getElementById('announcements-display-area');
            announcementsDisplayArea.innerHTML = '';
            const activeAnnouncements = db.announcements.filter(ann => ann.isActive)
                                                           .sort((a, b) => new Date(b.postedDate) - new Date(a.postedDate));

            if (activeAnnouncements.length === 0) return;

            activeAnnouncements.forEach(ann => {
                const formattedDate = new Date(ann.postedDate).toLocaleString(currentLanguage === 'th' ? 'th-TH' : 'en-GB', {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Bangkok'
                });
                const footerText = T.announcement_posted_by_on.replace('{user}', ann.postedBy).replace('{date}', formattedDate);
                const announcementHtml = `
                    <div class="card announcement-card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-megaphone-fill me-2"></i>${ann.title}</span>
                            <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill">${T.announcement_badge}</span>
                        </div>
                        <div class="card-body">
                            <p class="card-text">${ann.message}</p>
                        </div>
                        <div class="card-footer text-end">${footerText}</div>
                    </div>`;
                announcementsDisplayArea.insertAdjacentHTML('beforeend', announcementHtml);
            });
        }

        function populateExportLotsList(productId) {
            const T = translations[currentLanguage];
            const container = document.getElementById('export-lots-container');
            container.innerHTML = '';
            if (!productId) {
                container.innerHTML = `<p class="text-muted text-center">${T.export_lot_placeholder_no_product}</p>`;
                return;
            }

            const productStock = calculatedStock.find(p => String(p.productId).trim() === String(productId).trim());
            const lots = productStock ? productStock.lots.filter(l => l.quantity > 0) : [];

            if (lots.length === 0) {
                container.innerHTML = `<p class="text-muted text-center">${T.export_lot_placeholder_no_stock}</p>`;
                return;
            }
            
            lots.sort((a, b) => new Date(a.productionDate) - new Date(b.productionDate));

            lots.forEach(lot => {
                const totalQuantity = lot.quantity;
                const row = document.createElement('div');
                row.className = 'row g-2 mb-2 align-items-center export-lot-row';
                row.dataset.date = lot.productionDate;
                row.dataset.packaging = lot.packagingType; // NEW: Add packaging type to dataset

                // NEW: Add a badge for temporary packing
                let packagingBadge = '';
                if (lot.packagingType === 'temporary') {
                    packagingBadge = `<span class="badge bg-warning-subtle text-warning-emphasis rounded-pill">${T.packaging_temp}</span>`;
                }

                row.innerHTML = `
                    <div class="col-auto">
                        <input class="form-check-input" type="checkbox">
                    </div>
                    <div class="col">
                        <label class="form-check-label">${T.export_lot_option.replace('{date}', lot.productionDate).replace('{qty}', totalQuantity.toLocaleString())}${packagingBadge}</label>
                    </div>
                    <div class="col-4">
                        <input type="number" class="form-control form-control-sm export-quantity" placeholder="${T.export_quantity_placeholder.replace('{qty}', totalQuantity)}" min="1" max="${totalQuantity}" disabled>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function populateLotDetailsTable(productId) {
            const T = translations[currentLanguage];
            const header = document.getElementById('lot-detail-table-header');
            // NEW: Add packaging type column to header
            header.innerHTML = `<tr>
                <th>${T.production_date}</th>
                <th>${T.packaging_type}</th>
                <th>${T.lot_modal_balance}</th>
            </tr>`;
            
            const lotDetailTable = document.getElementById('lot-detail-table');
            lotDetailTable.innerHTML = '';
            
            const productStock = calculatedStock.find(p => String(p.productId).trim() === String(productId).trim());
            const lots = productStock ? productStock.lots.filter(l => l.quantity > 0) : [];
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

            if(lots.length === 0) {
                lotDetailTable.innerHTML = `<tr><td colspan="3" class="text-center">${T.lot_modal_no_data}</td></tr>`; // Changed colspan to 3
                return;
            }

            lots.sort((a, b) => new Date(a.productionDate) - new Date(b.productionDate));

            lots.forEach(lot => {
                const isOld = new Date(lot.productionDate) < threeMonthsAgo && !lot.isAdjustment;
                const row = document.createElement('tr');
                if (isOld) row.classList.add('table-warning');

                // NEW: Create badge for packaging type
                let packagingBadge;
                if (lot.packagingType === 'temporary') {
                    packagingBadge = `<span class="badge bg-warning-subtle text-warning-emphasis rounded-pill">${T.packaging_temp}</span>`;
                } else {
                    packagingBadge = `<span class="badge bg-success-subtle text-success-emphasis rounded-pill">${T.packaging_std}</span>`;
                }
                
                row.innerHTML = `
                    <td>${lot.productionDate} ${lot.isAdjustment ? '(Manual Adjustment)' : ''} ${isOld ? '<i class="bi bi-exclamation-triangle-fill text-danger ms-2"></i>' : ''}</td>
                    <td>${packagingBadge}</td>
                    <td>${lot.quantity.toLocaleString()}</td>`;
                lotDetailTable.appendChild(row);
            });
        }

        function showSuggestions(inputEl, containerEl, productSource, searchTerm) {
            containerEl.innerHTML = '';
            if (!searchTerm) return;
            const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();
            const filteredProducts = productSource.filter(p => String(p.id).trim().toLowerCase().includes(lowerCaseSearchTerm) || p.name.toLowerCase().includes(lowerCaseSearchTerm));
            filteredProducts.slice(0, 5).forEach(item => {
                const suggestionEl = document.createElement('a');
                suggestionEl.href = '#';
                suggestionEl.classList.add('list-group-item', 'list-group-item-action');
                suggestionEl.textContent = `${item.id} - ${item.name}`;
                suggestionEl.addEventListener('click', (e) => {
                    e.preventDefault();
                    inputEl.value = item.id;
                    containerEl.innerHTML = '';
                    inputEl.dispatchEvent(new Event('change', { bubbles: true }));
                });
                containerEl.appendChild(suggestionEl);
            });
        }

        function showFilterSuggestions(inputEl, containerEl, productSource, searchTerm) {
            const hiddenInputEl = document.getElementById('filter-product-id');
            containerEl.innerHTML = '';
            if (!searchTerm) {
                hiddenInputEl.value = '';
                return;
            }
            const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();
            const filteredProducts = productSource.filter(p => String(p.id).trim().toLowerCase().includes(lowerCaseSearchTerm) || p.name.toLowerCase().includes(lowerCaseSearchTerm));
            filteredProducts.slice(0, 5).forEach(item => {
                const suggestionEl = document.createElement('a');
                suggestionEl.href = '#';
                suggestionEl.classList.add('list-group-item', 'list-group-item-action', 'p-2');
                suggestionEl.textContent = `${item.id} - ${item.name}`;
                suggestionEl.addEventListener('click', (e) => {
                    e.preventDefault();
                    inputEl.value = `${item.id} - ${item.name}`;
                    hiddenInputEl.value = item.id;
                    containerEl.innerHTML = '';
                });
                containerEl.appendChild(suggestionEl);
            });
        }

        function clearProductForm() {
            editingProductId = null;
            productFormEl.reset();
            document.getElementById('product-id').readOnly = false;
        }

        function clearUserForm() {
            originalUsernameForEdit = null;
            userFormEl.reset();
            document.getElementById('user-username').readOnly = false;
            renderUserForm();
        }

        function clearAnnouncementForm() {
            editingAnnouncementId = null;
            announcementFormEl.reset();
            document.getElementById('announcement-active').checked = true; // Default to active
        }

        function addImportLotRow() {
            const T = translations[currentLanguage];
            const container = document.getElementById('import-lots-container');
            const newRow = document.createElement('div');
            newRow.className = 'row g-2 mb-2 align-items-center import-lot-row';
            // UPDATED: Added required attribute and a disabled default option
            newRow.innerHTML = `
                <div class="col-md-4">
                    <label class="form-label visually-hidden">${T.production_date}</label>
                    <input type="date" class="form-control import-prod-date" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label visually-hidden">${T.packaging_type}</label>
                    <select class="form-select import-packaging-type" required>
                        <option value="" selected disabled>${T.packaging_placeholder}</option>
                        <option value="standard">${T.packaging_std}</option>
                        <option value="temporary">${T.packaging_temp}</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label visually-hidden">${T.quantity}</label>
                    <input type="number" class="form-control import-quantity" placeholder="${T.quantity}" required min="1">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm w-100 remove-import-lot-btn"><i class="bi bi-trash3-fill"></i></button>
                </div>
            `;
            container.appendChild(newRow);
        }

        function updateImportTotal() {
            const lotQuantities = document.querySelectorAll('#import-lots-container .import-quantity');
            let total = 0;
            lotQuantities.forEach(input => {
                total += parseInt(input.value) || 0;
            });
            document.getElementById('import-total-quantity').value = total.toLocaleString();
        }

        function updateExportTotal() {
            const lotRows = document.querySelectorAll('#export-lots-container .export-lot-row:has(input[type="checkbox"]:checked)');
            let total = 0;
            lotRows.forEach(row => {
                const quantityInput = row.querySelector('.export-quantity');
                total += parseInt(quantityInput.value) || 0;
            });
            document.getElementById('export-total-quantity').value = total.toLocaleString();
        }

        function renderImportForm() {
            const T = translations[currentLanguage];
            const importFormEl = document.getElementById('import-form');
            importFormEl.innerHTML = `
                <div class="col-md-4"> <label for="import-product-id" class="form-label">${T.product_id}</label> <div class="position-relative"> <input type="text" id="import-product-id" class="form-control" required autocomplete="off" placeholder="${T.search_placeholder}"> <div id="import-product-suggestions" class="list-group position-absolute w-100 suggestions-container"></div> </div> </div>
                <div class="col-md-5"> <label for="import-product-name" class="form-label">${T.product_name}</label> <input type="text" id="import-product-name" class="form-control" readonly style="background-color: #e9ecef;"> </div>
                <div class="col-md-3"> <label for="import-fullbox" class="form-label">${T.import_fullbox}</label> <input type="text" id="import-fullbox" class="form-control" readonly style="background-color: #e9ecef;"> </div>
                <div class="col-md-6"> <label for="import-customer" class="form-label">${T.customer}</label> <input type="text" id="import-customer" class="form-control" readonly style="background-color: #e9ecef;"> </div>
                <div class="col-md-6"> <label for="import-erp-code" class="form-label">${T.erp_code}</label> <input type="text" id="import-erp-code" class="form-control" readonly style="background-color: #e9ecef;"> </div>
                <hr class="my-3">
                <div id="import-lots-container" class="col-12"></div>
                <div class="col-12"><button type="button" id="add-import-lot-btn" class="btn btn-sm btn-outline-primary"><i class="bi bi-plus-circle-fill me-1"></i>${T.import_add_lot_button}</button></div>
                <hr class="my-3">
                <div class="col-md-4"> <label for="import-total-quantity" class="form-label">${T.import_total_quantity}</label> <input type="text" id="import-total-quantity" class="form-control fw-bold" readonly style="background-color: #e9ecef; font-size: 1.2rem;"> </div>
                <div class="col-md-8"> <label for="import-remarks" class="form-label">${T.remarks}</label> <textarea id="import-remarks" class="form-control" rows="2"></textarea> </div>
                <div class="col-12 mt-2"> <p class="text-danger fw-bold"><i class="bi bi-exclamation-triangle-fill me-2"></i>${T.import_warning}</p> </div>
                <div class="col-12"> <button type="submit" class="btn btn-primary"><i class="bi bi-save-fill me-2"></i>${T.import_save_button}</button> <button type="button" id="clear-import-form-btn" class="btn btn-secondary ms-2"><i class="bi bi-eraser-fill me-2"></i>${T.clear_form_button}</button> </div>`;
            addImportLotRow();
        }

function renderExportForm() {
        const T = translations[currentLanguage];
        const exportFormEl = document.getElementById('export-form');
        exportFormEl.innerHTML = `
            <div class="col-md-4"> <label for="export-product-id" class="form-label">${T.product_id}</label> <div class="position-relative"> <input type="text" id="export-product-id" class="form-control" required autocomplete="off" placeholder="${T.search_placeholder}"> <div id="export-product-suggestions" class="list-group position-absolute w-100 suggestions-container"></div> </div> </div>
            <div class="col-md-5"> <label for="export-product-name" class="form-label">${T.product_name}</label> <input type="text" id="export-product-name" class="form-control" readonly style="background-color: #e9ecef;"> </div>
            <div class="col-md-3"> <label for="export-fullbox" class="form-label">${T.import_fullbox}</label> <input type="text" id="export-fullbox" class="form-control" readonly style="background-color: #e9ecef;"> </div>
            <div class="col-md-6"> <label for="export-customer" class="form-label">${T.customer}</label> <input type="text" id="export-customer" class="form-control" readonly style="background-color: #e9ecef;"> </div>
            <div class="col-md-6"> <label for="export-erp-code" class="form-label">${T.erp_code}</label> <input type="text" id="export-erp-code" class="form-control" readonly style="background-color: #e9ecef;"> </div>
            <hr class="my-3">
            <div class="col-12"><label class="form-label fw-bold">${T.export_lot_select}</label><div id="export-lots-container" class="border rounded p-2 bg-light"></div></div>
            <hr class="my-3">
            <div class="col-md-3"> <label for="export-total-quantity" class="form-label">${T.export_total_quantity}</label> <input type="text" id="export-total-quantity" class="form-control fw-bold" value="0" readonly style="background-color: #e9ecef; font-size: 1.2rem;"> </div>
            
            <div class="col-md-3"> 
                <label for="export-type" class="form-label">${T.export_type_label}</label> 
                <select id="export-type" class="form-select" required>
                    <option value="Sale" selected>${T.export_type_sale}</option>
                    <option value="Production">${T.export_type_production}</option>
                    <option value="QC">${T.export_type_qc}</option>
                    <option value="Other">${T.export_type_other}</option>
                </select> 
            </div>
            <div class="col-md-3"> <label for="export-invoice-number" class="form-label">${T.export_invoice}</label> <input type="text" id="export-invoice-number" class="form-control"> </div>
            <div class="col-md-3"> <label for="export-remarks" class="form-label">${T.remarks}</label> <textarea id="export-remarks" class="form-control" rows="1"></textarea> </div>

            <div class="col-12 mt-2"> <p class="text-danger fw-bold"><i class="bi bi-exclamation-triangle-fill me-2"></i>${T.export_warning}</p> </div>
            <div class="col-12 mt-3"> <button type="submit" class="btn btn-success"><i class="bi bi-send-check-fill me-2"></i>${T.export_save_button}</button> <button type="button" id="clear-export-form-btn" class="btn btn-secondary ms-2"><i class="bi bi-eraser-fill me-2"></i>${T.clear_form_button}</button> </div>`;
    }        
		function renderProductForm() {
            const T = translations[currentLanguage];
            const productFormEl = document.getElementById('product-form');
            productFormEl.innerHTML = `
                <div class="col-12"> <label for="product-id" class="form-label">${T.product_id}</label> <input type="text" id="product-id" class="form-control" required> </div>
                <div class="col-12"> <label for="product-name" class="form-label">${T.product_name}</label> <input type="text" id="product-name" class="form-control" required> </div>
                <div class="col-12"> <label for="product-customer" class="form-label">${T.customer}</label> <input type="text" id="product-customer" class="form-control"> </div>
                <div class="col-12"> <label for="product-fullBoxQuantity" class="form-label">${T.product_fullbox_rack}</label> <input type="number" id="product-fullBoxQuantity" class="form-control" required min="1"> </div>
                <div class="col-12"> <label for="product-erpCode" class="form-label">${T.erp_code}</label> <input type="text" id="product-erpCode" class="form-control"> </div>
                <div class="col-12"> <label for="product-unitPrice" class="form-label">${T.product_unit_price}</label> <input type="number" step="0.01" id="product-unitPrice" class="form-control" required min="0"> </div>
                <div class="col-12"> <button type="submit" class="btn btn-primary w-100"><i class="bi bi-save-fill me-2"></i>${T.product_save_button}</button> <button type="button" id="clear-product-form-btn" class="btn btn-secondary w-100 mt-2">${T.clear_form_button}</button> </div>`;
        }

        function renderUserForm(user = {}) {
            const T = translations[currentLanguage];
            const userFormEl = document.getElementById('user-form');
            const permissions = [
                { key: 'canImport', label: T.permission_canImport },
                { key: 'canExport', label: T.permission_canExport },
                { key: 'canViewHistory', label: T.permission_canViewHistory },
                { key: 'canCountStock', label: T.permission_canCountStock },
                { key: 'canManageProducts', label: T.permission_canManageProducts },
                { key: 'canManageUsers', label: T.permission_canManageUsers },
                { key: 'canManageAnnouncements', label: T.permission_canManageAnnouncements }
            ];

            let permissionsHtml = permissions.map(p => `
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="permission-${p.key}" ${user[p.key] ? 'checked' : ''}>
                    <label class="form-check-label" for="permission-${p.key}">${p.label}</label>
                </div>
            `).join('');

            userFormEl.innerHTML = `
                <div class="col-12"> <label for="user-username" class="form-label">${T.username_label}</label> <input type="text" id="user-username" class="form-control" required value="${user.username || ''}"> </div>
                <div class="col-12"> <label for="user-password" class="form-label">${T.password_label}</label> <input type="password" id="user-password" class="form-control" required value="${user.password || ''}"> </div>
                <div class="col-12"> <label for="user-role-select" class="form-label">${T.user_role}</label> <select id="user-role-select" class="form-select" required><option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option><option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option></select> </div>
                <div class="col-12 mt-3"> <label class="form-label fw-bold">${T.user_permissions}</label> <div class="border rounded p-2 bg-light">${permissionsHtml}</div> </div>
                <div class="col-12 mt-4"> <button type="submit" class="btn btn-primary w-100"><i class="bi bi-save-fill me-2"></i>${T.user_save_button}</button> <button type="button" id="clear-user-form-btn" class="btn btn-secondary w-100 mt-2">${T.clear_form_button}</button> </div>`;
        }
        
        function renderAnnouncementForm(announcement = {}) {
            const T = translations[currentLanguage];
            const announcementFormEl = document.getElementById('announcement-form');
            announcementFormEl.innerHTML = `
                <input type="hidden" id="announcement-id" value="${announcement.id || ''}">
                <div class="col-12"> <label for="announcement-title" class="form-label">${T.announcement_title}</label> <input type="text" id="announcement-title" class="form-control" required value="${announcement.title || ''}"> </div>
                <div class="col-12"> <label for="announcement-message" class="form-label">${T.announcement_message}</label> <textarea id="announcement-message" class="form-control" rows="4" required>${announcement.message || ''}</textarea> </div>
                <div class="col-12">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="announcement-active" ${announcement.isActive === false ? '' : 'checked'}>
                        <label class="form-check-label" for="announcement-active">${T.announcement_show}</label>
                    </div>
                </div>
                <div class="col-12"> <button type="submit" class="btn btn-primary w-100"><i class="bi bi-save-fill me-2"></i>${T.announcement_save_button}</button> <button type="button" id="clear-announcement-form-btn" class="btn btn-secondary w-100 mt-2">${T.clear_form_button}</button> </div>`;
        }

        function renderHistoryFilterForm() {
            const T = translations[currentLanguage];
            const historyFilterForm = document.getElementById('history-filter-form');
            historyFilterForm.innerHTML = `
                <div class="col-lg-2 col-md-6"> <label for="filter-start-date" class="form-label">${T.history_filter_from}</label> <input type="date" id="filter-start-date" class="form-control form-control-sm"> </div>
                <div class="col-lg-2 col-md-6"> <label for="filter-end-date" class="form-label">${T.history_filter_to}</label> <input type="date" id="filter-end-date" class="form-control form-control-sm"> </div>
                <div class="col-lg-2 col-md-6"> <label for="filter-type" class="form-label">${T.history_filter_type}</label> <select id="filter-type" class="form-select form-select-sm"> <option value="">${T.history_filter_type_all}</option> <option value="import">${T.history_filter_type_import}</option> <option value="export">${T.history_filter_type_export}</option> <option value="adjustment">${T.history_filter_type_adjustment}</option><option value="reversal">${T.history_filter_type_reversal}</option> </select> </div>
                <div class="col-lg-2 col-md-6"> <label for="filter-product-search" class="form-label">${T.history_filter_product}</label> <div class="position-relative"> <input type="text" id="filter-product-search" class="form-control form-control-sm" placeholder="${T.history_filter_type_all}" autocomplete="off"> <input type="hidden" id="filter-product-id"> <div id="filter-product-suggestions" class="list-group position-absolute w-100 suggestions-container"></div> </div> </div>
                <div class="col-lg-2 col-md-6"> <label for="filter-invoice-search" class="form-label">${T.history_filter_invoice}</label> <input type="text" id="filter-invoice-search" class="form-control form-control-sm" placeholder="${T.search_placeholder}" autocomplete="off"> </div>
                <div class="col-lg-2 col-md-12 d-flex mt-auto"> <button type="submit" class="btn btn-primary btn-sm flex-grow-1 me-1"><i class="bi bi-search me-1"></i>${T.history_filter_search}</button> <button type="reset" id="history-filter-reset-btn" class="btn btn-secondary btn-sm flex-grow-1 ms-1">${T.history_filter_clear}</button> </div>`;
        }
        
        function renderEditStockForm(product, totalQuantity) {
            const T = translations[currentLanguage];
            const editStockForm = document.getElementById('edit-stock-form');
            editStockForm.innerHTML = `
                <input type="hidden" id="edit-stock-product-id" value="${product.id}">
                <div class="mb-3"> <label class="form-label">${T.product_name}</label> <input type="text" id="edit-stock-product-name" class="form-control" value="${product.id} - ${product.name}" readonly> </div>
                <div class="mb-3"> <label for="edit-stock-quantity" class="form-label">${T.edit_stock_new_total}</label> <input type="number" id="edit-stock-quantity" class="form-control" value="${totalQuantity}" required min="0"> </div>
                <div class="form-text text-danger">${T.edit_stock_note}</div>
                <div class="d-grid mt-3"> <button type="submit" class="btn btn-primary">${T.edit_stock_save_button}</button> </div>`;
        }

        /**
         * Recalculates the entire stock from history using a "wipe and replace" logic for adjustments.
         */
        function calculateStockFromHistory() {
            const stockLedger = new Map();
            const sortedHistory = [...db.history].sort((a, b) => new Date(a.date) - new Date(b.date));

            for (const item of sortedHistory) {
                if (!item || !item.productId) continue;

                const productId = String(item.productId).trim();
                
                if (item.type === 'adjustment') {
                    // This logic handles adjustments by effectively resetting the stock for a product
                    // and then applying subsequent transactions.
                    
                    // Find all existing lots for this product in the ledger and delete them
                    const keysToDelete = Array.from(stockLedger.keys()).filter(key => key.startsWith(`${productId}::`));
                    keysToDelete.forEach(key => stockLedger.delete(key));

                    // Parse the new total from the machine-readable part of the remark
                    let newTotalQuantity = 0;
                    const remarks = item.remarks || '';
                    let match = remarks.match(/^MANUAL_ADJ_NEW_TOTAL:(\d+(\.\d+)?)/);
                    if (!match) {
                        match = remarks.match(/^STOCK_COUNT_ADJ:/);
                    }

                    if (match) {
                        // For manual adjustments, the new total is in the remark.
                        // For stock count adjustments, the quantity is the variance.
                        if (remarks.startsWith('MANUAL_ADJ')) {
                            newTotalQuantity = parseFloat(remarks.split(':')[1].split('|')[0]);
                        } else { // Stock Count
                            newTotalQuantity = parseFloat(item.quantity);
                        }
                    } else { // Fallback for old format
                           const oldMatch = remarks.match(/to (\d+)/);
                           if (oldMatch) newTotalQuantity = parseInt(oldMatch[1], 10);
                           else newTotalQuantity = parseFloat(item.quantity); // For stock count adjustments
                    }
                    
                    // Create a new single pseudo-lot representing the adjusted total
                    const adjustmentDate = formatDate(item.date);
                    const newKey = `${productId}::${adjustmentDate}`;
                    stockLedger.set(newKey, {
                        productId: productId,
                        productionDate: adjustmentDate,
                        quantity: newTotalQuantity,
                        isAdjustment: true,
                        packagingType: 'standard' // Adjustments are considered standard
                    });
                    
                    continue; // Move to the next history item
                }
                
                // Regular logic for import, export, reversal
                const prodDate = item.productionDate || item.ProductionDate || item.production_date;
                const lotDate = formatDate(prodDate);
                if (!lotDate) continue; // Skip items without a valid lot date
                
                // =================================================================
                // === BUG FIX: Include packagingType in the key for uniqueness ===
                // =================================================================
                const packagingType = item.packagingType || 'standard';
                const key = `${productId}::${lotDate}::${packagingType}`;
                // =================================================================

                if (!stockLedger.has(key)) {
                    stockLedger.set(key, {
                        productId: productId,
                        productionDate: lotDate,
                        quantity: 0,
                        isAdjustment: false,
                        packagingType: packagingType // Use the variable created above
                    });
                }

                const itemQuantity = parseFloat(item.quantity) || 0;
                const currentLot = stockLedger.get(key);
                
                if (item.type === 'import') {
                    currentLot.quantity += itemQuantity;
                } else if (item.type === 'export') {
                    currentLot.quantity -= itemQuantity;
                } else if (item.type === 'reversal') {
                    currentLot.quantity += itemQuantity;
                }
            }

            // Final aggregation step
            const productStockMap = new Map();
            for (const lot of stockLedger.values()) {
                if (!productStockMap.has(lot.productId)) {
                    productStockMap.set(lot.productId, {
                        productId: lot.productId,
                        totalQuantity: 0,
                        lots: []
                    });
                }
                const product = productStockMap.get(lot.productId);
                product.totalQuantity += lot.quantity;
                product.lots.push(lot);
            }

            calculatedStock = Array.from(productStockMap.values());
        }

        // --- NEW: STOCK COUNT UI FUNCTIONS ---

        function populateStockCountMainView() {
            const T = translations[currentLanguage];
            const view = document.getElementById('stock-count-main-view');
            const isAdmin = currentUser.role === 'admin';
            const canCount = isAdmin || currentUser.canCountStock;

            let historyHtml = '';
            const sortedCounts = [...db.stockCounts].sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sortedCounts.length === 0) {
                historyHtml = `<tr><td colspan="5" class="text-center p-4">${T.stock_count_no_history}</td></tr>`;
            } else {
                historyHtml = sortedCounts.map(count => {
                    const formattedDate = new Date(count.date).toLocaleString(currentLanguage === 'th' ? 'th-TH' : 'en-GB', {
                        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Bangkok'
                    });
                    let statusBadge;
                    if (count.status === 'approved') {
                        statusBadge = `<span class="badge bg-success-subtle text-success-emphasis rounded-pill">${T.stock_count_status_approved}</span>`;
                    } else {
                        statusBadge = `<span class="badge bg-warning-subtle text-warning-emphasis rounded-pill">${T.stock_count_status_pending}</span>`;
                    }
                    return `
                        <tr class="view-stock-count-report-btn" data-count-id="${count.id}" style="cursor: pointer;">
                            <td>${count.id}</td>
                            <td>${formattedDate}</td>
                            <td>${count.user}</td>
                            <td>${statusBadge}</td>
                            <td><i class="bi bi-search"></i></td>
                        </tr>
                    `;
                }).join('');
            }

            view.innerHTML = `
                <div class="card">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-clipboard-data-fill me-2"></i>${T.stock_count_title}</span>
                        ${canCount ? `<button id="start-stock-count-btn" class="btn btn-primary"><i class="bi bi-plus-circle-fill me-2"></i>${T.stock_count_start_button}</button>` : ''}
                    </div>
                    <div class="card-body">
                        <h5 class="card-title mb-3">${T.stock_count_history_title}</h5>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>${T.stock_count_table_id}</th>
                                        <th>${T.stock_count_table_date}</th>
                                        <th>${T.stock_count_table_user}</th>
                                        <th>${T.stock_count_table_status}</th>
                                        <th>${T.actions}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${historyHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStockCountModalBody() {
            const T = translations[currentLanguage];
            const body = document.getElementById('stockCountModalBody');
            
            const productsWithStock = calculatedStock.filter(s => s.totalQuantity > 0);
            const productsWithoutStock = db.products.filter(p => !calculatedStock.some(s => String(s.productId).trim() === String(p.id).trim() && s.totalQuantity > 0));

            const allProductsToCount = [
                ...productsWithStock.map(s => {
                    const productInfo = db.products.find(p => String(p.id).trim() === String(s.productId).trim()) || { name: s.productId };
                    return { ...s, name: productInfo.name };
                }),
                ...productsWithoutStock.map(p => ({
                    productId: p.id,
                    name: p.name,
                    totalQuantity: 0
                }))
            ].sort((a,b) => String(a.productId).localeCompare(String(b.productId)));


            const productListHtml = allProductsToCount.map(p => {
                return `
                    <div class="row g-3 align-items-center mb-2 p-2 border rounded stock-count-row" data-product-id="${p.productId}" data-product-name="${p.name}" data-system-qty="${p.totalQuantity}">
                        <div class="col-md-5">
                            <label class="form-label mb-0">${p.productId} - ${p.name}</label>
                        </div>
                        <div class="col-md-3">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">${T.stock_count_system_qty}</span>
                                <input type="text" class="form-control" value="${p.totalQuantity.toLocaleString()}" readonly style="background-color: #e9ecef;">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">${T.stock_count_counted_qty}</span>
                                <input type="number" class="form-control counted-qty-input" min="0" placeholder="0">
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            body.innerHTML = `
                <div class="container-fluid">
                    <div id="stock-count-product-list">
                        ${productListHtml}
                    </div>
                </div>
            `;
        }

        function renderStockCountReportModalBody(count) {
            const T = translations[currentLanguage];
            const body = document.getElementById('stockCountReportModalBody');
            const footer = document.getElementById('stockCountReportModalFooter');
            const isAdmin = currentUser.role === 'admin';
            const canApprove = isAdmin && count.status === 'pending';

            const formattedDate = new Date(count.date).toLocaleString(currentLanguage === 'th' ? 'th-TH' : 'en-GB', { dateStyle: 'long', timeStyle: 'short' });
            document.getElementById('stockCountReportModalLabel').innerHTML = `<i class="bi bi-file-earmark-spreadsheet-fill me-2"></i>${T.stock_count_report_title} - ${count.id}`;

            const itemsHtml = count.items.map(item => {
                const variance = item.countedQty - item.systemQty;
                let varianceClass = '';
                let varianceText = variance;
                if (variance > 0) {
                    varianceClass = 'variance-positive';
                    varianceText = `+${variance}`;
                } else if (variance < 0) {
                    varianceClass = 'variance-negative';
                }
                const rowClass = variance !== 0 ? 'table-danger' : '';

                return `
                    <tr class="${rowClass}">
                        <td>${item.productId}</td>
                        <td>${item.productName}</td>
                        <td class="text-end">${item.systemQty.toLocaleString()}</td>
                        <td class="text-end fw-bold">${item.countedQty.toLocaleString()}</td>
                        <td class="text-end ${varianceClass}">${varianceText.toLocaleString()}</td>
                    </tr>
                `;
            }).join('');

            body.innerHTML = `
                <div class="container-fluid">
                    <div class="row mb-3">
                        <div class="col-md-4"><strong>${T.stock_count_table_id}:</strong> ${count.id}</div>
                        <div class="col-md-4"><strong>${T.stock_count_table_date}:</strong> ${formattedDate}</div>
                        <div class="col-md-4"><strong>${T.stock_count_table_user}:</strong> ${count.user}</div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>${T.product_id}</th>
                                    <th>${T.product_name}</th>
                                    <th class="text-end">${T.stock_count_system_qty}</th>
                                    <th class="text-end">${T.stock_count_counted_qty}</th>
                                    <th class="text-end">${T.stock_count_variance}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            footer.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${T.close_button}</button>
                ${canApprove ? `<button type="button" class="btn btn-success approve-stock-count-btn" data-count-id="${count.id}"><i class="bi bi-check-circle-fill me-2"></i>${T.stock_count_approve_button}</button>` : ''}
            `;
        }

        // --- NEW: DASHBOARD FUNCTIONS ---

               // --- DOM ELEMENTS (เพิ่มตัวแปรเหล่านี้เข้าไปในกลุ่มเดิม) ---
        const dashboardAutopartSalesQuantity = document.getElementById('dashboard-autopart-sales-quantity');
        const dashboardAutopartSalesValue = document.getElementById('dashboard-autopart-sales-value');
        const dashboardElectronicSalesQuantity = document.getElementById('dashboard-electronic-sales-quantity');
        const dashboardElectronicSalesValue = document.getElementById('dashboard-electronic-sales-value');


        function populateStockDashboard() {
            const T = translations[currentLanguage];
            let totalStockQuantity = 0;
            let totalStockValue = 0;
            const customerStockValue = new Map(); // Map to store stock value per customer

            calculatedStock.forEach(stockItem => {
                const productInfo = db.products.find(p => String(p.id).trim() === String(stockItem.productId).trim());
                const unitPrice = productInfo ? parseFloat(productInfo.unitPrice) || 0 : 0;
                const customer = productInfo ? productInfo.customer || 'ไม่ระบุลูกค้า' : 'ไม่ระบุลูกค้า';

                totalStockQuantity += stockItem.totalQuantity;
                const value = stockItem.totalQuantity * unitPrice;
                totalStockValue += value;

                // Aggregate stock value by customer
                customerStockValue.set(customer, (customerStockValue.get(customer) || 0) + value);
            });

            dashboardTotalStockQuantity.textContent = `${T.dashboard_qty_label}${totalStockQuantity.toLocaleString()}${T.dashboard_pieces_label}`;
            dashboardTotalStockValue.textContent = `฿ ${totalStockValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

function populateSalesDashboard(startDate, endDate) {
        const T = translations[currentLanguage];
        let totalSalesQuantity = 0;
        let totalSalesValue = 0;
        const customerSales = new Map();

        const autopartCustomers = ["FAURECIA", "Brose Thailand", "TSPT-SA","HANON","VANDAPAC","BOSCH","TGT","MOLTEN","SANKO","YENFENG","TSPT"]; 
        const electronicCustomers = ["APLA", "SHINSHIN", "SHINSUNG", "LG WM","MIDEA","LG AIR","WINIX"];
        
        const autopartCustomersLower = autopartCustomers.map(c => c.trim().toLowerCase());
        const electronicCustomersLower = electronicCustomers.map(c => c.trim().toLowerCase());

        let totalAutopartQuantity = 0;
        let totalAutopartValue = 0;
        let totalElectronicQuantity = 0;
        let totalElectronicValue = 0;

        const startFilterDate = new Date(startDate);
        startFilterDate.setHours(8, 0, 0, 0); 

        const endFilterDate = new Date(endDate);
        endFilterDate.setDate(endFilterDate.getDate() + 1);
        endFilterDate.setHours(8, 0, 0, 0);

        const filteredHistoryForSales = db.history.filter(item => {
            const itemDate = new Date(item.date);
            return itemDate >= startFilterDate && itemDate < endFilterDate;
        });

        filteredHistoryForSales.forEach(item => {
            let quantityAffectingSales = 0;

            // [แก้ไข] ตรรกะการระบุรายการที่เป็น "ยอดขาย"
            // 1. ต้องเป็นรายการส่งออก (export) และประเภทเป็น 'Sale' (หรือไม่มีการระบุประเภท สำหรับข้อมูลเก่า)
            const isSaleTransaction = item.type === 'export' && (!item.exportType || item.exportType === 'Sale');
            
            // 2. ต้องเป็นการยกเลิก (reversal) ของรายการขายเท่านั้น
            let isReversalOfSale = false;
            if (item.type === 'reversal') {
                const originalIdMatch = (item.remarks || '').match(/Reversal of transaction ID: (exp-[\w-]+)/);
                if (originalIdMatch) {
                    const originalId = originalIdMatch[1];
                    const originalTransaction = db.history.find(h => h.id === originalId);
                    // ตรวจสอบว่ารายการดั้งเดิมที่ถูกยกเลิก เป็นรายการขายหรือไม่
                    if (originalTransaction && (!originalTransaction.exportType || originalTransaction.exportType === 'Sale')) {
                        isReversalOfSale = true;
                    }
                }
            }

            if (isSaleTransaction) {
                quantityAffectingSales = parseFloat(item.quantity) || 0;
            } else if (isReversalOfSale) {
                // นำยอดออกจากยอดขาย (Reversal ของ export จะมี quantity เป็นบวก)
                quantityAffectingSales = - (parseFloat(item.quantity) || 0);
            }

            // ถ้า quantityAffectingSales ไม่ใช่ 0 (คือเป็นรายการที่เกี่ยวกับยอดขาย) ให้คำนวณต่อ
            if (quantityAffectingSales !== 0) {
                const productInfo = db.products.find(p => String(p.id).trim() === String(item.productId).trim());
                const unitPrice = productInfo ? parseFloat(productInfo.unitPrice) || 0 : 0;
                const customer = item.customer || T.dashboard_customer_unspecified;
                const customerLower = customer.trim().toLowerCase();
                const valueAffectingSales = quantityAffectingSales * unitPrice;

                totalSalesQuantity += quantityAffectingSales;
                totalSalesValue += valueAffectingSales;

                if (autopartCustomersLower.includes(customerLower)) {
                    totalAutopartQuantity += quantityAffectingSales;
                    totalAutopartValue += valueAffectingSales;
                } else if (electronicCustomersLower.includes(customerLower)) {
                    totalElectronicQuantity += quantityAffectingSales;
                    totalElectronicValue += valueAffectingSales;
                }

                if (!customerSales.has(customer)) {
                    customerSales.set(customer, { quantity: 0, value: 0 });
                }
                const currentSales = customerSales.get(customer);
                currentSales.quantity += quantityAffectingSales;
                currentSales.value += valueAffectingSales;
            }
        });
        
        // --- ส่วนที่เหลือของการอัปเดตหน้า Dashboard (เหมือนเดิม) ---
        dashboardTotalSalesQuantity.textContent = `${T.dashboard_qty_label}${totalSalesQuantity.toLocaleString()}${T.dashboard_pieces_label}`;
        dashboardTotalSalesValue.textContent = `฿ ${totalSalesValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        dashboardAutopartSalesQuantity.textContent = `${T.dashboard_qty_label}${totalAutopartQuantity.toLocaleString()}${T.dashboard_pieces_label}`;
        dashboardAutopartSalesValue.textContent = `฿ ${totalAutopartValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        dashboardElectronicSalesQuantity.textContent = `${T.dashboard_qty_label}${totalElectronicQuantity.toLocaleString()}${T.dashboard_pieces_label}`;
        dashboardElectronicSalesValue.textContent = `฿ ${totalElectronicValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        dashboardSalesTable.innerHTML = '';
        if (customerSales.size === 0) {
            dashboardSalesTable.innerHTML = `<tr><td colspan="5" class="text-center text-muted p-4">${T.dashboard_no_sales_data}</td></tr>`;
        } else {
            const sortedCustomerSales = Array.from(customerSales.entries()).sort((a, b) => b[1].value - a[1].value);
            
            let rank = 1;
            sortedCustomerSales.forEach(([customer, data]) => {
                if (data.quantity === 0 && data.value === 0) return; // ไม่แสดงลูกค้าที่ยอดเป็น 0

                const row = document.createElement('tr');
                
                let typeBadge = '';
                const customerLower = customer.trim().toLowerCase();
                if (autopartCustomersLower.includes(customerLower)) {
                    typeBadge = `<span class="badge bg-warning-subtle text-warning-emphasis rounded-pill">${T.dashboard_type_autopart}</span>`;
                } else if (electronicCustomersLower.includes(customerLower)) {
                    typeBadge = `<span class="badge bg-info-subtle text-info-emphasis rounded-pill">${T.dashboard_type_electronic}</span>`;
                } else {
                     typeBadge = `<span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">${T.dashboard_type_other}</span>`;
                }

                const percentage = totalSalesValue > 0 ? (data.value / totalSalesValue) * 100 : 0;

                row.innerHTML = `
                    <td class="fw-bold">${rank++}</td>
                    <td>${customer}</td>
                    <td>${typeBadge}</td>
                    <td class="text-end">${data.quantity.toLocaleString()}</td>
                    <td class="text-end">
                        <div class="d-flex justify-content-end align-items-center">
                            <span class="me-3">฿ ${data.value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                            <div class="progress" style="width: 50%; height: 10px;" title="${percentage.toFixed(2)}%">
                                <div class="progress-bar" role="progressbar" style="width: ${percentage}%;" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    </td>
                `;
                dashboardSalesTable.appendChild(row);
            });
        }
    }
        // --- START THE APP ---
        init();
    });
    </script>
</body>
</html>
